'use strict';const _0x10da1e=_0x788b;(function(_0x43acfc,_0x19dbfb){const _0x2c40d2=_0x788b,_0x42c4b6=_0x43acfc();while(!![]){try{const _0x1d2e5a=-parseInt(_0x2c40d2(0x180))/0x1+-parseInt(_0x2c40d2(0x18d))/0x2+parseInt(_0x2c40d2(0x17d))/0x3+-parseInt(_0x2c40d2(0x160))/0x4*(parseInt(_0x2c40d2(0x173))/0x5)+parseInt(_0x2c40d2(0x17a))/0x6+-parseInt(_0x2c40d2(0x15e))/0x7*(-parseInt(_0x2c40d2(0x187))/0x8)+parseInt(_0x2c40d2(0x18e))/0x9;if(_0x1d2e5a===_0x19dbfb)break;else _0x42c4b6['push'](_0x42c4b6['shift']());}catch(_0xc1b407){_0x42c4b6['push'](_0x42c4b6['shift']());}}}(_0xd4c9,0x327d7));function _0x788b(_0x12be02,_0x5f1c86){const _0xd4c908=_0xd4c9();return _0x788b=function(_0x788b20,_0x20db8b){_0x788b20=_0x788b20-0x152;let _0x3d96c7=_0xd4c908[_0x788b20];return _0x3d96c7;},_0x788b(_0x12be02,_0x5f1c86);}var __decorate=this&&this['__decorate']||function(_0x5724c1,_0x3d9c98,_0xf3c7c0,_0x266ed1){const _0xca2105=_0x788b;var _0x85302b=arguments[_0xca2105(0x165)],_0x1afc87=_0x85302b<0x3?_0x3d9c98:_0x266ed1===null?_0x266ed1=Object[_0xca2105(0x15c)](_0x3d9c98,_0xf3c7c0):_0x266ed1,_0x408b7f;if(typeof Reflect==='object'&&typeof Reflect[_0xca2105(0x181)]==='function')_0x1afc87=Reflect[_0xca2105(0x181)](_0x5724c1,_0x3d9c98,_0xf3c7c0,_0x266ed1);else{for(var _0x189d85=_0x5724c1['length']-0x1;_0x189d85>=0x0;_0x189d85--)if(_0x408b7f=_0x5724c1[_0x189d85])_0x1afc87=(_0x85302b<0x3?_0x408b7f(_0x1afc87):_0x85302b>0x3?_0x408b7f(_0x3d9c98,_0xf3c7c0,_0x1afc87):_0x408b7f(_0x3d9c98,_0xf3c7c0))||_0x1afc87;}return _0x85302b>0x3&&_0x1afc87&&Object[_0xca2105(0x16f)](_0x3d9c98,_0xf3c7c0,_0x1afc87),_0x1afc87;},__metadata=this&&this['__metadata']||function(_0x3f21a5,_0x3c3223){const _0x494523=_0x788b;if(typeof Reflect===_0x494523(0x159)&&typeof Reflect[_0x494523(0x19e)]==='function')return Reflect[_0x494523(0x19e)](_0x3f21a5,_0x3c3223);},LocationService_1;Object[_0x10da1e(0x16f)](exports,'__esModule',{'value':!![]}),exports['LocationService']=void 0x0;function _0xd4c9(){const _0x1efb3d=['\x27\x20AND\x20','sort','list','reduce','../../shared/utils/cal.utils','../../shared/constants/table.constant','\x20WHERE\x20','isEmpty','metadata','clearDailyData','name','\x27\x20AND\x20prov\x20=\x20\x27','../entity/sts.loaction.entity','onAppInit','Logger','andWhere','count','map','StsLocationEntity','into','LocationService','country\x20=\x20\x27','object','clickhouse','create_time\x20>=\x20\x27','getOwnPropertyDescriptor','type','1093162mhFDYA','createQueryBuilder','59068fBDxVG','../dto/location.list.rsp.dto','uvFormat','../../shared/utils/obj.utils','\x27)\x20COMMENT\x20\x27上报时间\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ip\x20String\x20COMMENT\x20\x27ip\x20地址\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20country\x20String\x20COMMENT\x20\x27国家\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20prov\x20String\x20COMMENT\x20\x27省份\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20city\x20String\x20COMMENT\x20\x27城市\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20INDEX\x20country_index\x20country\x20TYPE\x20minmax\x20GRANULARITY\x208192,\x0a\x20\x20\x20\x20\x20\x20\x20\x20INDEX\x20prov_index\x20prov\x20TYPE\x20minmax\x20GRANULARITY\x208192,\x0a\x20\x20\x20\x20\x20\x20\x20\x20INDEX\x20city_index\x20city\x20TYPE\x20minmax\x20GRANULARITY\x208192\x0a\x20\x20\x20\x20\x20\x20)\x20ENGINE\x20=\x20MergeTree()\x0a\x20\x20\x20\x20\x20\x20partition\x20by\x20toYYYYMM(create_time)\x0a\x20\x20\x20\x20\x20\x20primary\x20key\x20(sid)\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x20(sid,\x20create_time)\x0a\x20\x20\x20\x20','length','EntityManager','buildStsLocationEntityList','\x20GROUP\x20BY\x20','prov','\x0a\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20','entityManager','values','LocationListItemRspDto','appTimeZone','defineProperty','appId\x20=\x20:appId','push','\x27\x20AND\x20create_time\x20<=\x20\x27','115AGTQQp','../../shared/dto/sts.task.dto','appId','country','city','design:paramtypes','insert','1752618CGBvcH','startTimeString','responseSuccess','882648aQpdgN','startDailyStatistics','calPercentFormat','305314rAEuUA','decorate','logger','getRepository','startTime\x20>=\x20:startTime','\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20sid\x20String\x20COMMENT\x20\x27会话id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20String\x20COMMENT\x20\x27用户id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20device_id\x20String\x20COMMENT\x20\x27设备id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20device_no\x20UInt32\x20COMMENT\x20\x27设备编号\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20is_new_user\x20tinyint(1)\x20COMMENT\x20\x27新用户标识\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20timestamp\x20DateTime(\x27','StsTaskDto','8Uanrvc','period','newUv','../../shared/service/clickhouse/clickhouse.service','LOCATION_TABLE','concat','565872KSgjEt','3529917NoNVmb','typeorm','where','query','execute','totalPv','ClickhouseService','type\x20=\x20:type'];_0xd4c9=function(){return _0x1efb3d;};return _0xd4c9();}const table_constant_1=require(_0x10da1e(0x19b)),sts_task_dto_1=require(_0x10da1e(0x174)),base_service_1=require('../../shared/service/base.service'),clickhouse_service_1=require(_0x10da1e(0x18a)),time_utils_1=require('../../shared/utils/time.utils'),common_1=require('@nestjs/common'),typeorm_1=require(_0x10da1e(0x18f)),sts_loaction_entity_1=require(_0x10da1e(0x1a2)),obj_utils_1=require(_0x10da1e(0x163)),location_list_rsp_dto_1=require(_0x10da1e(0x161)),cal_utils_1=require(_0x10da1e(0x19a));let LocationService=LocationService_1=class LocationService extends base_service_1['BaseService']{constructor(_0x3f721b,_0x446647){const _0x47accd=_0x10da1e;super(),this[_0x47accd(0x15a)]=_0x3f721b,this[_0x47accd(0x16b)]=_0x446647,this[_0x47accd(0x182)]=new common_1[(_0x47accd(0x1a4))](LocationService_1[_0x47accd(0x1a0)]);}async[_0x10da1e(0x198)](_0x4e87c4){const _0x528dd7=_0x10da1e,{startTime:_0x30a666,endTime:_0x3d49a3}=(0x0,time_utils_1['getStartAndEndTime'])(_0x4e87c4[_0x528dd7(0x188)]),_0x3306a8=new sts_task_dto_1[(_0x528dd7(0x186))]();_0x3306a8[_0x528dd7(0x17b)]=_0x30a666,_0x3306a8['endTimeString']=_0x3d49a3;const _0x1ff6cd=await this[_0x528dd7(0x167)](_0x4e87c4[_0x528dd7(0x175)],_0x3306a8,_0x4e87c4[_0x528dd7(0x176)],_0x4e87c4[_0x528dd7(0x169)]);if((0x0,obj_utils_1[_0x528dd7(0x19d)])(_0x1ff6cd))return this['responseSuccess']({});const _0x1815a5={'totalUv':_0x1ff6cd[_0x528dd7(0x199)]((_0x3b24b3,_0x3642aa)=>_0x3b24b3+_0x3642aa['uv'],0x0),'totalPv':_0x1ff6cd['reduce']((_0x2038e8,_0x5a21dc)=>_0x2038e8+_0x5a21dc['pv'],0x0)},_0x308280=[];for(const _0xcd1349 of _0x1ff6cd){const _0x5d631d=new location_list_rsp_dto_1[(_0x528dd7(0x16d))]();if(_0x4e87c4[_0x528dd7(0x169)])_0x5d631d['id']=(0x0,obj_utils_1[_0x528dd7(0x19d)])(_0xcd1349[_0x528dd7(0x177)])?'未知':_0xcd1349[_0x528dd7(0x177)];else _0x4e87c4[_0x528dd7(0x176)]?_0x5d631d['id']=(0x0,obj_utils_1['isEmpty'])(_0xcd1349[_0x528dd7(0x169)])?'未知':_0xcd1349[_0x528dd7(0x169)]:_0x5d631d['id']=(0x0,obj_utils_1[_0x528dd7(0x19d)])(_0xcd1349['country'])?'未知':_0xcd1349[_0x528dd7(0x176)];_0x5d631d['pv']=_0xcd1349['pv'],_0x5d631d['uv']=_0xcd1349['uv'],_0x5d631d['pvFormat']=_0xcd1349['pv']+'('+(0x0,cal_utils_1['calPercentFormat'])(_0xcd1349['pv'],_0x1815a5[_0x528dd7(0x193)])+')',_0x5d631d[_0x528dd7(0x162)]=_0xcd1349['uv']+'('+(0x0,cal_utils_1[_0x528dd7(0x17f)])(_0xcd1349['uv'],_0x1815a5['totalUv'])+')',_0x308280[_0x528dd7(0x171)](_0x5d631d);}const _0x4c2878=_0x308280[_0x528dd7(0x197)]((_0x13b242,_0x3314d3)=>_0x3314d3['pv']-_0x13b242['pv']),_0x43352a=new location_list_rsp_dto_1['LocationListRspDto']();return _0x43352a[_0x528dd7(0x198)]=_0x4c2878,_0x43352a[_0x528dd7(0x153)]=_0x4c2878[_0x528dd7(0x165)],this[_0x528dd7(0x17c)](_0x43352a);}async[_0x10da1e(0x17e)](_0x609a2f,_0x48fd92,_0x1e6e46){const _0xd6127=_0x10da1e;for(const _0x3f133c of _0x1e6e46){let _0x238cd8=[];const _0x33c435=await this[_0xd6127(0x167)](_0x609a2f,_0x3f133c);if(!(0x0,obj_utils_1[_0xd6127(0x19d)])(_0x33c435)){_0x238cd8=_0x238cd8[_0xd6127(0x18c)](_0x33c435);for(const _0x219bd1 of _0x33c435){const _0x1c54b1=await this[_0xd6127(0x167)](_0x609a2f,_0x3f133c,_0x219bd1['country']);if(!(0x0,obj_utils_1[_0xd6127(0x19d)])(_0x1c54b1)){_0x238cd8=_0x238cd8[_0xd6127(0x18c)](_0x1c54b1);for(const _0x2250a2 of _0x1c54b1){const _0x376f26=await this[_0xd6127(0x167)](_0x609a2f,_0x3f133c,_0x2250a2['country'],_0x2250a2[_0xd6127(0x169)]);_0x238cd8=_0x238cd8[_0xd6127(0x18c)](_0x376f26);}}}}_0x238cd8[_0xd6127(0x165)]>0x0&&await this[_0xd6127(0x16b)][_0xd6127(0x15f)]()[_0xd6127(0x179)]()[_0xd6127(0x156)](sts_loaction_entity_1[_0xd6127(0x155)])[_0xd6127(0x16c)](_0x238cd8)[_0xd6127(0x192)]();}}async[_0x10da1e(0x167)](_0x301b08,_0x2b5277,_0x57ab4d,_0x2c3959){const _0x14558f=_0x10da1e,_0x51455d=table_constant_1['LOCATION_TABLE']+'_'+_0x301b08;let _0x476e39=_0x14558f(0x15b)+_0x2b5277[_0x14558f(0x17b)]+_0x14558f(0x172)+_0x2b5277['endTimeString']+'\x27',_0x44d251='country';if(_0x2c3959)_0x44d251=_0x14558f(0x177),_0x476e39=_0x14558f(0x158)+_0x57ab4d+_0x14558f(0x1a1)+_0x2c3959+_0x14558f(0x196)+_0x476e39;else _0x57ab4d&&(_0x44d251=_0x14558f(0x169),_0x476e39=_0x14558f(0x158)+_0x57ab4d+_0x14558f(0x196)+_0x476e39);let _0x4110e7='\x0a\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20'+_0x44d251+'\x20AS\x20m,\x20\x0a\x20\x20\x20\x20\x20\x20uniqExact(device_no)\x20AS\x20uv,\x20\x0a\x20\x20\x20\x20\x20\x20count(1)\x20AS\x20pv,\x20\x0a\x20\x20\x20\x20\x20\x20uniqExact(CASE\x20WHEN\x20is_new_user\x20=\x201\x20THEN\x20device_no\x20ELSE\x20NULL\x20END)\x20AS\x20newUv\x0a\x20\x20\x20\x20FROM\x20'+_0x51455d+_0x14558f(0x19c)+_0x476e39+_0x14558f(0x168)+_0x44d251;const _0x4c2a70=await this[_0x14558f(0x15a)][_0x14558f(0x191)](_0x4110e7);if((0x0,obj_utils_1[_0x14558f(0x19d)])(_0x4c2a70))return[];const _0x23b65c=_0x4c2a70['filter'](_0x178d07=>!(0x0,obj_utils_1[_0x14558f(0x19d)])(_0x178d07['m'])),_0x414036=_0x23b65c[_0x14558f(0x154)](_0x2b5ab0=>{const _0x1a7029=_0x14558f,_0x5978b1=new sts_loaction_entity_1[(_0x1a7029(0x155))](_0x2b5277);_0x5978b1['appId']=_0x301b08,_0x5978b1['uv']=Number(_0x2b5ab0['uv']),_0x5978b1['pv']=Number(_0x2b5ab0['pv']),_0x5978b1[_0x1a7029(0x189)]=Number(_0x2b5ab0['newUv']);let _0x2048b9=_0x2b5ab0['m'],_0x26292c='',_0x1564f1='';if(_0x2c3959)_0x2048b9=_0x57ab4d,_0x26292c=_0x2c3959,_0x1564f1=_0x2b5ab0['m'];else _0x57ab4d&&(_0x2048b9=_0x57ab4d,_0x26292c=_0x2b5ab0['m']);return _0x5978b1[_0x1a7029(0x176)]=_0x2048b9,_0x5978b1[_0x1a7029(0x169)]=_0x26292c,_0x5978b1[_0x1a7029(0x177)]=_0x1564f1,_0x5978b1;});return _0x414036;}async[_0x10da1e(0x19f)](_0x4e704e,_0x39805a,_0x312330){const _0x260aa8=_0x10da1e;for(const _0xb686af of _0x312330){await this[_0x260aa8(0x16b)][_0x260aa8(0x183)](sts_loaction_entity_1['StsLocationEntity'])[_0x260aa8(0x15f)]('location')['delete']()[_0x260aa8(0x190)](_0x260aa8(0x170),{'appId':_0x4e704e})[_0x260aa8(0x152)](_0x260aa8(0x195),{'type':_0xb686af[_0x260aa8(0x15d)]})[_0x260aa8(0x152)](_0x260aa8(0x184),{'startTime':_0xb686af['startTimeString']})[_0x260aa8(0x192)]();}}async[_0x10da1e(0x1a3)](_0x31212f){const _0x212e77=_0x10da1e;return await this[_0x212e77(0x15a)]['command'](_0x212e77(0x16a)+table_constant_1[_0x212e77(0x18b)]+'_'+_0x31212f+_0x212e77(0x185)+(0x0,time_utils_1[_0x212e77(0x16e)])()+'\x27)\x20COMMENT\x20\x27事件记录时间\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20create_time\x20DateTime(\x27'+(0x0,time_utils_1[_0x212e77(0x16e)])()+_0x212e77(0x164));}};LocationService=LocationService_1=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x10da1e(0x178),[clickhouse_service_1[_0x10da1e(0x194)],typeorm_1[_0x10da1e(0x166)]])],LocationService),exports[_0x10da1e(0x157)]=LocationService;