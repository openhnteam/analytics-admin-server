'use strict';const _0x3e27b0=_0x5e85;(function(_0x4acec2,_0x1a67cf){const _0x444038=_0x5e85,_0x551b14=_0x4acec2();while(!![]){try{const _0x37e6a6=parseInt(_0x444038(0xa6))/0x1*(-parseInt(_0x444038(0x9d))/0x2)+parseInt(_0x444038(0xf8))/0x3*(parseInt(_0x444038(0xb8))/0x4)+-parseInt(_0x444038(0xf6))/0x5+-parseInt(_0x444038(0xf0))/0x6+parseInt(_0x444038(0x99))/0x7*(-parseInt(_0x444038(0x82))/0x8)+parseInt(_0x444038(0x9f))/0x9*(-parseInt(_0x444038(0xc7))/0xa)+parseInt(_0x444038(0x9a))/0xb;if(_0x37e6a6===_0x1a67cf)break;else _0x551b14['push'](_0x551b14['shift']());}catch(_0xc70031){_0x551b14['push'](_0x551b14['shift']());}}}(_0x2ec7,0xec7d4));function _0x2ec7(){const _0x1be42b=['pageService','../../bounce-module/service/bounce.service','diff','getLock','dayjs','name','__metadata','add','date','isLastDayOfQuarter','all','object','metadata','MetricsService','MONTH','EVERY_HOUR','metricsService','prototype','2702994JDOoWL','save','curTs','stack','任务成功总览：','PageService','1305460SIpGiG','log','11679jCkNOQ','DAY','eventService','\x20任务,\x20需要跑\x20','buildStsTask','redis','8FASZFg','../../shared/constants/table.constant','format','任务总耗时\x20','getOwnPropertyDescriptor','length','timeFormatToDisplay','subtract','QUARTER','WEEK','stringify','\x20任务失败，错误信息：','startDailyStatisticsWithTryCatch','design:paramtypes','../../shared/service/base.service','applicationService','__decorate','command','hour','defineProperty','entityManager','JobEntity','findOne','9032261VNEDRz','28834157rVgxPn','统计\x20','daily','4dhCiaU','../../event-module/service/event.service','787212YwZNrM','Logger','EventService','fetchJobAppListfromDb','isEmpty','@nestjs/common','\x20任务成功，耗时：','225549iTqaAF','DATE_FORMAT','__importDefault','design:type','createTime','../../shared/constants/date.constant','ClickhouseService','../entity/job.entity','constructor','clearDailyData','../../shared/utils/time.utils','DateUnit','LocationService','clickhouse','keys','locationService','appTimeZone','default','1092BxYpsm','OPTIMIZE\x20TABLE\x20','Cron','isLastDayOfMonth','decorate','../../shared/service/clickhouse/clickhouse.service','bounceService','function','__esModule','CustomRedisService','../../location-module/service/location.service','userService','sessionService','CronExpression','map','30XlcgeP','getScheduledTasksForStatistics','\x20FINAL','../../shared/service/redis/redis.service','startOf','start','day','error','mergeCkSession','开始统计\x20','startDailyStatistics','任务错误总览：','appId','\x20任务异常,\x20error:\x20','schedulerList','clone','del','push','desc','\x20PARTITION\x20','typeorm','JobService','logger'];_0x2ec7=function(){return _0x1be42b;};return _0x2ec7();}var __decorate=this&&this[_0x3e27b0(0x92)]||function(_0x1bef9a,_0x19bfe6,_0x58925d,_0x4d0263){const _0x3e4bb9=_0x3e27b0;var _0x4d5dc8=arguments[_0x3e4bb9(0x87)],_0x33369d=_0x4d5dc8<0x3?_0x19bfe6:_0x4d0263===null?_0x4d0263=Object[_0x3e4bb9(0x86)](_0x19bfe6,_0x58925d):_0x4d0263,_0x20baaf;if(typeof Reflect===_0x3e4bb9(0xe9)&&typeof Reflect[_0x3e4bb9(0xbc)]===_0x3e4bb9(0xbf))_0x33369d=Reflect['decorate'](_0x1bef9a,_0x19bfe6,_0x58925d,_0x4d0263);else{for(var _0x528070=_0x1bef9a[_0x3e4bb9(0x87)]-0x1;_0x528070>=0x0;_0x528070--)if(_0x20baaf=_0x1bef9a[_0x528070])_0x33369d=(_0x4d5dc8<0x3?_0x20baaf(_0x33369d):_0x4d5dc8>0x3?_0x20baaf(_0x19bfe6,_0x58925d,_0x33369d):_0x20baaf(_0x19bfe6,_0x58925d))||_0x33369d;}return _0x4d5dc8>0x3&&_0x33369d&&Object[_0x3e4bb9(0x95)](_0x19bfe6,_0x58925d,_0x33369d),_0x33369d;},__metadata=this&&this[_0x3e27b0(0xe4)]||function(_0x469eb6,_0x259a54){const _0x120b8b=_0x3e27b0;if(typeof Reflect==='object'&&typeof Reflect[_0x120b8b(0xea)]===_0x120b8b(0xbf))return Reflect[_0x120b8b(0xea)](_0x469eb6,_0x259a54);},__importDefault=this&&this[_0x3e27b0(0xa8)]||function(_0x50b5f3){return _0x50b5f3&&_0x50b5f3['__esModule']?_0x50b5f3:{'default':_0x50b5f3};},JobService_1;Object['defineProperty'](exports,_0x3e27b0(0xc0),{'value':!![]}),exports[_0x3e27b0(0xdc)]=void 0x0;function _0x5e85(_0x571b34,_0x4d5a74){const _0x2ec7be=_0x2ec7();return _0x5e85=function(_0x5e8525,_0x4671a7){_0x5e8525=_0x5e8525-0x7d;let _0x20643f=_0x2ec7be[_0x5e8525];return _0x20643f;},_0x5e85(_0x571b34,_0x4d5a74);}const application_service_1=require('../../app-module/service/application.service'),bounce_service_1=require(_0x3e27b0(0xdf)),event_service_1=require(_0x3e27b0(0x9e)),location_service_1=require(_0x3e27b0(0xc2)),metrics_service_1=require('../../metrics-module/service/metrics.service'),page_service_1=require('../../page-module/service/page.service'),session_service_1=require('../../session-module/service/session.service'),base_service_1=require(_0x3e27b0(0x90)),redis_service_1=require(_0x3e27b0(0xca)),time_utils_1=require(_0x3e27b0(0xb0)),user_service_1=require('../../user-module/service/user.service'),common_1=require(_0x3e27b0(0xa4)),schedule_1=require('@nestjs/schedule'),typeorm_1=require(_0x3e27b0(0xdb)),job_entity_1=require(_0x3e27b0(0xad)),dayjs_1=__importDefault(require(_0x3e27b0(0xe2))),obj_utils_1=require('../../shared/utils/obj.utils'),date_constant_1=require(_0x3e27b0(0xab)),clickhouse_service_1=require(_0x3e27b0(0xbd)),table_constant_1=require(_0x3e27b0(0x83));let JobService=JobService_1=class JobService extends base_service_1['BaseService']{constructor(_0x22071e,_0x46d21e,_0x38fb74,_0xb1709e,_0x573b25,_0x34f4ed,_0x387416,_0x5004a9,_0x1c3881,_0x1c06a3,_0x4744b4){const _0x4efd27=_0x3e27b0;super(),this[_0x4efd27(0x96)]=_0x22071e,this[_0x4efd27(0xb3)]=_0x46d21e,this[_0x4efd27(0x81)]=_0x38fb74,this[_0x4efd27(0x91)]=_0xb1709e,this[_0x4efd27(0xc4)]=_0x573b25,this[_0x4efd27(0xc3)]=_0x34f4ed,this[_0x4efd27(0xee)]=_0x387416,this[_0x4efd27(0x7e)]=_0x5004a9,this['pageService']=_0x1c3881,this['bounceService']=_0x1c06a3,this['locationService']=_0x4744b4,this[_0x4efd27(0xdd)]=new common_1[(_0x4efd27(0xa0))](JobService_1[_0x4efd27(0xe3)]),this['schedulerList']=[],this[_0x4efd27(0xd5)]=[this[_0x4efd27(0xc4)],this[_0x4efd27(0xc3)],this[_0x4efd27(0xee)],this[_0x4efd27(0x7e)],this[_0x4efd27(0xde)],this[_0x4efd27(0xbe)],this[_0x4efd27(0xb5)]];}async[_0x3e27b0(0xcc)](){await this['daily']();}async['mergeCkSession'](){const _0x352532=_0x3e27b0,_0x2071a9='SESSION_MERGE_CK_KEY';if(!await this[_0x352532(0x81)]['getLock'](_0x2071a9))return;const _0x5d1881=(0x0,dayjs_1['default'])(),_0x36438d=_0x5d1881['format'](date_constant_1['DATE_NO_SEPARATOR_FORMAT']),_0x36032a=_0x5d1881[_0x352532(0x89)](0x1,_0x352532(0xcd))[_0x352532(0x84)](date_constant_1['DATE_NO_SEPARATOR_FORMAT']),_0x4c2d3c=await this['applicationService'][_0x352532(0xa2)]();if(_0x4c2d3c['length']==0x0)return;for(const _0x19bad4 of _0x4c2d3c){try{const _0x353257=table_constant_1['SESSION_TABLE']+'_'+_0x19bad4[_0x352532(0xd3)];if(_0x5d1881[_0x352532(0x94)]()>0x1){const _0x49a0b8=_0x352532(0xb9)+_0x353257+_0x352532(0xda)+_0x36438d+_0x352532(0xc9);await this[_0x352532(0xb3)][_0x352532(0x93)](_0x49a0b8);}if(_0x5d1881['hour']()<=0xc){const _0x279bd4='OPTIMIZE\x20TABLE\x20'+_0x353257+'\x20PARTITION\x20'+_0x36032a+_0x352532(0xc9);await this[_0x352532(0xb3)][_0x352532(0x93)](_0x279bd4);}}catch(_0x2316ee){this[_0x352532(0xdd)][_0x352532(0xce)](_0x2316ee);}}await this[_0x352532(0x81)][_0x352532(0xd7)](_0x2071a9);}async['daily'](){const _0x4045f9=_0x3e27b0,{redis:_0x2b9e18,logger:_0x2c5ed4}=this,_0x5a6276='DAILY_JOB_KEY',_0x5f1d5f=(0x0,time_utils_1['curTs'])();if(!await _0x2b9e18[_0x4045f9(0xe1)](_0x5a6276))return;const _0x349a15=await this['applicationService'][_0x4045f9(0xa2)]();if(_0x349a15[_0x4045f9(0x87)]==0x0)return;const _0x50aa35=new Map(),_0x4988ce=[];for(const _0x126d0a of _0x349a15){const _0x455cdf=_0x126d0a[_0x4045f9(0xd3)],_0x30f617=(0x0,dayjs_1[_0x4045f9(0xb7)])();let _0xdf38f5=await this['latestTime'](_0x126d0a);_0x2c5ed4[_0x4045f9(0xf7)](_0x4045f9(0xd0)+_0x126d0a[_0x4045f9(0xe3)]+_0x4045f9(0x7f)+(_0x30f617['diff'](_0xdf38f5,'days')-0x1)+'\x20天');while(_0x30f617[_0x4045f9(0xe0)](_0xdf38f5,'days')>0x1){if(_0x50aa35[''+_0x455cdf])_0xdf38f5=_0xdf38f5[_0x4045f9(0xe5)](0x3e8,'day');else{_0xdf38f5=_0xdf38f5[_0x4045f9(0xe5)](0x1,_0x4045f9(0xcd));try{await this[_0x4045f9(0xaf)](_0x126d0a,_0xdf38f5[_0x4045f9(0xd6)]());const _0x3d5dcc=await this[_0x4045f9(0xd1)](_0x126d0a,_0xdf38f5[_0x4045f9(0xd6)]());_0x4988ce[_0x4045f9(0xd8)](_0x3d5dcc);}catch(_0x22984c){const _0x3d54b5='统计\x20'+_0x126d0a['name']+'\x20'+_0xdf38f5[_0x4045f9(0x84)](date_constant_1['DATE_FORMAT'])+_0x4045f9(0x8d)+_0x22984c[_0x4045f9(0xf3)];_0x2c5ed4[_0x4045f9(0xce)](_0x3d54b5),_0x50aa35[''+_0x455cdf]=_0x3d54b5;}}}}const _0x423425=(0x0,time_utils_1[_0x4045f9(0xf2)])();_0x2c5ed4['log'](_0x4045f9(0x85)+(0x0,time_utils_1[_0x4045f9(0x88)])(_0x423425-_0x5f1d5f)),Object[_0x4045f9(0xb4)](_0x50aa35)['length']>0x0&&_0x2c5ed4['error'](_0x4045f9(0xd2)+JSON['stringify'](_0x50aa35)),!(0x0,obj_utils_1[_0x4045f9(0xa3)])(_0x4988ce)&&_0x2c5ed4[_0x4045f9(0xf7)](_0x4045f9(0xf4)+JSON[_0x4045f9(0x8c)](_0x4988ce)),await _0x2b9e18[_0x4045f9(0xd7)](_0x5a6276);}async[_0x3e27b0(0xaf)](_0x1ae795,_0x2c0c5e){const _0x914db=_0x3e27b0,_0x2d57e6=this[_0x914db(0xc8)](_0x2c0c5e),_0x89184d=this[_0x914db(0xd5)]['map'](_0xfe6039=>_0xfe6039[_0x914db(0xaf)](_0x1ae795[_0x914db(0xd3)],_0x2c0c5e,_0x2d57e6));await Promise[_0x914db(0xe8)](_0x89184d);}async[_0x3e27b0(0xd1)](_0xa8faf1,_0x479385){const _0x431cca=_0x3e27b0,_0x253951=this[_0x431cca(0xc8)](_0x479385),_0x37dedc=(0x0,time_utils_1['curTs'])(),_0x3313d3=this[_0x431cca(0xd5)][_0x431cca(0xc6)](_0x4966da=>this[_0x431cca(0x8e)](_0x4966da,_0xa8faf1[_0x431cca(0xd3)],_0x479385,_0x253951));await Promise[_0x431cca(0xe8)](_0x3313d3);const _0x2a185a=(0x0,time_utils_1[_0x431cca(0xf2)])(),_0x1f85af=_0x479385[_0x431cca(0x84)](date_constant_1[_0x431cca(0xa7)]),_0x1f9059=new job_entity_1[(_0x431cca(0x97))]();_0x1f9059['appId']=_0xa8faf1[_0x431cca(0xd3)],_0x1f9059[_0x431cca(0xe6)]=_0x479385['toDate'](),await _0x1f9059[_0x431cca(0xf1)]();const _0x520541=_0x431cca(0x9b)+_0xa8faf1[_0x431cca(0xe3)]+'\x20'+_0x1f85af+_0x431cca(0xa5)+(0x0,time_utils_1['timeFormatToDisplay'])(_0x2a185a-_0x37dedc);return _0x520541;}async[_0x3e27b0(0x8e)](_0x1a1f82,_0x236155,_0x5453b0,_0x56fc3a){const _0x254fe4=_0x3e27b0;try{return await _0x1a1f82[_0x254fe4(0xd1)](_0x236155,_0x5453b0,_0x56fc3a);}catch(_0x1efc98){this[_0x254fe4(0xdd)][_0x254fe4(0xce)](_0x1a1f82[_0x254fe4(0xae)]['name']+_0x254fe4(0xd4)+_0x1efc98);throw _0x1efc98;}}[_0x3e27b0(0xc8)](_0x4f2bfe){const _0x1f7de3=_0x3e27b0,_0x19b782=[],_0x299644=(0x0,time_utils_1[_0x1f7de3(0x80)])(_0x4f2bfe,date_constant_1[_0x1f7de3(0xb1)][_0x1f7de3(0x7d)]);_0x19b782[_0x1f7de3(0xd8)](_0x299644);if((0x0,time_utils_1['isLastDayOfIsoWeekday'])(_0x4f2bfe)){const _0x252402=(0x0,time_utils_1[_0x1f7de3(0x80)])(_0x4f2bfe,date_constant_1[_0x1f7de3(0xb1)][_0x1f7de3(0x8b)]);_0x19b782[_0x1f7de3(0xd8)](_0x252402);}if((0x0,time_utils_1[_0x1f7de3(0xbb)])(_0x4f2bfe)){const _0x304286=(0x0,time_utils_1[_0x1f7de3(0x80)])(_0x4f2bfe,date_constant_1['DateUnit'][_0x1f7de3(0xec)]);_0x19b782[_0x1f7de3(0xd8)](_0x304286);}if((0x0,time_utils_1[_0x1f7de3(0xe7)])(_0x4f2bfe)){const _0x311487=(0x0,time_utils_1[_0x1f7de3(0x80)])(_0x4f2bfe,date_constant_1['DateUnit'][_0x1f7de3(0x8a)]);_0x19b782[_0x1f7de3(0xd8)](_0x311487);}return _0x19b782;}async['latestTime'](_0x2e9752){const _0x547fcb=_0x3e27b0,_0x5f4b92=await this[_0x547fcb(0x96)][_0x547fcb(0x98)](job_entity_1[_0x547fcb(0x97)],{'select':[_0x547fcb(0xe6)],'where':{'appId':_0x2e9752[_0x547fcb(0xd3)],'del':0x0},'order':{'date':_0x547fcb(0xd9)}});if((0x0,obj_utils_1['isEmpty'])(_0x5f4b92)){const _0x1c1f59=(0x0,dayjs_1[_0x547fcb(0xb7)])(_0x2e9752[_0x547fcb(0xaa)])[_0x547fcb(0x89)](0x1,'day')[_0x547fcb(0xcb)](_0x547fcb(0xcd));return _0x1c1f59;}return(0x0,dayjs_1[_0x547fcb(0xb7)])(_0x5f4b92['date']);}};__decorate([(0x0,schedule_1[_0x3e27b0(0xba)])(schedule_1[_0x3e27b0(0xc5)][_0x3e27b0(0xed)]),__metadata(_0x3e27b0(0xa9),Function),__metadata(_0x3e27b0(0x8f),[]),__metadata('design:returntype',Promise)],JobService['prototype'],_0x3e27b0(0xcf),null),__decorate([(0x0,schedule_1[_0x3e27b0(0xba)])(schedule_1[_0x3e27b0(0xc5)]['EVERY_DAY_AT_4AM'],{'timeZone':(0x0,time_utils_1[_0x3e27b0(0xb6)])()}),__metadata(_0x3e27b0(0xa9),Function),__metadata(_0x3e27b0(0x8f),[]),__metadata('design:returntype',Promise)],JobService[_0x3e27b0(0xef)],_0x3e27b0(0x9c),null),JobService=JobService_1=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x3e27b0(0x8f),[typeorm_1['EntityManager'],clickhouse_service_1[_0x3e27b0(0xac)],redis_service_1[_0x3e27b0(0xc1)],application_service_1['ApplicationService'],session_service_1['SessionService'],user_service_1['UserService'],metrics_service_1[_0x3e27b0(0xeb)],event_service_1[_0x3e27b0(0xa1)],page_service_1[_0x3e27b0(0xf5)],bounce_service_1['BounceService'],location_service_1[_0x3e27b0(0xb2)]])],JobService),exports[_0x3e27b0(0xdc)]=JobService;