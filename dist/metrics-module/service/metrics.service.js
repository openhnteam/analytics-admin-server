'use strict';const _0x3bed4b=_0x1be0;(function(_0x1c49b4,_0x5962b5){const _0x12a7f1=_0x1be0,_0x2e50fc=_0x1c49b4();while(!![]){try{const _0x5dba2d=-parseInt(_0x12a7f1(0x1e4))/0x1*(parseInt(_0x12a7f1(0x17a))/0x2)+-parseInt(_0x12a7f1(0x1a0))/0x3+-parseInt(_0x12a7f1(0x155))/0x4+parseInt(_0x12a7f1(0x161))/0x5+parseInt(_0x12a7f1(0x1a1))/0x6+parseInt(_0x12a7f1(0x18d))/0x7+parseInt(_0x12a7f1(0x1a7))/0x8*(-parseInt(_0x12a7f1(0x176))/0x9);if(_0x5dba2d===_0x5962b5)break;else _0x2e50fc['push'](_0x2e50fc['shift']());}catch(_0x5a010b){_0x2e50fc['push'](_0x2e50fc['shift']());}}}(_0x4852,0xc9b2c));function _0x4852(){const _0x1e08af=['../dto/metrics.group.rsp.dto','../entity/device.mapping.entity','../../app-module/service/application.service','platform_versions','delete','total','../constant/device.list.mapping','clickhouse','design:paramtypes','list','createQueryBuilder','object','9987327VROpUo','SELECT\x20uniqExact(','name','reduce','\x27\x20GROUP\x20BY\x20','os_version','period','../../shared/constants/date.constant','__metadata','mapOsVersion','USER_TABLE','未知\x20','DEVICE_LIST','SESSION_TABLE','carrierNameWithCode','iOS\x20','DATE_FORMAT','function','values','2751813dTaddR','6150612nwtDFk','../../shared/constants/table.constant','resolution','startTimeString','\x20WHERE\x20','@nestjs/common','22856oRFUxb','responseFailed','defineProperty','appId','carriers','\x20WHERE\x20start_time\x20>=\x20\x27','isEmpty','startTime','isMiniType','devices','scene','split','mapDeviceOrVendor','install_channel','MINI_DEVICE_VENDOR','mapping','substring','ipad','中国联通','sort','page','fetchAppInfoFromDB','newUv','WECHAT_SCENE','key','../entity/sts.metrics.entity','channel','SELECT\x20install_channel\x20AS\x20id,\x20COUNT(1)\x20AS\x20uv\x20from\x20','待确认场景','460','getOwnPropertyDescriptor','\x27\x20AND\x20is_new_user\x20=\x201\x20GROUP\x20BY\x20','entityManager','WECHAT','pageSize','isPaginationSupported','metric','formatPropertiesToNumbers','metrics','StsMetricsEntity','数据已初始化','singleQuery','where','into','andWhere','assign','MetricsGroupListItemRspDto','MetricsGroupRspDto','resolutions','app_versions','replace','\x0a\x20\x20\x20\x20','mccmnc','vendor','map','../../shared/service/base.service','os_versions','\x20AS\x20m,\x20count(1)\x20AS\x20p,\x20uniqExact(device_no)\x20AS\x20u\x20FROM\x20','execute','__decorate','responseSuccess','519vryccV','iphone','startDailyStatistics','../../shared/service/clickhouse/clickhouse.service','Apple','app_version','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20COUNT(1)\x20AS\x20pv,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uniqExact(device_no)\x20AS\x20uv,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uniqExact(CASE\x20WHEN\x20is_new_user\x20=\x201\x20THEN\x20device_no\x20ELSE\x20NULL\x20END)\x20AS\x20newUv\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','mergeObjectsByProperty','EntityManager','DeviceMappingEntity','value','push','startTime\x20>=\x20:startTime','\x20AS\x20m,\x20uniqExact(device_no)\x20AS\x20u\x20FROM\x20','length','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x20LIMIT\x20','__esModule','\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','DAY','Logger','4606104lXfaLi','find','count','ALIPAY','ALIPA_SCENE','ClickhouseService','device',')\x20AS\x20c\x20FROM\x20','insert','clearDailyData','concat','keys','7111060kcGiQF','SELECT\x20','type','\x27\x20AND\x20start_time\x20<=\x20\x27','typeorm','metricToDbField','getStartAndEndTime','中国电信','includes','Between','mapSceneCodeToName','forEach','logger','\x0a\x20\x20\x20\x20\x20\x20WHERE\x20','metadata','endTimeString','applicationService','\x20!=\x20\x27\x27\x20AND\x20','toLocaleLowerCase','\x27\x20AND\x20first_visit_time\x20<=\x20\x27','appType','1971cWqTpg','dateFormat','query','indexOf','1362eofLVl','string','DateUnit','\x20!=\x20\x27undefined\x27','carrier','中国移动','AppType'];_0x4852=function(){return _0x1e08af;};return _0x4852();}function _0x1be0(_0x4c0afe,_0x1d567f){const _0x485212=_0x4852();return _0x1be0=function(_0x1be012,_0x26f7ec){_0x1be012=_0x1be012-0x151;let _0xb3ce0=_0x485212[_0x1be012];return _0xb3ce0;},_0x1be0(_0x4c0afe,_0x1d567f);}var __decorate=this&&this[_0x3bed4b(0x1e2)]||function(_0x3a12a9,_0x4d389c,_0x1365ba,_0x222571){const _0x5bc6a7=_0x3bed4b;var _0x632670=arguments[_0x5bc6a7(0x1f2)],_0x27e86a=_0x632670<0x3?_0x4d389c:_0x222571===null?_0x222571=Object[_0x5bc6a7(0x1c5)](_0x4d389c,_0x1365ba):_0x222571,_0x1e441a;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x5bc6a7(0x19e))_0x27e86a=Reflect['decorate'](_0x3a12a9,_0x4d389c,_0x1365ba,_0x222571);else{for(var _0x1d95ad=_0x3a12a9[_0x5bc6a7(0x1f2)]-0x1;_0x1d95ad>=0x0;_0x1d95ad--)if(_0x1e441a=_0x3a12a9[_0x1d95ad])_0x27e86a=(_0x632670<0x3?_0x1e441a(_0x27e86a):_0x632670>0x3?_0x1e441a(_0x4d389c,_0x1365ba,_0x27e86a):_0x1e441a(_0x4d389c,_0x1365ba))||_0x27e86a;}return _0x632670>0x3&&_0x27e86a&&Object['defineProperty'](_0x4d389c,_0x1365ba,_0x27e86a),_0x27e86a;},__metadata=this&&this[_0x3bed4b(0x195)]||function(_0xf831ec,_0x572268){const _0x11bc22=_0x3bed4b;if(typeof Reflect===_0x11bc22(0x18c)&&typeof Reflect[_0x11bc22(0x16f)]==='function')return Reflect[_0x11bc22(0x16f)](_0xf831ec,_0x572268);},MetricsService_1;Object[_0x3bed4b(0x1a9)](exports,_0x3bed4b(0x151),{'value':!![]}),exports['MetricsService']=void 0x0;const table_constant_1=require(_0x3bed4b(0x1a2)),base_service_1=require(_0x3bed4b(0x1de)),clickhouse_service_1=require(_0x3bed4b(0x1e7)),common_1=require(_0x3bed4b(0x1a6)),sts_metrics_entity_1=require(_0x3bed4b(0x1c0)),obj_utils_1=require('../../shared/utils/obj.utils'),typeorm_1=require(_0x3bed4b(0x165)),time_utils_1=require('../../shared/utils/time.utils'),metrics_group_rsp_dto_1=require(_0x3bed4b(0x181)),device_mapping_entity_1=require(_0x3bed4b(0x182)),device_list_mapping_1=require(_0x3bed4b(0x187)),biz_constant_1=require('../../shared/constants/biz.constant'),application_service_1=require(_0x3bed4b(0x183)),date_constant_1=require(_0x3bed4b(0x194)),metrics_trendline_rsp_dto_1=require('../dto/metrics.trendline.rsp.dto');let MetricsService=MetricsService_1=class MetricsService extends base_service_1['BaseService']{constructor(_0x1aaa5c,_0x16f70d,_0xd7f9f2){const _0x2ba0b5=_0x3bed4b;super(),this[_0x2ba0b5(0x188)]=_0x1aaa5c,this['entityManager']=_0x16f70d,this[_0x2ba0b5(0x171)]=_0xd7f9f2,this[_0x2ba0b5(0x16d)]=new common_1[(_0x2ba0b5(0x154))](MetricsService_1[_0x2ba0b5(0x18f)]);}async['fetch'](_0x2f8179){const _0x505200=_0x3bed4b;if(_0x2f8179[_0x505200(0x1cb)]==_0x505200(0x1b4))return await this['fetchInstallChannel'](_0x2f8179);const _0xd23930=_0x2f8179[_0x505200(0x1cb)],_0x37272b=table_constant_1['SEARCH_TABLE']+'_'+_0x2f8179[_0x505200(0x1aa)],{startTime:_0x521570,endTime:_0x524dd6}=(0x0,time_utils_1[_0x505200(0x167)])(_0x2f8179[_0x505200(0x193)]),_0x4e0ca9=this[_0x505200(0x166)](_0xd23930),_0x4b19=this[_0x505200(0x1ca)](_0xd23930);let _0x26b374='start_time\x20>=\x20\x27'+_0x521570+_0x505200(0x164)+_0x524dd6+'\x27\x20AND\x20'+_0x4e0ca9+_0x505200(0x172)+_0x4e0ca9+_0x505200(0x17d),_0x503716='';if(_0x4b19){const _0x4a974a=_0x2f8179[_0x505200(0x1bb)]||0x1,_0x1f3190=_0x2f8179[_0x505200(0x1c9)]||0xa;_0x503716=_0x505200(0x1f4)+(_0x4a974a-0x1)*_0x1f3190+','+_0x1f3190;}const _0x2612cc=await this['clickhouse'][_0x505200(0x178)](_0x505200(0x1f3)+_0x4e0ca9+'\x20AS\x20id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20COUNT(1)\x20AS\x20pv,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uniqExact(device_no)\x20AS\x20uv,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uniqExact(CASE\x20WHEN\x20is_new_user\x20=\x201\x20THEN\x20device_no\x20ELSE\x20NULL\x20END)\x20AS\x20newUv\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x37272b+_0x505200(0x16e)+_0x26b374+_0x505200(0x152)+_0x4e0ca9+'\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x20pv\x20DESC'+_0x503716+'\x0a\x20\x20\x20');if((0x0,obj_utils_1[_0x505200(0x1ad)])(_0x2612cc))return this['responseSuccess']({});const _0x5de5d1=await this[_0x505200(0x188)][_0x505200(0x1d0)](_0x505200(0x18e)+_0x4e0ca9+_0x505200(0x15c)+_0x37272b+_0x505200(0x1a5)+_0x26b374),_0xaf1cae=_0x5de5d1['c']||0x0,_0x554d27=await this[_0x505200(0x188)][_0x505200(0x1d0)](_0x505200(0x1ea)+_0x37272b+'\x0a\x20\x20\x20\x20\x20\x20WHERE\x20'+_0x26b374+_0x505200(0x1da)),_0x57d31c=_0x554d27['pv']||0x0,_0x4e3809=_0x554d27['uv']||0x0,_0x153042=_0x554d27[_0x505200(0x1bd)]||0x0;let _0x19fb1a=_0x2612cc[_0x505200(0x1dd)](_0x5d30df=>{const _0x504cc5=_0x505200,_0x117766=new metrics_group_rsp_dto_1[(_0x504cc5(0x1d5))]();return Object[_0x504cc5(0x1d4)](_0x117766,_0x5d30df),_0x117766[_0x504cc5(0x1cc)](),_0x117766;});if(_0xd23930==_0x505200(0x1ab))_0x19fb1a=_0x19fb1a[_0x505200(0x1dd)](_0x476fff=>{return _0x476fff['id']=this['carrierNameWithCode'](_0x476fff['id']),_0x476fff;}),_0x19fb1a=this['mergeObjectsByProperty'](_0x19fb1a,'id');else{if(_0xd23930=='devices'||_0xd23930==_0x505200(0x1dc))_0x19fb1a=await this[_0x505200(0x1b3)](_0x19fb1a,_0xd23930);else{if(_0xd23930=='scene')_0x19fb1a=await this[_0x505200(0x16b)](_0x2f8179[_0x505200(0x1aa)],_0x19fb1a);else _0xd23930==_0x505200(0x1df)&&(_0x19fb1a=await this[_0x505200(0x196)](_0x19fb1a));}}const _0x247f0a=_0x19fb1a[_0x505200(0x1ba)]((_0x2c691,_0x428e7)=>{return _0x428e7['pv']-_0x2c691['pv'];}),_0x1d425f=new metrics_group_rsp_dto_1[(_0x505200(0x1d6))]();return _0x1d425f['list']=_0x247f0a,_0x1d425f['count']=_0x4b19?Number(_0xaf1cae):_0x19fb1a['length'],_0x1d425f['pv']=Number(_0x57d31c),_0x1d425f['uv']=Number(_0x4e3809),_0x1d425f['newUv']=Number(_0x153042),this[_0x505200(0x1e3)](_0x1d425f);}async['trendline'](_0x19e22e){const _0x4a32ee=_0x3bed4b,{stsStartTime:_0x4fc5ff,stsEndTime:_0x1acdbc}=(0x0,time_utils_1['getStartAndEndTime'])(_0x19e22e[_0x4a32ee(0x193)]),_0x3cba3e=await this[_0x4a32ee(0x1c7)][_0x4a32ee(0x156)](sts_metrics_entity_1['StsMetricsEntity'],{'where':{'appId':_0x19e22e['appId'],'type':date_constant_1[_0x4a32ee(0x17c)][_0x4a32ee(0x153)],'startTime':(0x0,typeorm_1[_0x4a32ee(0x16a)])(new Date(_0x4fc5ff),new Date(_0x1acdbc)),'del':0x0}});if((0x0,obj_utils_1['isEmpty'])(_0x3cba3e))return this[_0x4a32ee(0x1e3)]({});const _0x25067c=_0x3cba3e[_0x4a32ee(0x190)]((_0x12098f,_0x5a2263)=>{const _0x209765=_0x4a32ee,_0x4f33c5=(0x0,time_utils_1[_0x209765(0x177)])(_0x5a2263[_0x209765(0x1ae)],date_constant_1[_0x209765(0x19d)]);return _0x12098f[_0x4f33c5]=_0x5a2263,_0x12098f;},{}),_0x195cc8=(0x0,time_utils_1['getTicksBetween'])(_0x19e22e[_0x4a32ee(0x193)]),_0x4cceef=_0x195cc8[_0x4a32ee(0x1dd)](_0x301b56=>{const _0x4a8751=_0x4a32ee,_0x387d2=_0x25067c[_0x301b56],_0x1aefdd=!_0x387d2?0x0:_0x387d2['uv'],_0x39e3f4=!_0x387d2?0x0:_0x387d2['pv'],_0x14ddf4=!_0x387d2?0x0:_0x387d2[_0x4a8751(0x1bd)];return{'id':_0x301b56,'uv':_0x1aefdd,'newUv':_0x14ddf4,'pv':_0x39e3f4};}),_0x21d694=new metrics_trendline_rsp_dto_1['MetricsTrendlineRspDto']();return _0x21d694[_0x4a32ee(0x18a)]=_0x4cceef,_0x21d694[_0x4a32ee(0x157)]=_0x4cceef[_0x4a32ee(0x1f2)],this[_0x4a32ee(0x1e3)](_0x21d694);}async['setup'](){const _0x8ff197=_0x3bed4b,_0x4139e3=await this[_0x8ff197(0x1c7)][_0x8ff197(0x157)](device_mapping_entity_1[_0x8ff197(0x1ed)]);if(_0x4139e3>0x0)return this[_0x8ff197(0x1a8)](_0x8ff197(0x1cf));const _0x4e1872=device_list_mapping_1[_0x8ff197(0x199)],_0x15c55e=[];return Object[_0x8ff197(0x160)](_0x4e1872)['forEach'](_0x272a75=>{const _0x870e4e=_0x8ff197,_0x3e988b=_0x4e1872[''+_0x272a75],_0x41ef74=new device_mapping_entity_1[(_0x870e4e(0x1ed))]();_0x41ef74[_0x870e4e(0x1dc)]=_0x3e988b[_0x870e4e(0x1dc)],_0x41ef74[_0x870e4e(0x18f)]=_0x3e988b[_0x870e4e(0x18f)],_0x41ef74[_0x870e4e(0x15b)]=_0x272a75,_0x15c55e[_0x870e4e(0x1ef)](_0x41ef74);}),await this[_0x8ff197(0x1c7)][_0x8ff197(0x18b)]()[_0x8ff197(0x15d)]()[_0x8ff197(0x1d2)](device_mapping_entity_1[_0x8ff197(0x1ed)])['values'](_0x15c55e)[_0x8ff197(0x1e1)](),this[_0x8ff197(0x1e3)]('success');}[_0x3bed4b(0x1ca)](_0x55303e){const _0x1c7fad=_0x3bed4b,_0x298ff1=[_0x1c7fad(0x1d8),'devices','os',_0x1c7fad(0x1df),_0x1c7fad(0x184),_0x1c7fad(0x1d7),_0x1c7fad(0x1c1)];return _0x298ff1[_0x1c7fad(0x169)](_0x55303e);}async['fetchInstallChannel'](_0x59d75a){const _0x54993e=_0x3bed4b,{startTime:_0x1ef31b,endTime:_0x553b7e}=(0x0,time_utils_1['getStartAndEndTime'])(_0x59d75a[_0x54993e(0x193)]),_0x354f23=table_constant_1[_0x54993e(0x197)]+'_'+_0x59d75a[_0x54993e(0x1aa)],_0x4bfb4f=await this[_0x54993e(0x188)][_0x54993e(0x178)](_0x54993e(0x1c2)+_0x354f23+'\x20WHERE\x20first_visit_time\x20>=\x20\x27'+_0x1ef31b+_0x54993e(0x174)+_0x553b7e+'\x27\x20GROUP\x20BY\x20install_channel');if((0x0,obj_utils_1[_0x54993e(0x1ad)])(_0x4bfb4f))return this['responseSuccess']({});const _0x112ddf=new metrics_group_rsp_dto_1[(_0x54993e(0x1d6))]();return _0x112ddf[_0x54993e(0x18a)]=_0x4bfb4f['map'](_0x15fbbb=>{const _0x43ec17=_0x54993e,_0x58a675=new metrics_group_rsp_dto_1[(_0x43ec17(0x1d5))]();return _0x58a675['id']=_0x15fbbb['id'],_0x58a675['uv']=Number(_0x15fbbb['uv']),_0x58a675;}),_0x112ddf[_0x54993e(0x157)]=_0x112ddf[_0x54993e(0x18a)][_0x54993e(0x1f2)],this['responseSuccess'](_0x112ddf);}[_0x3bed4b(0x19b)](_0x317e72){const _0x387dc7=_0x3bed4b;if(typeof _0x317e72!=_0x387dc7(0x17b)||_0x317e72['length']<0x5)return'未知';const _0x46e58d=_0x317e72[_0x387dc7(0x1b7)](0x0,0x3),_0x47cbac=_0x317e72[_0x387dc7(0x1b7)](0x3,0x5);if(_0x46e58d!==_0x387dc7(0x1c4))return'未知';const _0x3b92fe=['00','02','04','07','08'],_0x29b12d=['03','05','11'],_0x35c872=['01','06','09'],_0x5b9783=['20'];if(_0x3b92fe[_0x387dc7(0x179)](_0x47cbac)!==-0x1)return _0x387dc7(0x17f);else{if(_0x29b12d[_0x387dc7(0x179)](_0x47cbac)!==-0x1)return _0x387dc7(0x168);else{if(_0x35c872[_0x387dc7(0x179)](_0x47cbac)!==-0x1)return _0x387dc7(0x1b9);else{if(_0x5b9783[_0x387dc7(0x179)](_0x47cbac)!==-0x1)return'中国铁通';}}}return'未知';}[_0x3bed4b(0x1eb)](_0x11f125,_0x2d3d20){const _0x2c7128=_0x3bed4b,_0x1ca3e2={};for(const _0x3feb69 of _0x11f125){const _0x5e5268=_0x3feb69[_0x2d3d20];!_0x1ca3e2[_0x5e5268]?_0x1ca3e2[_0x5e5268]={'id':_0x5e5268,'pv':_0x3feb69['pv'],'uv':_0x3feb69['uv'],'newUv':_0x3feb69[_0x2c7128(0x1bd)]}:(_0x1ca3e2[_0x5e5268]['pv']+=_0x3feb69['pv'],_0x1ca3e2[_0x5e5268]['uv']+=_0x3feb69['uv'],_0x1ca3e2[_0x5e5268][_0x2c7128(0x1bd)]+=_0x3feb69[_0x2c7128(0x1bd)]);}return Object[_0x2c7128(0x19f)](_0x1ca3e2);}async[_0x3bed4b(0x1b3)](_0x2555fc,_0x2296d7){const _0x4aad83=_0x3bed4b;if((0x0,obj_utils_1[_0x4aad83(0x1ad)])(_0x2555fc))return[];const _0x5df3f6=_0x2555fc[_0x4aad83(0x1dd)](_0x1bad69=>_0x1bad69['id']),_0x4bdc81=await this['getDeviceMappingObj'](_0x5df3f6),_0x4d6350=_0x4bdc81['reduce']((_0x1835c6,_0x57bf71)=>{const _0x46ec77=_0x4aad83;return _0x1835c6[_0x57bf71[_0x46ec77(0x15b)]]=_0x57bf71,_0x1835c6;},{});return _0x2555fc[_0x4aad83(0x16c)](function(_0x11a76d){const _0x4cf8ec=_0x4aad83,_0x5ddfde=_0x11a76d['id'],_0x96b682=_0x4d6350[_0x5ddfde];if(!(0x0,obj_utils_1[_0x4cf8ec(0x1ad)])(_0x96b682))_0x11a76d['id']=_0x96b682[_0x4cf8ec(0x18f)],_0x11a76d['vendor']=_0x96b682['vendor'],_0x11a76d[_0x4cf8ec(0x1b6)]=!![];else{_0x11a76d[_0x4cf8ec(0x1b6)]=![];if(_0x5ddfde[_0x4cf8ec(0x173)]()['includes'](_0x4cf8ec(0x1e5))||_0x5ddfde[_0x4cf8ec(0x173)]()['includes'](_0x4cf8ec(0x1b8)))_0x11a76d[_0x4cf8ec(0x1dc)]=_0x4cf8ec(0x1e8);else{const _0x55266e=_0x5ddfde[_0x4cf8ec(0x1b2)]('\x20');_0x11a76d['vendor']=device_list_mapping_1[_0x4cf8ec(0x1b5)][_0x55266e[0x0]]||'未知';}}}),_0x2296d7===_0x4aad83(0x1dc)&&(_0x2555fc=this[_0x4aad83(0x1eb)](_0x2555fc,_0x4aad83(0x1dc))),_0x2555fc;}async[_0x3bed4b(0x16b)](_0x34da76,_0x3bb333){const _0x4a1d73=_0x3bed4b,_0x567a40=await this['appType'](_0x34da76);if(_0x567a40!=biz_constant_1[_0x4a1d73(0x180)][_0x4a1d73(0x1c8)]&&_0x567a40!=biz_constant_1[_0x4a1d73(0x180)][_0x4a1d73(0x158)])return _0x3bb333;const _0x59b7b5=biz_constant_1['AppType'][_0x4a1d73(0x1c8)]==_0x567a40?device_list_mapping_1[_0x4a1d73(0x1be)]:device_list_mapping_1[_0x4a1d73(0x159)];let _0x2b2375=0x0,_0x2de0fb=0x0,_0x4bbda6=0x0;const _0x568a52=[];return _0x3bb333[_0x4a1d73(0x16c)](_0x5256c9=>{const _0x336f49=_0x4a1d73,_0x1c9464=_0x5256c9['id'],_0x290646=_0x59b7b5[_0x1c9464];(0x0,obj_utils_1['isEmpty'])(_0x290646)?(_0x2b2375+=_0x5256c9['pv'],_0x2de0fb+=_0x5256c9[_0x336f49(0x1bd)],_0x4bbda6+=_0x5256c9['uv']):(_0x5256c9['id']=_0x1c9464+'（'+_0x290646+'）',_0x5256c9[_0x336f49(0x1bf)]=_0x1c9464,_0x568a52[_0x336f49(0x1ef)](_0x5256c9));}),_0x2b2375>0x0&&_0x568a52[_0x4a1d73(0x1ef)]({'id':_0x4a1d73(0x1c3),'key':'','pv':_0x2b2375,'newUv':_0x2de0fb,'uv':_0x4bbda6}),_0x568a52;}[_0x3bed4b(0x196)](_0x5309e4){const _0x1fc68e=_0x3bed4b;if((0x0,obj_utils_1['isEmpty'])(_0x5309e4))return[];return _0x5309e4[_0x1fc68e(0x1dd)](_0x195082=>{const _0x33b98d=_0x1fc68e;let _0x8bdab5=_0x195082['id'];if(_0x8bdab5[_0x33b98d(0x169)]('i')||_0x8bdab5[_0x33b98d(0x169)]('a')){const _0x40ae6f=_0x8bdab5[_0x33b98d(0x169)]('a')?'Android\x20':_0x33b98d(0x19c);_0x8bdab5=_0x8bdab5[_0x33b98d(0x1d9)]('i',_0x40ae6f)[_0x33b98d(0x1d9)]('a',_0x40ae6f);}else _0x8bdab5=_0x33b98d(0x198)+_0x8bdab5;return Object[_0x33b98d(0x1d4)](Object[_0x33b98d(0x1d4)]({},_0x195082),{'id':_0x8bdab5});});}async[_0x3bed4b(0x1af)](_0x5746d7){const _0x4bcc02=_0x3bed4b,_0x2228df=await this[_0x4bcc02(0x175)](_0x5746d7);if(_0x2228df==biz_constant_1[_0x4bcc02(0x180)]['WECHAT']||_0x2228df==biz_constant_1[_0x4bcc02(0x180)]['ALIPAY'])return!![];return![];}async[_0x3bed4b(0x175)](_0x407fc7){const _0x29fb1a=_0x3bed4b,_0x49adfd=await this['applicationService'][_0x29fb1a(0x1bc)](_0x407fc7);return _0x49adfd[_0x29fb1a(0x163)];}async['getDeviceMappingObj'](_0x21a611){const _0x2e7557=_0x3bed4b,_0xeaff57=await this[_0x2e7557(0x1c7)]['find'](device_mapping_entity_1[_0x2e7557(0x1ed)],{'select':[_0x2e7557(0x15b),'name',_0x2e7557(0x1dc)],'where':{'device':(0x0,typeorm_1['In'])(_0x21a611)}});return _0xeaff57;}['metricToDbField'](_0x14c1ca){const _0x182e7f=_0x3bed4b;switch(_0x14c1ca){case _0x182e7f(0x1d8):return _0x182e7f(0x1e9);case _0x182e7f(0x1df):return _0x182e7f(0x192);case _0x182e7f(0x184):return'platform_version';case _0x182e7f(0x1d7):return'resolution';case _0x182e7f(0x1b0):case _0x182e7f(0x1dc):return _0x182e7f(0x15b);case _0x182e7f(0x1ab):return _0x182e7f(0x1db);case'channel':return _0x182e7f(0x1b4);default:{return _0x14c1ca;}}}async[_0x3bed4b(0x1e6)](_0x37b05c,_0x1e1d0a,_0xd5ce5f){const _0x24cc56=_0x3bed4b,_0xecd26e=[_0x24cc56(0x1e9),_0x24cc56(0x17e),_0x24cc56(0x15b),_0x24cc56(0x1db),'os','os_version',_0x24cc56(0x1a3),'install_channel',_0x24cc56(0x1b1)];let _0x4f6698=[];const _0x4b6062=table_constant_1[_0x24cc56(0x19a)]+'_'+_0x37b05c;for(const _0x4bfd8d of _0xd5ce5f){for(const _0x1fcafc of _0xecd26e){const _0x46c4c3='SELECT\x20'+_0x1fcafc+_0x24cc56(0x1e0)+_0x4b6062+_0x24cc56(0x1ac)+_0x4bfd8d['startTimeString']+_0x24cc56(0x164)+_0x4bfd8d[_0x24cc56(0x170)]+_0x24cc56(0x191)+_0x1fcafc,_0x3b98b2=await this[_0x24cc56(0x188)][_0x24cc56(0x178)](_0x46c4c3);if((0x0,obj_utils_1['isEmpty'])(_0x3b98b2))continue;const _0x1cd87e=_0x3b98b2[_0x24cc56(0x190)]((_0x4717bf,_0x25f293)=>{const _0x1eac88=_0x24cc56;return!(0x0,obj_utils_1[_0x1eac88(0x1ad)])(_0x25f293['m'])&&(_0x4717bf[_0x25f293['m']]={'pv':_0x25f293['p'],'uv':_0x25f293['u']}),_0x4717bf;},{});let _0x23d1e3={};const _0x58c747=_0x24cc56(0x162)+_0x1fcafc+_0x24cc56(0x1f1)+_0x4b6062+_0x24cc56(0x1ac)+_0x4bfd8d[_0x24cc56(0x1a4)]+'\x27\x20AND\x20start_time\x20<=\x20\x27'+_0x4bfd8d[_0x24cc56(0x170)]+_0x24cc56(0x1c6)+_0x1fcafc,_0x1f92b8=await this['clickhouse'][_0x24cc56(0x178)](_0x58c747);!(0x0,obj_utils_1[_0x24cc56(0x1ad)])(_0x1f92b8)&&(_0x23d1e3=_0x1f92b8[_0x24cc56(0x190)]((_0x41f0eb,_0x453519)=>{return!(0x0,obj_utils_1['isEmpty'])(_0x453519['m'])&&(_0x41f0eb[_0x453519['m']]=_0x453519['u']),_0x41f0eb;},{}));const _0x510550=Object['keys'](_0x1cd87e)[_0x24cc56(0x1dd)](_0x3b3eb1=>{return _0x3b3eb1;});let _0x11b807={};if(!(0x0,obj_utils_1[_0x24cc56(0x1ad)])(_0x510550)){const _0x3a7a04=await this['entityManager'][_0x24cc56(0x156)](sts_metrics_entity_1[_0x24cc56(0x1ce)],{'select':['value',_0x24cc56(0x186)],'where':{'appId':_0x37b05c,'type':_0x4bfd8d[_0x24cc56(0x163)],'metrics_type':_0x1fcafc,'value':(0x0,typeorm_1['In'])(_0x510550),'del':0x0},'order':{'startTime':'DESC'}});!(0x0,obj_utils_1[_0x24cc56(0x1ad)])(_0x3a7a04)&&(_0x11b807=_0x3a7a04['reduce']((_0x46ed18,_0x3922d1)=>{const _0x543684=_0x24cc56;return!(0x0,obj_utils_1[_0x543684(0x1ad)])(_0x3922d1[_0x543684(0x1ee)])&&(_0x46ed18[_0x3922d1['value']]=_0x3922d1[_0x543684(0x186)]),_0x46ed18;},{}));}const _0x350bfd=[];for(const _0x5edf4e of Object['keys'](_0x1cd87e)){if((0x0,obj_utils_1[_0x24cc56(0x1ad)])(_0x5edf4e)||_0x5edf4e[_0x24cc56(0x1f2)]>0x200)continue;const _0x390a8e=_0x1cd87e[_0x5edf4e]||{'pv':0x0,'uv':0x0},_0x3d14b9=_0x23d1e3[_0x5edf4e]||0x0,_0x1fa79d=_0x11b807[_0x5edf4e]||0x0,_0x2e915c=new sts_metrics_entity_1['StsMetricsEntity'](_0x4bfd8d);_0x2e915c['appId']=_0x37b05c,_0x2e915c['metrics_type']=_0x1fcafc,_0x2e915c['value']=_0x5edf4e,_0x2e915c['uv']=Number(_0x390a8e['uv']),_0x2e915c['pv']=Number(_0x390a8e['pv']),_0x2e915c[_0x24cc56(0x1bd)]=Number(_0x3d14b9),_0x2e915c[_0x24cc56(0x186)]=Number(_0x1fa79d),_0x350bfd[_0x24cc56(0x1ef)](_0x2e915c);}_0x4f6698=_0x4f6698[_0x24cc56(0x15f)](_0x350bfd);}}_0x4f6698[_0x24cc56(0x1f2)]>0x0&&await this[_0x24cc56(0x1c7)]['createQueryBuilder']()['insert']()[_0x24cc56(0x1d2)](sts_metrics_entity_1[_0x24cc56(0x1ce)])[_0x24cc56(0x19f)](_0x4f6698)[_0x24cc56(0x1e1)]();}async[_0x3bed4b(0x15e)](_0x46d397,_0x18da4c,_0x109004){const _0x30f177=_0x3bed4b;for(const _0x8c693b of _0x109004){await this[_0x30f177(0x1c7)]['getRepository'](sts_metrics_entity_1[_0x30f177(0x1ce)])[_0x30f177(0x18b)](_0x30f177(0x1cd))[_0x30f177(0x185)]()[_0x30f177(0x1d1)]('appId\x20=\x20:appId',{'appId':_0x46d397})[_0x30f177(0x1d3)]('type\x20=\x20:type',{'type':_0x8c693b['type']})[_0x30f177(0x1d3)](_0x30f177(0x1f0),{'startTime':_0x8c693b['startTimeString']})['execute']();}}};MetricsService=MetricsService_1=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x3bed4b(0x189),[clickhouse_service_1[_0x3bed4b(0x15a)],typeorm_1[_0x3bed4b(0x1ec)],application_service_1['ApplicationService']])],MetricsService),exports['MetricsService']=MetricsService;