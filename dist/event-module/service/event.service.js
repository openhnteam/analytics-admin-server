'use strict';const _0x470e4c=_0x549f;(function(_0x312043,_0x49d11b){const _0x57725=_0x549f,_0x16a5ad=_0x312043();while(!![]){try{const _0x245fd4=parseInt(_0x57725(0x1cf))/0x1+-parseInt(_0x57725(0x257))/0x2*(parseInt(_0x57725(0x222))/0x3)+parseInt(_0x57725(0x23b))/0x4*(-parseInt(_0x57725(0x200))/0x5)+-parseInt(_0x57725(0x241))/0x6*(-parseInt(_0x57725(0x183))/0x7)+-parseInt(_0x57725(0x20b))/0x8+-parseInt(_0x57725(0x1c7))/0x9+parseInt(_0x57725(0x1cb))/0xa;if(_0x245fd4===_0x49d11b)break;else _0x16a5ad['push'](_0x16a5ad['shift']());}catch(_0x173051){_0x16a5ad['push'](_0x16a5ad['shift']());}}}(_0x4668,0x8ac85));var __createBinding=this&&this[_0x470e4c(0x22f)]||(Object['create']?function(_0x2a69d1,_0x32831e,_0x123a2d,_0x48fa64){const _0x5f36cd=_0x470e4c;if(_0x48fa64===undefined)_0x48fa64=_0x123a2d;var _0x2d3954=Object['getOwnPropertyDescriptor'](_0x32831e,_0x123a2d);(!_0x2d3954||('get'in _0x2d3954?!_0x32831e[_0x5f36cd(0x243)]:_0x2d3954[_0x5f36cd(0x1de)]||_0x2d3954[_0x5f36cd(0x1fd)]))&&(_0x2d3954={'enumerable':!![],'get':function(){return _0x32831e[_0x123a2d];}}),Object[_0x5f36cd(0x1bf)](_0x2a69d1,_0x48fa64,_0x2d3954);}:function(_0x14d9c2,_0xaa3023,_0x230de0,_0x3a5723){if(_0x3a5723===undefined)_0x3a5723=_0x230de0;_0x14d9c2[_0x3a5723]=_0xaa3023[_0x230de0];}),__setModuleDefault=this&&this[_0x470e4c(0x1ed)]||(Object[_0x470e4c(0x197)]?function(_0x211d73,_0x517c23){const _0x39ec05=_0x470e4c;Object[_0x39ec05(0x1bf)](_0x211d73,_0x39ec05(0x1b1),{'enumerable':!![],'value':_0x517c23});}:function(_0x29d6a9,_0x49986f){_0x29d6a9['default']=_0x49986f;}),__decorate=this&&this[_0x470e4c(0x230)]||function(_0x7879f5,_0x5ce063,_0x1f9b2f,_0x1eb1cc){const _0x5bb8ba=_0x470e4c;var _0x2f853a=arguments[_0x5bb8ba(0x1ac)],_0x48e145=_0x2f853a<0x3?_0x5ce063:_0x1eb1cc===null?_0x1eb1cc=Object[_0x5bb8ba(0x1f3)](_0x5ce063,_0x1f9b2f):_0x1eb1cc,_0x42d862;if(typeof Reflect===_0x5bb8ba(0x248)&&typeof Reflect[_0x5bb8ba(0x22b)]===_0x5bb8ba(0x1b9))_0x48e145=Reflect[_0x5bb8ba(0x22b)](_0x7879f5,_0x5ce063,_0x1f9b2f,_0x1eb1cc);else{for(var _0x199195=_0x7879f5[_0x5bb8ba(0x1ac)]-0x1;_0x199195>=0x0;_0x199195--)if(_0x42d862=_0x7879f5[_0x199195])_0x48e145=(_0x2f853a<0x3?_0x42d862(_0x48e145):_0x2f853a>0x3?_0x42d862(_0x5ce063,_0x1f9b2f,_0x48e145):_0x42d862(_0x5ce063,_0x1f9b2f))||_0x48e145;}return _0x2f853a>0x3&&_0x48e145&&Object[_0x5bb8ba(0x1bf)](_0x5ce063,_0x1f9b2f,_0x48e145),_0x48e145;},__importStar=this&&this[_0x470e4c(0x198)]||function(_0x1e6ed0){const _0x22003b=_0x470e4c;if(_0x1e6ed0&&_0x1e6ed0[_0x22003b(0x243)])return _0x1e6ed0;var _0x1b9ffd={};if(_0x1e6ed0!=null){for(var _0x1b57f9 in _0x1e6ed0)if(_0x1b57f9!=='default'&&Object[_0x22003b(0x1c5)]['hasOwnProperty'][_0x22003b(0x238)](_0x1e6ed0,_0x1b57f9))__createBinding(_0x1b9ffd,_0x1e6ed0,_0x1b57f9);}return __setModuleDefault(_0x1b9ffd,_0x1e6ed0),_0x1b9ffd;},__metadata=this&&this[_0x470e4c(0x187)]||function(_0x2aeccf,_0xddb8b6){const _0x14e981=_0x470e4c;if(typeof Reflect===_0x14e981(0x248)&&typeof Reflect[_0x14e981(0x190)]===_0x14e981(0x1b9))return Reflect[_0x14e981(0x190)](_0x2aeccf,_0xddb8b6);},__importDefault=this&&this[_0x470e4c(0x21d)]||function(_0x2e5147){return _0x2e5147&&_0x2e5147['__esModule']?_0x2e5147:{'default':_0x2e5147};},EventService_1;function _0x4668(){const _0x499848=['601894JSbeuH','createStsEventSegTable','EventSegValueStsRspDto','saveOrIgnoreEventInfo','EventInfoListRspDto','\x20WHERE\x20create_time\x20>=\x20\x27','sts_event_seg_','design:paramtypes','skip','getStartAndEndTime','dailyDealEventPvAndUv','delete','DateUnit','EventSegStsRspDto','eventDes','segId','\x27\x20AND\x20create_time\x20<=\x20\x27','eventSegStsList','undefined','1205071ouidMG','days','EVENT_TABLE','keys','__metadata','appId\x20=\x20:appId','count','active','endTimeString','filter','segList','getEventSegEntityListFromDetail','getEventIdsFromDetail','metadata','EventStatus','seg_value\x20AS\x20id,\x20SUM(pv)\x20AS\x20pv','\x0a\x20\x20\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20','createCkEventTable','DAY','hash','create','__importStar','EventStsRspDto','../dto/event.info.list.rsp.dto','push','getEventsPvAndUvFromDetail','../../shared/utils/obj.utils','EventService','dailyDealEventInfo','SHA1','StsEventSegmentEntity','eventStatus','select','saveOrIgnoreEventSegInfo','EventStsListRspDto','singleQuery','logger','../../shared/constants/table.constant','null','createStsEventTable','where','length','app_id\x20=\x20:appId','\x27\x20GROUP\x20BY\x20event_id','startTime\x20>=\x20:startTime','key','default','saveOrUpdateEventSegInfo','getUnRegisteredEventSegIds','seg_id\x20=\x20:segId','avg','editEventSegInfo','\x20WHERE\x20','responseSuccess','function','\x27)\x20COMMENT\x20\x27上报时间\x27,\x0a\x20\x20\x20\x20\x20\x20timestamp\x20DateTime(\x27','dailyDealEventSegInfo','orUpdate','orderBy','\x27)]\x20AS\x20segValue,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(1)\x20AS\x20pv,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uniqExact(device_no)\x20uv,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uniqExact(CASE\x20WHEN\x20is_new_user\x20=\x201\x20THEN\x20device_no\x20ELSE\x20NULL\x20END)\x20AS\x20newUv\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x20','defineProperty','updateEventLastModifiedTimeByAppId','EventSegInfoListRspDto','start_time\x20>=\x20:startTime','query','into','prototype','command','8260443BtOdlS','andWhere','getEventInfoEntityList','STS_EVENT_SEG_TABLE','35581960aUXgVp','\x27\x20GROUP\x20BY\x20segValue','map','stringify','485583cuqzXe','\x20error:\x20','seg','set','id\x20IN\x20(:...ids)','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20event_id\x20AS\x20eventId,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20count(1)\x20AS\x20pv,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20uniqExact(device_no)\x20AS\x20uv,\x0a\x20\x20\x20\x20\x20\x20\x20\x20uniqExact(CASE\x20WHEN\x20is_new_user\x20=\x201\x20THEN\x20device_no\x20ELSE\x20NULL\x20END)\x20AS\x20newUv\x0a\x20\x20\x20\x20\x20\x20FROM\x20','../entity/sts.event.segment.entity','includes','../dto/event.seg.info.list.rsp.dto','appId','values','StsEventEntity','DATE_FORMAT','getEventSegVauleUv','getEventUv','writable','\x0a\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20uniqExact(device_no)\x20uv,\x0a\x20\x20\x20\x20\x20\x20uniqExact(CASE\x20WHEN\x20is_new_user\x20=\x201\x20THEN\x20device_no\x20ELSE\x20NULL\x20END)\x20AS\x20newUv\x0a\x20\x20\x20\x20FROM\x20','newUvFormat','DESC','segName','\x27\x20\x0a\x20\x20\x20\x20AND\x20\x22string_seg_values\x22[indexOf(\x22string_seg_names\x22,\x20\x27','getEventsPvAndUvFromSts','execute','getPastNDaysTimeRange','uvFormat','type\x20=\x20:type','../constant/event.status','entityManager','startTime','Hex','__setModuleDefault','SELECT\x20DISTINCT\x20arrayJoin(string_seg_names)\x20AS\x20seg,\x20event_id\x20AS\x20eventId\x20FROM\x20','segValueBlackList','entityFactory','\x0a\x20\x20\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20sts_event_','../../shared/dto/sts.uv.pv.rsp.dto','getOwnPropertyDescriptor','EventInfoEntity','create_time\x20>=\x20\x27','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22string_seg_values\x22[indexOf(\x22string_seg_names\x22,\x20\x27','error','\x0a\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20event_id\x20AS\x20eventId,\x20\x0a\x20\x20\x20\x20\x20\x20arrayDistinct(arrayFlatten(groupUniqArray(string_seg_names)))\x20AS\x20segList\x0a\x20\x20\x20\x20\x20\x20FROM\x20','../dto/event.sts.rsp.dto','clickhouse','newUv','assign','configurable','eventIds','type','82295IUbJsH','getUnRegisteredEventIds','\x27\x20GROUP\x20BY\x20id','forEach','saveOrUpdateEventInfo','start_time\x20<=\x20:endTime','isEmpty','groupBy','\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20id\x20INT(11)\x20NOT\x20NULL\x20AUTO_INCREMENT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20app_id\x20VARCHAR(24)\x20NOT\x20NULL\x20COMMENT\x20\x27应用id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20year\x20INT(4)\x20NOT\x20NULL\x20COMMENT\x20\x27年分\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20type\x20INT(2)\x20NOT\x20NULL\x20COMMENT\x20\x271-天\x202-周\x203-月\x204-季\x205-年\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20idx\x20INT(2)\x20NOT\x20NULL\x20COMMENT\x20\x27下标\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20start_time\x20DATETIME\x20NOT\x20NULL\x20COMMENT\x20\x27开始时间\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20end_time\x20DATETIME\x20NOT\x20NULL\x20COMMENT\x20\x27结束时间\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20event_id\x20VARCHAR(128)\x20NOT\x20NULL\x20COMMENT\x20\x27事件id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20pv\x20INT(11)\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uv\x20INT(11)\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20new_uv\x20INT(11)\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20create_time\x20DATETIME\x20NOT\x20NULL\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20del\x20TINYINT(1)\x20NOT\x20NULL\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20PRIMARY\x20KEY\x20(id),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20KEY\x20group_index\x20(app_id,\x20type,\x20event_id,\x20year,\x20idx),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20KEY\x20group_day_index\x20(app_id,\x20type,\x20event_id,\x20start_time)\x0a\x20\x20\x20\x20\x20\x20\x20\x20)','seg_value\x20like\x20:key','update','6187480VKrzdP','EntityFactory','calPercent','../../shared/constants/date.constant','\x20AND\x20create_time\x20<=\x20\x27','SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x22string_seg_values\x22[indexOf(\x22string_seg_names\x22,\x20\x27','xlxs','createQueryBuilder','../../shared/service/base.service','period','take','eventName','event_id\x20IN\x20(:eventIds)','page','EventSegInfoEntity','reduce','eventSegValueStsList','../entity/sts.event.entity','__importDefault','CAL','segValue','\x20\x0a\x20\x20\x20\x20WHERE\x20event_id\x20=\x20\x27','getRawOne','9SWvpGE','getTicksBetween','getEventSegInfoEntityList','\x20WHERE\x20event_id\x20=\x20\x27','ClickhouseService','@nestjs/common','startTimeString','dateFormat','BaseService','decorate','COUNT(DISTINCT(seg_value))\x20as\x20t','isTodayWithTs','pageSize','__createBinding','__decorate','../../shared/utils/xlxs.utils','parse','../entity/event.info.entity','updateEventSegLastModifiedTimeByAppId','eventSegInfoList','concat','\x27\x20AND\x20create_time\x20>=\x20\x27','call','dailyDealEventSegPvAndUv','pvFormat','256nNSRzU','diff','eventId\x20IN\x20(:...eventIds)','find','create\x20table\x20','startDailyStatistics','6LgegIZ','insert','__esModule','STS_EVENT_TABLE','../../shared/utils/time.utils','\x27)]\x20=\x20\x27','orIgnore','object','segStatus','createEntity','../entity/event.seg.info.entity','updateTime','../dto/event.seg.value.sts.rsp.dto','eventId','calPercentFormat','list','crypto-js','UNREGISTERED','../../shared/service/clickhouse/clickhouse.service','appTimeZone','Logger','clearDailyData'];_0x4668=function(){return _0x499848;};return _0x4668();}Object[_0x470e4c(0x1bf)](exports,_0x470e4c(0x243),{'value':!![]}),exports[_0x470e4c(0x19e)]=void 0x0;const table_constant_1=require(_0x470e4c(0x1a8)),entity_factory_1=require('../../shared/entity/entity.factory'),base_service_1=require(_0x470e4c(0x213)),clickhouse_service_1=require(_0x470e4c(0x253)),time_utils_1=require(_0x470e4c(0x245)),common_1=require(_0x470e4c(0x227)),dayjs_1=__importDefault(require('dayjs')),typeorm_1=require('typeorm'),sts_event_entity_1=require(_0x470e4c(0x21c)),sts_event_segment_entity_1=require(_0x470e4c(0x1d5)),obj_utils_1=require(_0x470e4c(0x19d)),event_info_entity_1=require(_0x470e4c(0x233)),event_status_1=require(_0x470e4c(0x1e9)),event_seg_info_entity_1=require(_0x470e4c(0x24b)),date_constant_1=require(_0x470e4c(0x20e)),CryptoJS=__importStar(require(_0x470e4c(0x251))),event_info_list_rsp_dto_1=require(_0x470e4c(0x19a)),event_seg_info_list_rsp_dto_1=require(_0x470e4c(0x1d7)),event_sts_rsp_dto_1=require(_0x470e4c(0x1f9)),event_seg_sts_rsp_dto_1=require('../dto/event.seg.sts.rsp.dto'),cal_utils_1=require('../../shared/utils/cal.utils'),xlxs_utils_1=require(_0x470e4c(0x231)),sts_uv_pv_rsp_dto_1=require(_0x470e4c(0x1f2)),event_seg_value_sts_rsp_dto_1=require(_0x470e4c(0x24d));let EventService=EventService_1=class EventService extends base_service_1[_0x470e4c(0x22a)]{constructor(_0x26b189,_0xb66b2f,_0xadc94d){const _0x43c0e1=_0x470e4c;super(),this[_0x43c0e1(0x1fa)]=_0x26b189,this[_0x43c0e1(0x1ea)]=_0xb66b2f,this[_0x43c0e1(0x1f0)]=_0xadc94d,this[_0x43c0e1(0x1a7)]=new common_1[(_0x43c0e1(0x255))](EventService_1['name']),this[_0x43c0e1(0x1ef)]=[_0x43c0e1(0x182),'',_0x43c0e1(0x1a9)];}async['eventInfoList'](_0x333356){const _0x2be1b8=_0x470e4c;let _0x2190e7=[];((0x0,obj_utils_1[_0x2be1b8(0x206)])(_0x333356[_0x2be1b8(0x1a2)])||_0x333356['eventStatus']==event_status_1[_0x2be1b8(0x191)]['UNREGISTERED'])&&(_0x2190e7=await this['getUnRegisteredEventIds'](_0x333356[_0x2be1b8(0x1d8)]));let _0x4953c3=await this['getEventInfoEntityList'](_0x333356[_0x2be1b8(0x1d8)],_0x333356['eventStatus']);_0x4953c3=_0x4953c3[_0x2be1b8(0x236)](_0x2190e7[_0x2be1b8(0x1cd)](_0x209716=>{const _0x439450=_0x2be1b8,_0x2d8d08=new event_info_entity_1[(_0x439450(0x1f4))]();return _0x2d8d08[_0x439450(0x24e)]=_0x209716,_0x2d8d08[_0x439450(0x216)]='',_0x2d8d08[_0x439450(0x265)]='',_0x2d8d08['updateTime']=new Date(),_0x2d8d08;}));const _0x1c9693=(0x0,dayjs_1[_0x2be1b8(0x1b1)])(),_0xa0da4f=_0x4953c3[_0x2be1b8(0x1cd)](_0x25f3ee=>{const _0x5c6bb4=_0x2be1b8,_0x4a7d32=new event_info_list_rsp_dto_1[(_0x5c6bb4(0x25b))]();return _0x4a7d32['eventId']=_0x25f3ee[_0x5c6bb4(0x24e)],_0x4a7d32[_0x5c6bb4(0x216)]=_0x25f3ee[_0x5c6bb4(0x216)],_0x4a7d32[_0x5c6bb4(0x265)]=_0x25f3ee[_0x5c6bb4(0x265)],_0x4a7d32['active']=_0x1c9693[_0x5c6bb4(0x23c)]((0x0,dayjs_1[_0x5c6bb4(0x1b1)])(_0x25f3ee['updateTime']),_0x5c6bb4(0x184))<0x7,_0x4a7d32;});return this[_0x2be1b8(0x1b8)](_0xa0da4f);}async[_0x470e4c(0x235)](_0xe4668a){const _0x49f90b=_0x470e4c;let _0x32de74=[];((0x0,obj_utils_1[_0x49f90b(0x206)])(_0xe4668a[_0x49f90b(0x249)])||_0xe4668a[_0x49f90b(0x249)]==event_status_1['EventStatus'][_0x49f90b(0x252)])&&(_0x32de74=await this[_0x49f90b(0x1b3)](_0xe4668a[_0x49f90b(0x1d8)],_0xe4668a[_0x49f90b(0x24e)]));let _0x31010c=await this[_0x49f90b(0x224)](_0xe4668a[_0x49f90b(0x1d8)],_0xe4668a['eventId'],_0xe4668a[_0x49f90b(0x249)]);_0x31010c=_0x31010c[_0x49f90b(0x236)](_0x32de74['map'](_0x249120=>{const _0x38bccb=_0x49f90b,_0x442be3=new event_seg_info_entity_1[(_0x38bccb(0x219))]();return _0x442be3['eventId']=_0xe4668a[_0x38bccb(0x24e)],_0x442be3[_0x38bccb(0x266)]=_0x249120,_0x442be3[_0x38bccb(0x1e2)]='',_0x442be3[_0x38bccb(0x24c)]=new Date(),_0x442be3;}));const _0x3641aa=(0x0,dayjs_1[_0x49f90b(0x1b1)])(),_0x8b5e9b=_0x31010c[_0x49f90b(0x1cd)](_0x3fa1e0=>{const _0x522adc=_0x49f90b,_0x22cf53=new event_seg_info_list_rsp_dto_1[(_0x522adc(0x1c1))]();return _0x22cf53[_0x522adc(0x266)]=_0x3fa1e0[_0x522adc(0x266)],_0x22cf53[_0x522adc(0x1e2)]=_0x3fa1e0[_0x522adc(0x1e2)],_0x22cf53[_0x522adc(0x18a)]=_0x3641aa['diff']((0x0,dayjs_1['default'])(_0x3fa1e0['updateTime']),'days')<0x7,_0x22cf53;});return this['responseSuccess'](_0x8b5e9b);}async[_0x470e4c(0x201)](_0x75e500){const _0x36d253=_0x470e4c,{startTime:_0x3e469d,endTime:_0x2de8f2}=(0x0,time_utils_1[_0x36d253(0x1e6)])(0x1);let _0x2d3493=await this[_0x36d253(0x18f)](_0x75e500,_0x3e469d,_0x2de8f2);const _0x17d9ea=await this['getEventInfoEntityList'](_0x75e500),_0x10c99a=_0x17d9ea[_0x36d253(0x1cd)](_0x5522b9=>_0x5522b9[_0x36d253(0x24e)]),_0x39a764=_0x2d3493[_0x36d253(0x18c)](_0x22e803=>!_0x10c99a[_0x36d253(0x1d6)](_0x22e803));return _0x39a764;}async['getUnRegisteredEventSegIds'](_0x3ee086,_0x4ad326){const _0x2f1119=_0x470e4c,{startTime:_0x37b087,endTime:_0x41ece1}=(0x0,time_utils_1[_0x2f1119(0x1e6)])(0x1),_0x2aa572=await this[_0x2f1119(0x18e)](_0x3ee086,_0x37b087,_0x41ece1,_0x4ad326),_0x861f8c=await this['getEventSegInfoEntityList'](_0x3ee086,_0x4ad326),_0x434948=_0x861f8c[_0x2f1119(0x1cd)](_0x4776b9=>_0x4776b9['id']),_0x540ace=_0x2aa572[_0x2f1119(0x18c)](_0x5e89be=>!_0x434948['includes'](_0x5e89be['id']))['map'](_0xfdca=>_0xfdca[_0x2f1119(0x266)]);return _0x540ace;}async['editEventInfo'](_0x15b110){const _0x396ea2=_0x470e4c;let _0x5cde08=[];const _0x5d4a3d=_0x15b110[_0x396ea2(0x250)][_0x396ea2(0x1cd)](_0x3ccea6=>{const _0x21ccfe=_0x396ea2;_0x5cde08=_0x5cde08[_0x21ccfe(0x236)](Object[_0x21ccfe(0x186)](_0x3ccea6));const _0x2623ff=new event_info_entity_1[(_0x21ccfe(0x1f4))]();return _0x2623ff['id']=this[_0x21ccfe(0x196)](_0x15b110[_0x21ccfe(0x1d8)]+_0x3ccea6[_0x21ccfe(0x24e)]),_0x2623ff[_0x21ccfe(0x1d8)]=_0x15b110[_0x21ccfe(0x1d8)],Object['assign'](_0x2623ff,_0x3ccea6),_0x2623ff;});_0x5cde08=[...new Set(_0x5cde08)][_0x396ea2(0x18c)](_0x1a96ce=>_0x1a96ce!==_0x396ea2(0x24e))[_0x396ea2(0x1cd)](_0xc1627e=>(0x0,obj_utils_1['humpToUnderline'])(_0xc1627e));if((0x0,obj_utils_1['isEmpty'])(_0x5d4a3d)||(0x0,obj_utils_1[_0x396ea2(0x206)])(_0x5cde08))return this[_0x396ea2(0x1b8)](!![]);return await this['saveOrUpdateEventInfo'](_0x5d4a3d,_0x5cde08),this[_0x396ea2(0x1b8)](!![]);}async[_0x470e4c(0x1b6)](_0x339114){const _0x41a8db=_0x470e4c;let _0x1d218e=[];const _0x5ccdb6=_0x339114[_0x41a8db(0x250)][_0x41a8db(0x1cd)](_0xa35810=>{const _0x391d89=_0x41a8db;_0x1d218e=_0x1d218e[_0x391d89(0x236)](Object[_0x391d89(0x186)](_0xa35810));const _0x3be130=new event_seg_info_entity_1[(_0x391d89(0x219))]();return _0x3be130['id']=this[_0x391d89(0x196)](_0x339114[_0x391d89(0x1d8)]+_0x339114[_0x391d89(0x24e)]+_0xa35810[_0x391d89(0x266)]),_0x3be130[_0x391d89(0x1d8)]=_0x339114[_0x391d89(0x1d8)],_0x3be130[_0x391d89(0x24e)]=_0x339114['eventId'],Object[_0x391d89(0x1fc)](_0x3be130,_0xa35810),_0x3be130;});_0x1d218e=[...new Set(_0x1d218e)][_0x41a8db(0x18c)](_0x3dd17f=>_0x3dd17f!==_0x41a8db(0x266))[_0x41a8db(0x1cd)](_0x390192=>(0x0,obj_utils_1['humpToUnderline'])(_0x390192));if((0x0,obj_utils_1['isEmpty'])(_0x5ccdb6)||(0x0,obj_utils_1[_0x41a8db(0x206)])(_0x1d218e))return this[_0x41a8db(0x1b8)](!![]);return await this[_0x41a8db(0x1b2)](_0x5ccdb6,_0x1d218e),this[_0x41a8db(0x1b8)](!![]);}async['eventStsList'](_0x5a441e){const _0x48d656=_0x470e4c,_0x34e6df=JSON[_0x48d656(0x232)](_0x5a441e[_0x48d656(0x214)]),_0x1a0b12=(0x0,time_utils_1[_0x48d656(0x22d)])(_0x34e6df[0x0]),{stsStartTime:_0x394a88,stsEndTime:_0x53e359,startTime:_0x4a3693,endTime:_0x1f2632}=(0x0,time_utils_1['getStartAndEndTime'])(_0x5a441e['period']);let _0x1c4606=await this['getEventsPvAndUvFromDetail'](_0x5a441e['appId'],_0x4a3693,_0x1f2632),_0x2f1655={};!_0x1a0b12&&(_0x2f1655=await this[_0x48d656(0x1e4)](_0x5a441e[_0x48d656(0x1d8)],_0x5a441e[_0x48d656(0x1fe)],date_constant_1[_0x48d656(0x263)][_0x48d656(0x195)],_0x394a88,_0x53e359));const _0x31fdb8=_0x5a441e[_0x48d656(0x1fe)][_0x48d656(0x1cd)](_0xca78e2=>{const _0x380de7=_0x48d656,_0x1df33d=_0x1c4606[_0xca78e2],_0x3d7d21=_0x2f1655[_0xca78e2]||[],_0x5ca1c0=new event_sts_rsp_dto_1[(_0x380de7(0x199))]();_0x5ca1c0[_0x380de7(0x24e)]=_0xca78e2;!(0x0,obj_utils_1['isEmpty'])(_0x1df33d)&&(_0x5ca1c0['uv']=Number(_0x1df33d['uv']),_0x5ca1c0['pv']=Number(_0x1df33d['pv']),_0x5ca1c0[_0x380de7(0x1fb)]=Number(_0x1df33d[_0x380de7(0x1fb)]));!(0x0,obj_utils_1[_0x380de7(0x206)])(_0x3d7d21)&&(_0x5ca1c0['pv']=_0x3d7d21[_0x380de7(0x21a)]((_0x5ed966,_0x193787)=>_0x5ed966+Number(_0x193787['pv']),0x0),_0x5ca1c0[_0x380de7(0x1fb)]=_0x3d7d21['reduce']((_0x26fa2f,_0x55aab4)=>_0x26fa2f+Number(_0x55aab4['newUv']),0x0));const _0x4283bf=_0x3d7d21[_0x380de7(0x21a)]((_0x196c6c,_0x403633)=>{const _0x4a4852=_0x380de7,_0x53550d=(0x0,time_utils_1[_0x4a4852(0x229)])(_0x403633[_0x4a4852(0x1eb)],date_constant_1[_0x4a4852(0x1db)]);return _0x196c6c[_0x53550d]=_0x403633,_0x196c6c;},{}),_0x2bc3ad=(0x0,time_utils_1[_0x380de7(0x223)])(_0x5a441e['period']),_0x3a7f48=_0x2bc3ad[_0x380de7(0x1cd)](_0x58d0d1=>{const _0x32a8e7=_0x380de7,_0x2ea9db=_0x4283bf[_0x58d0d1],_0x2148ba=new event_sts_rsp_dto_1[(_0x32a8e7(0x1a5))]();return _0x2148ba['id']=_0x58d0d1,_0x2148ba['pv']=_0x2ea9db?_0x2ea9db['pv']:0x0,_0x2148ba['uv']=_0x2ea9db?_0x2ea9db['uv']:0x0,_0x2148ba[_0x32a8e7(0x1fb)]=_0x2ea9db?_0x2ea9db[_0x32a8e7(0x1fb)]:0x0,_0x2148ba;});return _0x5ca1c0[_0x380de7(0x250)]=_0x3a7f48,_0x5ca1c0;});return this[_0x48d656(0x1b8)](_0x31fdb8);}async[_0x470e4c(0x181)](_0x1f7045){const _0x29369e=_0x470e4c,{stsStartTime:_0x52d15e,stsEndTime:_0x390b71,startTime:_0x2d4627,endTime:_0x9d29cb}=(0x0,time_utils_1[_0x29369e(0x260)])(_0x1f7045[_0x29369e(0x214)]);function _0x2b22f9(_0x383f00,_0xd1b61a){const _0x41dc39=_0x29369e;return _0x383f00['where']('event_id\x20=\x20:eventId',{'eventId':_0xd1b61a['eventId']})[_0x41dc39(0x1c8)](_0x41dc39(0x1e8),{'type':date_constant_1[_0x41dc39(0x263)][_0x41dc39(0x195)]})[_0x41dc39(0x1c8)](_0x41dc39(0x1b4),{'segId':_0xd1b61a[_0x41dc39(0x266)]})[_0x41dc39(0x1c8)]('start_time\x20>=\x20:startTime',{'startTime':_0x52d15e})[_0x41dc39(0x1c8)]('start_time\x20<=\x20:endTime',{'endTime':_0x390b71}),_0xd1b61a[_0x41dc39(0x1b0)]&&_0x383f00[_0x41dc39(0x1c8)](_0x41dc39(0x209),{'key':'%'+_0xd1b61a[_0x41dc39(0x1b0)]+'%'}),_0x383f00;}const _0x47d31c=table_constant_1[_0x29369e(0x244)]+'_'+_0x1f7045[_0x29369e(0x1d8)],_0x51fece=table_constant_1['STS_EVENT_SEG_TABLE']+'_'+_0x1f7045['appId'],_0x29208e=table_constant_1[_0x29369e(0x185)]+'_'+_0x1f7045[_0x29369e(0x1d8)],_0x5e6f29=this[_0x29369e(0x1f0)][_0x29369e(0x24a)](sts_event_entity_1[_0x29369e(0x1da)],_0x47d31c),_0x36a393=this[_0x29369e(0x1f0)][_0x29369e(0x24a)](sts_event_segment_entity_1[_0x29369e(0x1a1)],_0x51fece),_0xc6b7d0=_0x36a393[_0x29369e(0x212)]()[_0x29369e(0x1a3)](_0x29369e(0x22c)),_0x3dc582=await _0x2b22f9(_0xc6b7d0,_0x1f7045)[_0x29369e(0x221)](),_0x2b70fb=_0x3dc582['t']||0x0,_0x70242c=await _0x5e6f29[_0x29369e(0x212)]()[_0x29369e(0x1a3)]('SUM(pv)\x20as\x20pv')['where']('event_id\x20=\x20:eventId',{'eventId':_0x1f7045[_0x29369e(0x24e)]})[_0x29369e(0x1c8)](_0x29369e(0x1e8),{'type':date_constant_1[_0x29369e(0x263)][_0x29369e(0x195)]})[_0x29369e(0x1c8)](_0x29369e(0x1c2),{'startTime':_0x52d15e})[_0x29369e(0x1c8)](_0x29369e(0x205),{'endTime':_0x390b71})['getRawOne'](),_0x32c6f2=_0x70242c['pv']||0x0,{uv:_0x59487e,newUv:_0x45581a}=await this['getEventUv'](_0x1f7045['appId'],_0x1f7045['eventId'],_0x2d4627,_0x9d29cb);let _0x435b8b=_0x36a393[_0x29369e(0x212)]()['select'](_0x29369e(0x192))[_0x29369e(0x207)]('seg_value')[_0x29369e(0x1bd)]('pv',_0x29369e(0x1e1));_0x435b8b=_0x2b22f9(_0x435b8b,_0x1f7045);!_0x1f7045[_0x29369e(0x211)]&&_0x435b8b[_0x29369e(0x25f)]((_0x1f7045[_0x29369e(0x218)]-0x1)*_0x1f7045[_0x29369e(0x22e)])[_0x29369e(0x215)](_0x1f7045[_0x29369e(0x22e)]);const _0x22e1a8=await _0x435b8b[_0x29369e(0x1e5)](),_0x33a76d=_0x29369e(0x210)+_0x1f7045[_0x29369e(0x266)]+'\x27)]\x20AS\x20id,\x20\x0a\x20\x20\x20\x20\x20\x20uniqExact(device_no)\x20uv,\x0a\x20\x20\x20\x20\x20\x20uniqExact(CASE\x20WHEN\x20is_new_user\x20=\x201\x20THEN\x20device_no\x20ELSE\x20NULL\x20END)\x20AS\x20newUv\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+_0x29208e+'\x0a\x20\x20\x20\x20\x20\x20WHERE\x20event_id\x20=\x20\x27'+_0x1f7045[_0x29369e(0x24e)]+_0x29369e(0x237)+_0x2d4627+_0x29369e(0x180)+_0x9d29cb+_0x29369e(0x202),_0x1d23f5=await this['clickhouse'][_0x29369e(0x1c3)](_0x33a76d),_0x2b90b3=_0x1d23f5[_0x29369e(0x21a)]((_0x1cb322,_0x3400c9)=>{return _0x1cb322[_0x3400c9['id']]=_0x3400c9,_0x1cb322;},{}),_0x4d5091=_0x22e1a8[_0x29369e(0x1cd)](_0x2306c4=>{const _0x9ea3b8=_0x29369e,_0xdf1365=_0x2b90b3[_0x2306c4['id']],_0x36a6ee=new event_seg_sts_rsp_dto_1['EventSegStsItemRspDto']();return _0x36a6ee['id']=_0x2306c4['id'],_0x36a6ee['pv']=Number(_0x2306c4['pv']),_0x36a6ee['uv']=_0xdf1365?Number(_0xdf1365['uv']):0x0,_0x36a6ee[_0x9ea3b8(0x1fb)]=_0xdf1365?Number(_0xdf1365['newUv']):0x0,_0x36a6ee[_0x9ea3b8(0x1b5)]=(0x0,cal_utils_1[_0x9ea3b8(0x20d)])(_0x36a6ee['pv'],_0x36a6ee['uv']),_0x36a6ee[_0x9ea3b8(0x23a)]=_0x36a6ee['pv']+'('+(0x0,cal_utils_1[_0x9ea3b8(0x24f)])(_0x36a6ee['pv'],Number(_0x32c6f2))+')',_0x36a6ee['uvFormat']=_0x36a6ee['uv']+'('+(0x0,cal_utils_1[_0x9ea3b8(0x24f)])(_0x36a6ee['uv'],Number(_0x59487e))+')',_0x36a6ee[_0x9ea3b8(0x1e0)]=_0x36a6ee['newUv']+'('+(0x0,cal_utils_1[_0x9ea3b8(0x24f)])(_0x36a6ee[_0x9ea3b8(0x1fb)],Number(_0x45581a))+')',_0x36a6ee;});if(_0x1f7045[_0x29369e(0x211)]){const _0x4cf253=await(0x0,xlxs_utils_1['exportXlsx'])(_0x4d5091,['id','pv','uv',_0x29369e(0x1fb),_0x29369e(0x23a),_0x29369e(0x1e7),_0x29369e(0x1e0),_0x29369e(0x1b5)]);return _0x4cf253;}const _0x482c7c=new event_seg_sts_rsp_dto_1[(_0x29369e(0x264))]();return _0x482c7c[_0x29369e(0x189)]=Number(_0x2b70fb),_0x482c7c[_0x29369e(0x250)]=_0x4d5091,_0x482c7c['pv']=Number(_0x32c6f2),_0x482c7c['uv']=Number(_0x59487e),_0x482c7c[_0x29369e(0x1fb)]=Number(_0x45581a),this[_0x29369e(0x1b8)](_0x482c7c);}async[_0x470e4c(0x21b)](_0x1e340d){const _0x31c490=_0x470e4c,{stsStartTime:_0x50c665,stsEndTime:_0x14f39d,startTime:_0x252e77,endTime:_0x4df97c}=(0x0,time_utils_1[_0x31c490(0x260)])(_0x1e340d[_0x31c490(0x214)]),_0x5a025b=table_constant_1[_0x31c490(0x1ca)]+'_'+_0x1e340d[_0x31c490(0x1d8)],_0x172f12=this['entityFactory'][_0x31c490(0x24a)](sts_event_segment_entity_1[_0x31c490(0x1a1)],_0x5a025b),_0x320d8b=await _0x172f12[_0x31c490(0x212)]()[_0x31c490(0x1a3)]()['where']('event_id\x20=\x20:eventId',{'eventId':_0x1e340d['eventId']})[_0x31c490(0x1c8)]('type\x20=\x20:type',{'type':date_constant_1['DateUnit']['DAY']})[_0x31c490(0x1c8)]('seg_id\x20=\x20:segId',{'segId':_0x1e340d[_0x31c490(0x266)]})['andWhere']('seg_value\x20=\x20:segValue',{'segValue':_0x1e340d[_0x31c490(0x21f)]})[_0x31c490(0x1c8)](_0x31c490(0x1c2),{'startTime':_0x50c665})['andWhere'](_0x31c490(0x205),{'endTime':_0x14f39d})['getMany'](),_0x5de3cb=_0x320d8b[_0x31c490(0x21a)]((_0x53aaa3,_0x491152)=>{const _0x669739=_0x31c490,_0x5bf3c7=(0x0,time_utils_1[_0x669739(0x229)])(_0x491152[_0x669739(0x1eb)],date_constant_1[_0x669739(0x1db)]);return _0x53aaa3[_0x5bf3c7]=_0x491152,_0x53aaa3;},{}),_0x36902a=(0x0,time_utils_1[_0x31c490(0x223)])(_0x1e340d['period']),_0x249d90=_0x36902a[_0x31c490(0x1cd)](_0x23165f=>{const _0xa7ec76=_0x31c490,_0x15777e=_0x5de3cb[_0x23165f],_0x66a1fe=new sts_uv_pv_rsp_dto_1['StsUvAndPvRspDto']();return _0x66a1fe['pv']=_0x15777e?_0x15777e['pv']:0x0,_0x66a1fe['uv']=_0x15777e?_0x15777e['uv']:0x0,_0x66a1fe[_0xa7ec76(0x1fb)]=_0x15777e?_0x15777e['newUv']:0x0,_0x66a1fe;}),_0xef1310=_0x320d8b[_0x31c490(0x21a)]((_0x2fabf7,_0x266c42)=>_0x2fabf7+Number(_0x266c42['pv']),0x0),{uv:_0x131b22,newUv:_0xafd74e}=await this[_0x31c490(0x1dc)](_0x1e340d[_0x31c490(0x1d8)],_0x1e340d['eventId'],_0x1e340d[_0x31c490(0x266)],_0x1e340d[_0x31c490(0x21f)],_0x252e77,_0x4df97c),_0x5cc18c=new event_seg_value_sts_rsp_dto_1[(_0x31c490(0x259))]();return _0x5cc18c['pv']=_0xef1310,_0x5cc18c['uv']=_0x131b22,_0x5cc18c[_0x31c490(0x1fb)]=_0xafd74e,_0x5cc18c[_0x31c490(0x250)]=_0x249d90,this[_0x31c490(0x1b8)](_0x5cc18c);}async[_0x470e4c(0x240)](_0x3bcad2,_0x1639bd,_0x449579){const _0xe2b50d=_0x470e4c,_0x4799b6=_0x449579[_0xe2b50d(0x23e)](_0x278e09=>_0x278e09['type']==date_constant_1[_0xe2b50d(0x263)][_0xe2b50d(0x195)]);await this['dailyDealEventInfo'](_0x3bcad2,_0x4799b6),await this[_0xe2b50d(0x1bb)](_0x3bcad2,_0x4799b6);for(const _0x47da2a of _0x449579){await this[_0xe2b50d(0x261)](_0x3bcad2,_0x47da2a),await this[_0xe2b50d(0x239)](_0x3bcad2,_0x47da2a);}}async[_0x470e4c(0x19f)](_0x571bee,_0x5adc34){const _0x4f1035=_0x470e4c,_0x286cf1=await this[_0x4f1035(0x18f)](_0x571bee,_0x5adc34[_0x4f1035(0x228)],_0x5adc34[_0x4f1035(0x18b)]);if((0x0,obj_utils_1[_0x4f1035(0x206)])(_0x286cf1))return;const _0x5c8a79=await this[_0x4f1035(0x1c9)](_0x571bee),_0x17ba5f=_0x5c8a79['map'](_0x1d4426=>_0x1d4426[_0x4f1035(0x24e)]),_0x1b9f07=_0x286cf1[_0x4f1035(0x18c)](_0x1449ef=>_0x17ba5f[_0x4f1035(0x1d6)](_0x1449ef));!(0x0,obj_utils_1[_0x4f1035(0x206)])(_0x1b9f07)&&await this[_0x4f1035(0x1c0)](_0x571bee,_0x1b9f07,new Date(_0x5adc34['endTimeString']));const _0x182355=_0x286cf1[_0x4f1035(0x18c)](_0x38f8cf=>!_0x17ba5f[_0x4f1035(0x1d6)](_0x38f8cf));if((0x0,obj_utils_1[_0x4f1035(0x206)])(_0x182355))return;const _0x16099f=_0x182355[_0x4f1035(0x1cd)](_0x119a09=>{const _0x51a417=_0x4f1035,_0x3ba6a1=new event_info_entity_1[(_0x51a417(0x1f4))]();return _0x3ba6a1['id']=this[_0x51a417(0x196)](_0x571bee+_0x119a09),_0x3ba6a1[_0x51a417(0x1d8)]=_0x571bee,_0x3ba6a1['eventId']=_0x119a09,_0x3ba6a1;});await this['saveOrIgnoreEventInfo'](_0x16099f);}async[_0x470e4c(0x1bb)](_0x47d584,_0x975393){const _0x53aaa1=_0x470e4c,_0x230d2f=await this[_0x53aaa1(0x18e)](_0x47d584,_0x975393[_0x53aaa1(0x228)],_0x975393[_0x53aaa1(0x18b)]);if((0x0,obj_utils_1[_0x53aaa1(0x206)])(_0x230d2f))return;let _0x703217=_0x230d2f['map'](_0x319848=>_0x319848['id']);const _0x5d6cf9=await this['getEventSegInfoEntityList'](_0x47d584);let _0x4e3e27=_0x5d6cf9[_0x53aaa1(0x1cd)](_0x132e5f=>_0x132e5f['id']);const _0x447718=_0x703217[_0x53aaa1(0x18c)](_0x565f59=>_0x4e3e27['includes'](_0x565f59));!(0x0,obj_utils_1['isEmpty'])(_0x447718)&&await this[_0x53aaa1(0x234)](_0x447718,new Date(_0x975393[_0x53aaa1(0x18b)]));const _0x2ca66f=_0x230d2f['filter'](_0x3bd257=>!_0x4e3e27[_0x53aaa1(0x1d6)](_0x3bd257['id']));!(0x0,obj_utils_1[_0x53aaa1(0x206)])(_0x2ca66f)&&await this[_0x53aaa1(0x1a4)](_0x2ca66f);}async[_0x470e4c(0x261)](_0x307f1b,_0xf73f4){const _0x40d35d=_0x470e4c,_0x4fd7ad=await this[_0x40d35d(0x19c)](_0x307f1b,_0xf73f4[_0x40d35d(0x228)],_0xf73f4[_0x40d35d(0x18b)]),_0x41bdcd=await this['getEventInfoEntityList'](_0x307f1b,event_status_1[_0x40d35d(0x191)][_0x40d35d(0x21e)]);if((0x0,obj_utils_1[_0x40d35d(0x206)])(_0x41bdcd))return;const _0x4f7562=_0x41bdcd[_0x40d35d(0x1cd)](_0x2ada89=>_0x4fd7ad[_0x2ada89[_0x40d35d(0x24e)]])[_0x40d35d(0x18c)](_0x473cc2=>!(0x0,obj_utils_1[_0x40d35d(0x206)])(_0x473cc2))[_0x40d35d(0x1cd)](_0x24958a=>{const _0x49b938=_0x40d35d,_0x2d76b7=new sts_event_entity_1['StsEventEntity'](_0xf73f4);return _0x2d76b7[_0x49b938(0x1d8)]=_0x307f1b,_0x2d76b7[_0x49b938(0x24e)]=_0x24958a[_0x49b938(0x24e)],_0x2d76b7['pv']=Number(_0x24958a['pv']),_0x2d76b7['uv']=Number(_0x24958a['uv']),_0x2d76b7[_0x49b938(0x1fb)]=Number(_0x24958a['newUv']),_0x2d76b7;}),_0x50115c=table_constant_1[_0x40d35d(0x244)]+'_'+_0x307f1b;if(_0x4f7562[_0x40d35d(0x1ac)]!=0x0){const _0x48844e=this[_0x40d35d(0x1f0)][_0x40d35d(0x24a)](sts_event_entity_1[_0x40d35d(0x1da)],_0x50115c);await _0x48844e[_0x40d35d(0x212)]()[_0x40d35d(0x242)]()[_0x40d35d(0x1c4)](sts_event_entity_1[_0x40d35d(0x1da)])[_0x40d35d(0x1d9)](_0x4f7562)[_0x40d35d(0x1e5)]();}}async[_0x470e4c(0x239)](_0x4c3f6c,_0x290c32){const _0x2917d3=_0x470e4c,_0xe37299=table_constant_1[_0x2917d3(0x185)]+'_'+_0x4c3f6c,_0x11e19d=table_constant_1[_0x2917d3(0x1ca)]+'_'+_0x4c3f6c,_0x30615d=_0x2917d3(0x1f8)+_0xe37299+_0x2917d3(0x25c)+_0x290c32[_0x2917d3(0x228)]+_0x2917d3(0x180)+_0x290c32[_0x2917d3(0x18b)]+_0x2917d3(0x1ae),_0x56b4ce=await this[_0x2917d3(0x1fa)][_0x2917d3(0x1c3)](_0x30615d);if((0x0,obj_utils_1[_0x2917d3(0x206)])(_0x56b4ce))return;const _0x55aca9=await this[_0x2917d3(0x1c9)](_0x4c3f6c,event_status_1[_0x2917d3(0x191)][_0x2917d3(0x21e)]),_0x1853a9=_0x55aca9[_0x2917d3(0x1cd)](_0x378a83=>_0x378a83[_0x2917d3(0x24e)]),_0x5dc26a=_0x56b4ce[_0x2917d3(0x18c)](_0x13229e=>_0x1853a9[_0x2917d3(0x1d6)](_0x13229e[_0x2917d3(0x24e)])&&!(0x0,obj_utils_1['isEmpty'])(_0x13229e[_0x2917d3(0x18d)])),_0x42ecfa=[];for(const _0x1a66e8 of _0x5dc26a){const _0x2f0cc8=_0x1a66e8[_0x2917d3(0x24e)],_0x1442ff=await this['getEventSegInfoEntityList'](_0x4c3f6c,_0x2f0cc8,event_status_1[_0x2917d3(0x191)][_0x2917d3(0x21e)]),_0xe66036=_0x1442ff['map'](_0x1f2a5=>_0x1f2a5[_0x2917d3(0x266)]),_0x424591=_0x1a66e8[_0x2917d3(0x18d)][_0x2917d3(0x18c)](_0x1084b8=>_0xe66036[_0x2917d3(0x1d6)](_0x1084b8));for(const _0x1488c7 of _0x424591){const _0x37382f=_0x2917d3(0x1f6)+_0x1488c7+_0x2917d3(0x1be)+_0xe37299+_0x2917d3(0x225)+_0x2f0cc8+_0x2917d3(0x237)+_0x290c32[_0x2917d3(0x228)]+_0x2917d3(0x180)+_0x290c32[_0x2917d3(0x18b)]+_0x2917d3(0x1cc),_0x4302f6=await this['clickhouse']['query'](_0x37382f);_0x4302f6[_0x2917d3(0x203)](_0x8dbff1=>{const _0xbb5418=_0x2917d3;if(!this[_0xbb5418(0x1ef)][_0xbb5418(0x1d6)](_0x8dbff1[_0xbb5418(0x21f)])){const _0x4bb0b9=new sts_event_segment_entity_1[(_0xbb5418(0x1a1))](_0x290c32);_0x4bb0b9['appId']=_0x4c3f6c,_0x4bb0b9[_0xbb5418(0x24e)]=_0x2f0cc8,_0x4bb0b9[_0xbb5418(0x266)]=_0x1488c7,_0x4bb0b9['segValue']=_0x8dbff1['segValue'],_0x4bb0b9['pv']=Number(_0x8dbff1['pv']),_0x4bb0b9['uv']=Number(_0x8dbff1['uv']),_0x4bb0b9[_0xbb5418(0x1fb)]=Number(_0x8dbff1[_0xbb5418(0x1fb)]),_0x42ecfa[_0xbb5418(0x19b)](_0x4bb0b9);}});}}if(_0x42ecfa[_0x2917d3(0x1ac)]!==0x0){const _0x2bcbe2=this['entityFactory'][_0x2917d3(0x24a)](sts_event_segment_entity_1[_0x2917d3(0x1a1)],_0x11e19d);await _0x2bcbe2[_0x2917d3(0x212)]()[_0x2917d3(0x242)]()['into'](sts_event_segment_entity_1[_0x2917d3(0x1a1)])[_0x2917d3(0x1d9)](_0x42ecfa)[_0x2917d3(0x1e5)]();}}async[_0x470e4c(0x19c)](_0x4eb3c3,_0x390472,_0x5df22){const _0x5d4eba=_0x470e4c,_0x22537d=table_constant_1[_0x5d4eba(0x185)]+'_'+_0x4eb3c3,_0x2473ba=_0x5d4eba(0x1d4)+_0x22537d+_0x5d4eba(0x25c)+_0x390472+'\x27\x20AND\x20create_time\x20<=\x20\x27'+_0x5df22+_0x5d4eba(0x1ae),_0x5dfb08=await this['clickhouse'][_0x5d4eba(0x1c3)](_0x2473ba),_0x2888ac=_0x5dfb08[_0x5d4eba(0x21a)]((_0x101455,_0x1c910c)=>{return _0x101455[_0x1c910c['eventId']]=_0x1c910c,_0x101455;},{});return _0x2888ac;}async[_0x470e4c(0x1dd)](_0x42bdf7,_0x5ab45d,_0x4c1d04,_0x302f85){const _0x4c3c24=_0x470e4c,_0x40501d=table_constant_1['EVENT_TABLE']+'_'+_0x42bdf7,_0x3c8760=_0x4c3c24(0x1df)+_0x40501d+_0x4c3c24(0x225)+_0x5ab45d+_0x4c3c24(0x237)+_0x4c1d04+'\x27\x20AND\x20create_time\x20<=\x20\x27'+_0x302f85+'\x27',_0x6b6406=await this[_0x4c3c24(0x1fa)][_0x4c3c24(0x1a6)](_0x3c8760),_0x2b6ba5=Number(_0x6b6406['uv']),_0x36df84=Number(_0x6b6406[_0x4c3c24(0x1fb)]);return{'uv':_0x2b6ba5,'newUv':_0x36df84};}async[_0x470e4c(0x1dc)](_0x529344,_0x4c049d,_0x53bf38,_0x2d4223,_0x20ba36,_0xe0ccec){const _0x235df5=_0x470e4c,_0x135c1e=table_constant_1['EVENT_TABLE']+'_'+_0x529344,_0x1d9a80=_0x235df5(0x1df)+_0x135c1e+_0x235df5(0x220)+_0x4c049d+_0x235df5(0x1e3)+_0x53bf38+_0x235df5(0x246)+_0x2d4223+'\x27\x20\x0a\x20\x20\x20\x20AND\x20create_time\x20>=\x20\x27'+_0x20ba36+'\x27\x20AND\x20create_time\x20<=\x20\x27'+_0xe0ccec+'\x27',_0x1b3f4b=await this[_0x235df5(0x1fa)]['singleQuery'](_0x1d9a80),_0x28bf87=Number(_0x1b3f4b['uv']),_0x37669c=Number(_0x1b3f4b[_0x235df5(0x1fb)]);return{'uv':_0x28bf87,'newUv':_0x37669c};}async[_0x470e4c(0x1e4)](_0x3fa3cf,_0x3fc726,_0x1be64e,_0x864088,_0x4a34c4){const _0x2c149b=_0x470e4c,_0x21e2b5=table_constant_1[_0x2c149b(0x244)]+'_'+_0x3fa3cf,_0x1b2c05=this['entityFactory'][_0x2c149b(0x24a)](sts_event_entity_1['StsEventEntity'],_0x21e2b5),_0x5abcaa=await _0x1b2c05[_0x2c149b(0x212)]()[_0x2c149b(0x1ab)](_0x2c149b(0x1ad),{'appId':_0x3fa3cf})[_0x2c149b(0x1c8)](_0x2c149b(0x1e8),{'type':_0x1be64e})[_0x2c149b(0x1c8)](_0x2c149b(0x217),{'eventIds':_0x3fc726})[_0x2c149b(0x1c8)](_0x2c149b(0x1c2),{'startTime':_0x864088})['andWhere'](_0x2c149b(0x205),{'endTime':_0x4a34c4})['getMany'](),_0x2a8bb4=_0x5abcaa[_0x2c149b(0x21a)]((_0x1b525d,_0x318118)=>{const _0x248a0d=_0x2c149b;return _0x1b525d[_0x318118['eventId']]=_0x1b525d[_0x318118[_0x248a0d(0x24e)]]||[],_0x1b525d[_0x318118[_0x248a0d(0x24e)]][_0x248a0d(0x19b)](_0x318118),_0x1b525d;},{});return _0x2a8bb4;}async[_0x470e4c(0x18f)](_0x6816ce,_0x2b9539,_0x52afef){const _0x569325=_0x470e4c;let _0x54008d='event_id\x20!=\x20\x27\x27';_0x2b9539&&(_0x54008d+='\x20AND\x20create_time\x20>=\x20\x27'+_0x2b9539+'\x27');_0x52afef&&(_0x54008d+=_0x569325(0x20f)+_0x52afef+'\x27');const _0x481fa9=table_constant_1['EVENT_TABLE']+'_'+_0x6816ce,_0x3cfb24='SELECT\x20DISTINCT(event_id)\x20AS\x20id\x20FROM\x20'+_0x481fa9+_0x569325(0x1b7)+_0x54008d,_0x382282=await this['clickhouse'][_0x569325(0x1c3)](_0x3cfb24),_0x46fdee=_0x382282[_0x569325(0x1cd)](_0x17f367=>_0x17f367['id']);return _0x46fdee;}async['getEventSegEntityListFromDetail'](_0xa2b02d,_0x2a8942,_0x30618e,_0x20f5fd){const _0x4a6e06=_0x470e4c,_0x2ab77b=table_constant_1[_0x4a6e06(0x185)]+'_'+_0xa2b02d;let _0x1fb8bf=_0x4a6e06(0x1f5)+_0x2a8942+_0x4a6e06(0x180)+_0x30618e+'\x27';_0x20f5fd&&(_0x1fb8bf='event_id\x20=\x20\x27'+_0x20f5fd+'\x27\x20AND\x20'+_0x1fb8bf);const _0x64e235=_0x4a6e06(0x1ee)+_0x2ab77b+'\x20WHERE\x20'+_0x1fb8bf,_0x3e1b64=await this[_0x4a6e06(0x1fa)][_0x4a6e06(0x1c3)](_0x64e235);if((0x0,obj_utils_1[_0x4a6e06(0x206)])(_0x3e1b64))return[];const _0x540515=[];for(const _0x5e3fa3 of _0x3e1b64){const _0x4fe654=_0x5e3fa3[_0x4a6e06(0x24e)],_0x52e4ce=_0x5e3fa3[_0x4a6e06(0x1d1)];if((0x0,obj_utils_1[_0x4a6e06(0x206)])(_0x4fe654)||(0x0,obj_utils_1['isEmpty'])(_0x52e4ce))continue;const _0x3e1d95=new event_seg_info_entity_1[(_0x4a6e06(0x219))]();_0x3e1d95['id']=this[_0x4a6e06(0x196)](_0xa2b02d+_0x4fe654+_0x52e4ce),_0x3e1d95[_0x4a6e06(0x1d8)]=_0xa2b02d,_0x3e1d95[_0x4a6e06(0x24e)]=_0x4fe654,_0x3e1d95['segId']=_0x52e4ce,_0x3e1d95['segName']=_0x52e4ce,_0x540515['push'](_0x3e1d95);}return _0x540515;}async[_0x470e4c(0x1c9)](_0x177435,_0x6e77c1){const _0x41477c=_0x470e4c,_0x5d4e98={'appId':_0x177435,'del':0x0};return!(0x0,obj_utils_1[_0x41477c(0x206)])(_0x6e77c1)&&(_0x5d4e98[_0x41477c(0x1a2)]=_0x6e77c1),await this['entityManager'][_0x41477c(0x23e)](event_info_entity_1['EventInfoEntity'],{'where':_0x5d4e98});}async[_0x470e4c(0x224)](_0xfb230d,_0x34b406,_0x9c4120){const _0x5a92cf=_0x470e4c,_0x41b4ee={'appId':_0xfb230d,'del':0x0};return!(0x0,obj_utils_1[_0x5a92cf(0x206)])(_0x34b406)&&(_0x41b4ee['eventId']=_0x34b406),!(0x0,obj_utils_1[_0x5a92cf(0x206)])(_0x9c4120)&&(_0x41b4ee['segStatus']=_0x9c4120),await this[_0x5a92cf(0x1ea)][_0x5a92cf(0x23e)](event_seg_info_entity_1['EventSegInfoEntity'],{'where':_0x41b4ee});}async[_0x470e4c(0x1c0)](_0x4cba85,_0x475837,_0x55010f){const _0x5bdc05=_0x470e4c;await this[_0x5bdc05(0x1ea)][_0x5bdc05(0x212)]()[_0x5bdc05(0x20a)](event_info_entity_1[_0x5bdc05(0x1f4)])[_0x5bdc05(0x1d2)]({'updateTime':_0x55010f})[_0x5bdc05(0x1ab)](_0x5bdc05(0x188),{'appId':_0x4cba85})[_0x5bdc05(0x1c8)](_0x5bdc05(0x23d),{'eventIds':_0x475837})['execute']();}async[_0x470e4c(0x234)](_0x3ca296,_0xe27833){const _0x200780=_0x470e4c;await this[_0x200780(0x1ea)][_0x200780(0x212)]()[_0x200780(0x20a)](event_seg_info_entity_1['EventSegInfoEntity'])[_0x200780(0x1d2)]({'updateTime':_0xe27833})['where'](_0x200780(0x1d3),{'ids':_0x3ca296})[_0x200780(0x1e5)]();}async[_0x470e4c(0x25a)](_0xcfcbd6){const _0x15b826=_0x470e4c;await this[_0x15b826(0x1ea)][_0x15b826(0x212)]()[_0x15b826(0x242)]()[_0x15b826(0x1c4)](event_info_entity_1[_0x15b826(0x1f4)])[_0x15b826(0x1d9)](_0xcfcbd6)[_0x15b826(0x247)]()['execute']();}async[_0x470e4c(0x204)](_0x2bf45b,_0x51d0aa){const _0x1c71d5=_0x470e4c;await this[_0x1c71d5(0x1ea)][_0x1c71d5(0x212)]()[_0x1c71d5(0x242)]()[_0x1c71d5(0x1c4)](event_info_entity_1['EventInfoEntity'])['values'](_0x2bf45b)[_0x1c71d5(0x1bc)](_0x51d0aa)['execute']();}async[_0x470e4c(0x1a4)](_0x2e0aef){const _0x45937e=_0x470e4c;await this[_0x45937e(0x1ea)][_0x45937e(0x212)]()['insert']()['into'](event_seg_info_entity_1['EventSegInfoEntity'])['values'](_0x2e0aef)[_0x45937e(0x247)]()['execute']();}async[_0x470e4c(0x1b2)](_0x56511d,_0x3a8b1a){const _0xadc8e8=_0x470e4c;await this[_0xadc8e8(0x1ea)][_0xadc8e8(0x212)]()[_0xadc8e8(0x242)]()[_0xadc8e8(0x1c4)](event_seg_info_entity_1[_0xadc8e8(0x219)])[_0xadc8e8(0x1d9)](_0x56511d)[_0xadc8e8(0x1bc)](_0x3a8b1a)['execute']();}async[_0x470e4c(0x256)](_0x59ca84,_0x33a3f9,_0x16ee2c){const _0x727abb=_0x470e4c;for(const _0x1a4fcd of _0x16ee2c){const _0x41a22a=this[_0x727abb(0x1f0)][_0x727abb(0x24a)](sts_event_entity_1[_0x727abb(0x1da)],table_constant_1[_0x727abb(0x244)]+'_'+_0x59ca84);await _0x41a22a[_0x727abb(0x212)]('event')[_0x727abb(0x262)]()[_0x727abb(0x1ab)]('appId\x20=\x20:appId',{'appId':_0x59ca84})[_0x727abb(0x1c8)]('type\x20=\x20:type',{'type':_0x1a4fcd[_0x727abb(0x1ff)]})[_0x727abb(0x1c8)](_0x727abb(0x1af),{'startTime':_0x1a4fcd[_0x727abb(0x228)]})[_0x727abb(0x1e5)]();const _0x41efa0=this[_0x727abb(0x1f0)]['createEntity'](sts_event_segment_entity_1[_0x727abb(0x1a1)],table_constant_1[_0x727abb(0x1ca)]+'_'+_0x59ca84);await _0x41efa0[_0x727abb(0x212)](_0x727abb(0x1d1))[_0x727abb(0x262)]()[_0x727abb(0x1ab)](_0x727abb(0x188),{'appId':_0x59ca84})[_0x727abb(0x1c8)](_0x727abb(0x1e8),{'type':_0x1a4fcd['type']})[_0x727abb(0x1c8)](_0x727abb(0x1af),{'startTime':_0x1a4fcd[_0x727abb(0x228)]})[_0x727abb(0x1e5)]();}}[_0x470e4c(0x196)](_0x47370c){const _0x4bc5fa=_0x470e4c;return CryptoJS['enc'][_0x4bc5fa(0x1ec)][_0x4bc5fa(0x1ce)](CryptoJS[_0x4bc5fa(0x1a0)](_0x47370c));}async['onAppInit'](_0x53fd0e){const _0x41aecd=_0x470e4c,_0xf3654=await this[_0x41aecd(0x1aa)](_0x53fd0e),_0xd40f29=await this[_0x41aecd(0x258)](_0x53fd0e),_0x40fbe1=await this[_0x41aecd(0x194)](_0x53fd0e);return _0xf3654||_0xd40f29||_0x40fbe1;}async[_0x470e4c(0x194)](_0x2b9eb7){const _0x7a4503=_0x470e4c;return await this[_0x7a4503(0x1fa)][_0x7a4503(0x1c6)]('\x0a\x20\x20\x20\x20CREATE\x20TABLE\x20\x20'+table_constant_1[_0x7a4503(0x185)]+'_'+_0x2b9eb7+'\x20(\x0a\x20\x20\x20\x20\x20\x20sid\x20String\x20COMMENT\x20\x27会话id\x27,\x0a\x20\x20\x20\x20\x20\x20event_id\x20String\x20COMMENT\x20\x27事件id\x27,\x0a\x20\x20\x20\x20\x20\x20device_id\x20String\x20COMMENT\x20\x27设备id\x27,\x0a\x20\x20\x20\x20\x20\x20user_id\x20String\x20COMMENT\x20\x27用户id\x27,\x0a\x20\x20\x20\x20\x20\x20is_new_user\x20tinyint(1)\x20COMMENT\x20\x27新用户标识\x27,\x0a\x20\x20\x20\x20\x20\x20device_no\x20UInt32\x20COMMENT\x20\x27设备编号\x27,\x0a\x20\x20\x20\x20\x20\x20string_seg_names\x20Array(String)\x20COMMENT\x20\x27事件参数key列表\x27,\x0a\x20\x20\x20\x20\x20\x20string_seg_values\x20Array(String)\x20COMMENT\x20\x27事件参数值列表\x27,\x0a\x20\x20\x20\x20\x20\x20create_time\x20DateTime(\x27'+(0x0,time_utils_1[_0x7a4503(0x254)])()+_0x7a4503(0x1ba)+(0x0,time_utils_1[_0x7a4503(0x254)])()+'\x27)\x20COMMENT\x20\x27事件记录时间\x27\x0a\x20\x20\x20\x20)\x20ENGINE\x20=\x20MergeTree()\x0a\x20\x20\x20\x20\x20\x20PARTITION\x20BY\x20toYYYYMMDD(timestamp)\x0a\x20\x20\x20\x20\x20\x20PRIMARY\x20KEY(event_id)\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x20(event_id)\x0a\x20\x20\x20\x20');}async[_0x470e4c(0x1aa)](_0x505d2b){const _0x163fc4=_0x470e4c,_0x114454='sts_event_'+_0x505d2b;try{return await this['entityManager']['query'](_0x163fc4(0x1f1)+_0x505d2b+_0x163fc4(0x208)),!![];}catch(_0xe4189e){return this[_0x163fc4(0x1a7)][_0x163fc4(0x1f7)]('create\x20table\x20'+_0x114454+_0x163fc4(0x1d0)+_0xe4189e),![];}}async[_0x470e4c(0x258)](_0x17ecf4){const _0x51e7ca=_0x470e4c,_0x310236=_0x51e7ca(0x25d)+_0x17ecf4;try{return await this[_0x51e7ca(0x1ea)][_0x51e7ca(0x1c3)](_0x51e7ca(0x193)+_0x310236+'\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20id\x20INT(11)\x20NOT\x20NULL\x20AUTO_INCREMENT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20app_id\x20VARCHAR(24)\x20NOT\x20NULL\x20COMMENT\x20\x27应用id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20year\x20INT(4)\x20NOT\x20NULL\x20COMMENT\x20\x27年分\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20type\x20INT(2)\x20NOT\x20NULL\x20COMMENT\x20\x271-天\x202-周\x203-月\x204-季\x205-年\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20idx\x20INT(2)\x20NOT\x20NULL\x20COMMENT\x20\x27下标\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20start_time\x20DATETIME\x20NOT\x20NULL\x20COMMENT\x20\x27开始时间\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20end_time\x20DATETIME\x20NOT\x20NULL\x20COMMENT\x20\x27结束时间\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20event_id\x20VARCHAR(128)\x20NOT\x20NULL\x20COMMENT\x20\x27事件id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20seg_id\x20VARCHAR(128)\x20NOT\x20NULL\x20COMMENT\x20\x27事件属性名称\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20seg_value\x20VARCHAR(512)\x20NOT\x20NULL\x20COMMENT\x20\x27事件属性值\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20pv\x20INT(11)\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uv\x20INT(11)\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20new_uv\x20INT(11)\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20create_time\x20DATETIME\x20NOT\x20NULL\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20del\x20TINYINT(1)\x20NOT\x20NULL\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20PRIMARY\x20KEY\x20(id),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20KEY\x20group_index\x20(app_id,\x20type,\x20event_id,\x20seg_id,\x20year,\x20idx),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20KEY\x20group_day_index\x20(app_id,\x20type,\x20event_id,\x20seg_id,\x20start_time)\x0a\x20\x20\x20\x20\x20\x20\x20\x20)'),!![];}catch(_0x13441d){return this['logger'][_0x51e7ca(0x1f7)](_0x51e7ca(0x23f)+_0x310236+_0x51e7ca(0x1d0)+_0x13441d),![];}}};function _0x549f(_0x2711f3,_0x3c8660){const _0x4668ef=_0x4668();return _0x549f=function(_0x549fb4,_0x580b24){_0x549fb4=_0x549fb4-0x180;let _0x2539a6=_0x4668ef[_0x549fb4];return _0x2539a6;},_0x549f(_0x2711f3,_0x3c8660);}EventService=EventService_1=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x470e4c(0x25e),[clickhouse_service_1[_0x470e4c(0x226)],typeorm_1['EntityManager'],entity_factory_1[_0x470e4c(0x20c)]])],EventService),exports['EventService']=EventService;