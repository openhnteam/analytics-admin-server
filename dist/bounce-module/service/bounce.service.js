'use strict';const _0x12ffdf=_0x3d4c;(function(_0x217ad1,_0x3bf5d3){const _0x18cf53=_0x3d4c,_0x242abc=_0x217ad1();while(!![]){try{const _0xb1b510=-parseInt(_0x18cf53(0x10b))/0x1+parseInt(_0x18cf53(0xed))/0x2*(-parseInt(_0x18cf53(0x122))/0x3)+parseInt(_0x18cf53(0xf9))/0x4*(parseInt(_0x18cf53(0xea))/0x5)+-parseInt(_0x18cf53(0x11e))/0x6*(parseInt(_0x18cf53(0x103))/0x7)+parseInt(_0x18cf53(0x117))/0x8*(-parseInt(_0x18cf53(0xf6))/0x9)+-parseInt(_0x18cf53(0xf4))/0xa+parseInt(_0x18cf53(0x126))/0xb;if(_0xb1b510===_0x3bf5d3)break;else _0x242abc['push'](_0x242abc['shift']());}catch(_0x2214b7){_0x242abc['push'](_0x242abc['shift']());}}}(_0x228e,0x1f486));function _0x228e(){const _0x2b52e6=['totalPv','typeorm','2644NpjWTO','name','../../shared/utils/time.utils','\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20sid\x20String\x20COMMENT\x20\x27会话id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20String\x20COMMENT\x20\x27用户id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20device_id\x20String\x20COMMENT\x20\x27设备id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20device_no\x20UInt32\x20COMMENT\x20\x27设备编号\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20is_new_user\x20tinyint(1)\x20COMMENT\x20\x27新用户标识\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20timestamp\x20DateTime(\x27','design:paramtypes','endTimeString','onAppInit','ClickhouseService','pvFormat','command','91MydNIY','\x27)\x20COMMENT\x20\x27上报时间\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20page\x20String\x20COMMENT\x20\x27页面名称\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20page_url\x20String\x20COMMENT\x20\x27页面路径\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20status\x20tinyint(1)\x20COMMENT\x20\x27跳出状态\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20INDEX\x20user_id_index\x20user_id\x20TYPE\x20minmax\x20GRANULARITY\x208192,\x0a\x20\x20\x20\x20\x20\x20\x20\x20INDEX\x20device_id_index\x20device_id\x20TYPE\x20minmax\x20GRANULARITY\x208192\x0a\x20\x20\x20\x20\x20\x20)\x20ENGINE\x20=\x20MergeTree()\x0a\x20\x20\x20\x20\x20\x20partition\x20by\x20toYYYYMM(create_time)\x0a\x20\x20\x20\x20\x20\x20primary\x20key\x20(sid)\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x20(sid,\x20create_time)\x0a\x20\x20\x20\x20','bounce','length','responseSuccess','getOwnPropertyDescriptor','\x20GROUP\x20BY\x20page\x0a\x20\x20\x20\x20','../../shared/utils/cal.utils','132677gRZARM','insert','getStartAndEndTime','BounceService','__metadata','BOUNCE_TABLE','Logger','values','startTimeString','clickhouse','type\x20=\x20:type','type','233360YlJAPn','\x0a\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20','count','isEmpty','StsPageBounceEntity','startTime\x20>=\x20:startTime','delete','8634IPaBzj','../dto/bounce.list.rsp.dto','decorate','object','24039LAJbci','totalUv','../entity/sts.bounce.entity','../../shared/service/clickhouse/clickhouse.service','3721608StFJzj','StsTaskDto','function','__esModule','newUv','execute','@nestjs/common','calPercentFormat','\x27\x20AND\x20page\x20!=\x20\x27\x27','andWhere','../../shared/utils/obj.utils','appTimeZone','BounceListItemRspDto','\x0a\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20page,\x20\x0a\x20\x20\x20\x20\x20\x20uniqExact(device_no)\x20AS\x20uv,\x20\x0a\x20\x20\x20\x20\x20\x20uniqExact(CASE\x20WHEN\x20is_new_user\x20=\x201\x20THEN\x20device_no\x20ELSE\x20NULL\x20END)\x20AS\x20newUv,\x0a\x20\x20\x20\x20\x20\x20count(1)\x20AS\x20pv,\x20\x0a\x20\x20\x20\x20\x20\x20SUM(status)\x20AS\x20bounce\x20\x0a\x20\x20\x20\x20FROM\x20','defineProperty','map','filter','\x20WHERE\x20','../../shared/constants/table.constant','create_time\x20>=\x20\x27','BaseService','into','query','list','reduce','Injectable','logger','1405YdmipI','period','buildStsPageBounceEntity','14pxyMqK','createQueryBuilder','startDailyStatistics','uvFormat','appId\x20=\x20:appId','\x27\x20AND\x20create_time\x20<=\x20\x27','appId','1009500NzrYZn','../../shared/dto/sts.task.dto','27MHRCPG'];_0x228e=function(){return _0x2b52e6;};return _0x228e();}var __decorate=this&&this['__decorate']||function(_0x175075,_0x349633,_0x150e22,_0x3a335b){const _0x29d2f3=_0x3d4c;var _0x5dc350=arguments['length'],_0x9b069d=_0x5dc350<0x3?_0x349633:_0x3a335b===null?_0x3a335b=Object[_0x29d2f3(0x108)](_0x349633,_0x150e22):_0x3a335b,_0x29516e;if(typeof Reflect==='object'&&typeof Reflect[_0x29d2f3(0x120)]===_0x29d2f3(0x128))_0x9b069d=Reflect['decorate'](_0x175075,_0x349633,_0x150e22,_0x3a335b);else{for(var _0x5cc0d2=_0x175075['length']-0x1;_0x5cc0d2>=0x0;_0x5cc0d2--)if(_0x29516e=_0x175075[_0x5cc0d2])_0x9b069d=(_0x5dc350<0x3?_0x29516e(_0x9b069d):_0x5dc350>0x3?_0x29516e(_0x349633,_0x150e22,_0x9b069d):_0x29516e(_0x349633,_0x150e22))||_0x9b069d;}return _0x5dc350>0x3&&_0x9b069d&&Object[_0x29d2f3(0xdd)](_0x349633,_0x150e22,_0x9b069d),_0x9b069d;},__metadata=this&&this[_0x12ffdf(0x10f)]||function(_0xf76751,_0x2d2632){const _0x2110dd=_0x12ffdf;if(typeof Reflect===_0x2110dd(0x121)&&typeof Reflect['metadata']===_0x2110dd(0x128))return Reflect['metadata'](_0xf76751,_0x2d2632);},BounceService_1;Object['defineProperty'](exports,_0x12ffdf(0x129),{'value':!![]}),exports[_0x12ffdf(0x10e)]=void 0x0;const table_constant_1=require(_0x12ffdf(0xe1)),sts_task_dto_1=require(_0x12ffdf(0xf5)),base_service_1=require('../../shared/service/base.service'),clickhouse_service_1=require(_0x12ffdf(0x125)),time_utils_1=require(_0x12ffdf(0xfb)),common_1=require(_0x12ffdf(0xd5)),typeorm_1=require(_0x12ffdf(0xf8)),sts_bounce_entity_1=require(_0x12ffdf(0x124)),bounce_list_rsp_dto_1=require(_0x12ffdf(0x11f)),cal_utils_1=require(_0x12ffdf(0x10a)),obj_utils_1=require(_0x12ffdf(0xd9));let BounceService=BounceService_1=class BounceService extends base_service_1[_0x12ffdf(0xe3)]{constructor(_0x374bd7,_0x50caf9){const _0x5c8e45=_0x12ffdf;super(),this['clickhouse']=_0x374bd7,this['entityManager']=_0x50caf9,this[_0x5c8e45(0xe9)]=new common_1[(_0x5c8e45(0x111))](BounceService_1[_0x5c8e45(0xfa)]);}async[_0x12ffdf(0xe6)](_0xa8b87c){const _0x53e389=_0x12ffdf,{startTime:_0x30735e,endTime:_0x3ebce3}=(0x0,time_utils_1[_0x53e389(0x10d)])(_0xa8b87c[_0x53e389(0xeb)]),_0x2bab24=new sts_task_dto_1[(_0x53e389(0x127))]();_0x2bab24['startTimeString']=_0x30735e,_0x2bab24[_0x53e389(0xfe)]=_0x3ebce3;const _0x45d25e=await this[_0x53e389(0xec)](_0xa8b87c['appId'],_0x2bab24);if((0x0,obj_utils_1[_0x53e389(0x11a)])(_0x45d25e))return this[_0x53e389(0x107)]({});const _0x4175ef={'totalUv':_0x45d25e[_0x53e389(0xe7)]((_0x5edcef,_0x187ac4)=>_0x5edcef+_0x187ac4['uv'],0x0),'totalPv':_0x45d25e['reduce']((_0xd99960,_0x2a0b73)=>_0xd99960+_0x2a0b73['pv'],0x0)},_0x5e9d12=_0x45d25e[_0x53e389(0xde)](_0x3866b3=>{const _0x49eddd=_0x53e389,_0x5836d2=new bounce_list_rsp_dto_1[(_0x49eddd(0xdb))]();return _0x5836d2['page']=_0x3866b3[_0x49eddd(0xfa)],_0x5836d2['pv']=_0x3866b3['pv'],_0x5836d2['uv']=_0x3866b3['uv'],_0x5836d2[_0x49eddd(0x101)]=_0x3866b3['pv']+'('+(0x0,cal_utils_1['calPercentFormat'])(_0x3866b3['pv'],_0x4175ef[_0x49eddd(0xf7)])+')',_0x5836d2[_0x49eddd(0xf0)]=_0x3866b3['uv']+'('+(0x0,cal_utils_1[_0x49eddd(0xd6)])(_0x3866b3['uv'],_0x4175ef[_0x49eddd(0x123)])+')',_0x5836d2[_0x49eddd(0x105)]=(0x0,cal_utils_1[_0x49eddd(0xd6)])(_0x3866b3[_0x49eddd(0x105)],_0x3866b3['pv']),_0x5836d2;}),_0x5101bd=_0x5e9d12['sort']((_0x2850db,_0x230c11)=>_0x230c11['pv']-_0x2850db['pv']),_0x496fa3=new bounce_list_rsp_dto_1['BounceListRspDto']();return _0x496fa3['list']=_0x5101bd,_0x496fa3[_0x53e389(0x119)]=_0x5101bd[_0x53e389(0x106)],this[_0x53e389(0x107)](_0x496fa3);}async[_0x12ffdf(0xef)](_0x2e0e17,_0x52aa5b,_0x328d63){const _0x5bbe4f=_0x12ffdf;for(const _0x6cb4e of _0x328d63){const _0x2e15ef=await this[_0x5bbe4f(0xec)](_0x2e0e17,_0x6cb4e);_0x2e15ef['length']>0x0&&await this['entityManager'][_0x5bbe4f(0xee)]()[_0x5bbe4f(0x10c)]()[_0x5bbe4f(0xe4)](sts_bounce_entity_1[_0x5bbe4f(0x11b)])[_0x5bbe4f(0x112)](_0x2e15ef)[_0x5bbe4f(0xd4)]();}}async[_0x12ffdf(0xec)](_0x598794,_0xbc8744){const _0x9445aa=_0x12ffdf,_0x327aad=table_constant_1[_0x9445aa(0x110)]+'_'+_0x598794,_0x164dee=_0x9445aa(0xe2)+_0xbc8744[_0x9445aa(0x113)]+_0x9445aa(0xf2)+_0xbc8744[_0x9445aa(0xfe)]+_0x9445aa(0xd7),_0x51ad76=_0x9445aa(0xdc)+_0x327aad+_0x9445aa(0xe0)+_0x164dee+_0x9445aa(0x109),_0x49aca6=await this[_0x9445aa(0x114)][_0x9445aa(0xe5)](_0x51ad76);if((0x0,obj_utils_1[_0x9445aa(0x11a)])(_0x49aca6))return[];const _0x38a79f=_0x49aca6[_0x9445aa(0xdf)](_0x2d5299=>!(0x0,obj_utils_1[_0x9445aa(0x11a)])(_0x2d5299['page'])),_0x494cf1=_0x38a79f[_0x9445aa(0xde)](_0x22a234=>{const _0x121f5a=_0x9445aa,_0x5ef66b=new sts_bounce_entity_1[(_0x121f5a(0x11b))](_0xbc8744);return _0x5ef66b[_0x121f5a(0xf3)]=_0x598794,_0x5ef66b['newUv']=Number(_0x22a234[_0x121f5a(0xd3)]),_0x5ef66b['name']=_0x22a234['page'],_0x5ef66b['uv']=Number(_0x22a234['uv']),_0x5ef66b['pv']=Number(_0x22a234['pv']),_0x5ef66b[_0x121f5a(0x105)]=Number(_0x22a234[_0x121f5a(0x105)]),_0x5ef66b;});return _0x494cf1;}async['clearDailyData'](_0x41a11d,_0x1f8ea8,_0x17b559){const _0x4a5dfa=_0x12ffdf;for(const _0x28c78d of _0x17b559){await this['entityManager']['getRepository'](sts_bounce_entity_1[_0x4a5dfa(0x11b)])[_0x4a5dfa(0xee)](_0x4a5dfa(0x105))[_0x4a5dfa(0x11d)]()['where'](_0x4a5dfa(0xf1),{'appId':_0x41a11d})[_0x4a5dfa(0xd8)](_0x4a5dfa(0x115),{'type':_0x28c78d[_0x4a5dfa(0x116)]})[_0x4a5dfa(0xd8)](_0x4a5dfa(0x11c),{'startTime':_0x28c78d[_0x4a5dfa(0x113)]})[_0x4a5dfa(0xd4)]();}}async[_0x12ffdf(0xff)](_0x194140){const _0x5485b7=_0x12ffdf;return await this[_0x5485b7(0x114)][_0x5485b7(0x102)](_0x5485b7(0x118)+table_constant_1[_0x5485b7(0x110)]+'_'+_0x194140+_0x5485b7(0xfc)+(0x0,time_utils_1[_0x5485b7(0xda)])()+'\x27)\x20COMMENT\x20\x27事件记录时间\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20create_time\x20DateTime(\x27'+(0x0,time_utils_1[_0x5485b7(0xda)])()+_0x5485b7(0x104));}};function _0x3d4c(_0x5217f9,_0x436bdb){const _0x228e7a=_0x228e();return _0x3d4c=function(_0x3d4c99,_0x4768eb){_0x3d4c99=_0x3d4c99-0xd3;let _0x5195d8=_0x228e7a[_0x3d4c99];return _0x5195d8;},_0x3d4c(_0x5217f9,_0x436bdb);}BounceService=BounceService_1=__decorate([(0x0,common_1[_0x12ffdf(0xe8)])(),__metadata(_0x12ffdf(0xfd),[clickhouse_service_1[_0x12ffdf(0x100)],typeorm_1['EntityManager']])],BounceService),exports[_0x12ffdf(0x10e)]=BounceService;