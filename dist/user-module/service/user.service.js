'use strict';const _0xfbd756=_0x5f43;(function(_0x554c87,_0x4cae64){const _0x64ce82=_0x5f43,_0x4f8db9=_0x554c87();while(!![]){try{const _0x8d392c=parseInt(_0x64ce82(0x1d0))/0x1+-parseInt(_0x64ce82(0x1b5))/0x2+-parseInt(_0x64ce82(0x18c))/0x3*(parseInt(_0x64ce82(0x1cf))/0x4)+-parseInt(_0x64ce82(0x1d6))/0x5+-parseInt(_0x64ce82(0x1c9))/0x6*(parseInt(_0x64ce82(0x19e))/0x7)+-parseInt(_0x64ce82(0x1b8))/0x8+parseInt(_0x64ce82(0x1cc))/0x9;if(_0x8d392c===_0x4cae64)break;else _0x4f8db9['push'](_0x4f8db9['shift']());}catch(_0x3248fe){_0x4f8db9['push'](_0x4f8db9['shift']());}}}(_0x39f1,0xee683));function _0x5f43(_0x1cd461,_0x521960){const _0x39f1e2=_0x39f1();return _0x5f43=function(_0x5f439a,_0x3c02d9){_0x5f439a=_0x5f439a-0x180;let _0x5a2e1a=_0x39f1e2[_0x5f439a];return _0x5a2e1a;},_0x5f43(_0x1cd461,_0x521960);}var __decorate=this&&this[_0xfbd756(0x1bc)]||function(_0x283911,_0x28eace,_0x207adc,_0xe8c841){const _0x1f1027=_0xfbd756;var _0x3b4aa9=arguments[_0x1f1027(0x1a5)],_0x574792=_0x3b4aa9<0x3?_0x28eace:_0xe8c841===null?_0xe8c841=Object[_0x1f1027(0x1c0)](_0x28eace,_0x207adc):_0xe8c841,_0x1ca144;if(typeof Reflect===_0x1f1027(0x1c2)&&typeof Reflect[_0x1f1027(0x19b)]===_0x1f1027(0x1c5))_0x574792=Reflect[_0x1f1027(0x19b)](_0x283911,_0x28eace,_0x207adc,_0xe8c841);else{for(var _0x1549c4=_0x283911[_0x1f1027(0x1a5)]-0x1;_0x1549c4>=0x0;_0x1549c4--)if(_0x1ca144=_0x283911[_0x1549c4])_0x574792=(_0x3b4aa9<0x3?_0x1ca144(_0x574792):_0x3b4aa9>0x3?_0x1ca144(_0x28eace,_0x207adc,_0x574792):_0x1ca144(_0x28eace,_0x207adc))||_0x574792;}return _0x3b4aa9>0x3&&_0x574792&&Object[_0x1f1027(0x1b9)](_0x28eace,_0x207adc,_0x574792),_0x574792;},__metadata=this&&this['__metadata']||function(_0x22c6e9,_0xa8ebfa){const _0x4cb528=_0xfbd756;if(typeof Reflect===_0x4cb528(0x1c2)&&typeof Reflect['metadata']===_0x4cb528(0x1c5))return Reflect[_0x4cb528(0x1da)](_0x22c6e9,_0xa8ebfa);},UserService_1;Object[_0xfbd756(0x1b9)](exports,_0xfbd756(0x187),{'value':!![]}),exports['UserService']=void 0x0;function _0x39f1(){const _0x1c9367=['design:paramtypes','240985MspLpW','endTimeString','singleQuery','\x27\x20AND\x20start_time\x20<=\x20\x27','metadata','DateUnit','save','reduce','isEmpty','StsUserEntity','getActiveUserCountInTimeRange','SELECT\x20uniqExact(device_no)\x20AS\x20c\x20FROM\x20','__esModule','\x0a\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20app_version\x20String\x20COMMENT\x20\x27应用版本\x27,\x0a\x20\x20\x20\x20\x20\x20os_version\x20String\x20COMMENT\x20\x27系统版本\x27,\x0a\x20\x20\x20\x20\x20\x20device\x20String\x20COMMENT\x20\x27设备型号\x27,\x0a\x20\x20\x20\x20\x20\x20device_type\x20String\x20COMMENT\x20\x27设备类型\x27,\x0a\x20\x20\x20\x20\x20\x20density\x20String\x20COMMENT\x20\x27设备密度\x27,\x0a\x20\x20\x20\x20\x20\x20locale\x20String\x20COMMENT\x20\x27语言\x27,\x0a\x20\x20\x20\x20\x20\x20resolution\x20String\x20COMMENT\x20\x27分辨率\x27,\x0a\x20\x20\x20\x20\x20\x20os\x20String\x20COMMENT\x20\x27系统\x27,\x0a\x20\x20\x20\x20\x20\x20carrier\x20String\x20COMMENT\x20\x27运营商\x27,\x0a\x20\x20\x20\x20\x20\x20mccmnc\x20String\x20COMMENT\x20\x27运营商编码\x27,\x0a\x20\x20\x20\x20\x20\x20scene\x20String\x20COMMENT\x20\x27启动场景\x27,\x0a\x20\x20\x20\x20\x20\x20install_channel\x20String\x20COMMENT\x20\x27安装渠道\x27,\x0a\x20\x20\x20\x20\x20\x20device_id\x20String\x20COMMENT\x20\x27设备id\x27,\x0a\x20\x20\x20\x20\x20\x20device_no\x20UInt32\x20COMMENT\x20\x27设备编码\x27,\x0a\x20\x20\x20\x20\x20\x20ip\x20String\x20COMMENT\x20\x27IP地址\x27,\x0a\x20\x20\x20\x20\x20\x20user_id\x20String\x20COMMENT\x20\x27用户id\x27,\x0a\x20\x20\x20\x20\x20\x20first_visit_time\x20DateTime(\x27','DESC','../entity/sts.user.entity','../dto/user.list.rsp.dto','84uPiqXv','USER_TABLE','name','Logger','clearDailyData','entityManager','andWhere','@nestjs/common','backUv','\x20WHERE\x20','user.appId\x20=\x20:appId','\x20WHERE\x20start_time\x20<=\x20\x27','startTime\x20>=\x20:startTime','list','startTimeString','decorate','appId','period','4839695LgNrSE','user.date\x20BETWEEN\x20:startTime\x20AND\x20:endTime','\x27)\x20COMMENT\x20\x27最后访问时间\x27\x0a\x20\x20\x20\x20)\x20ENGINE\x20=\x20ReplacingMergeTree()\x0a\x20\x20\x20\x20\x20\x20PRIMARY\x20KEY\x20device_no\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x20(device_no)\x0a\x20\x20\x20\x20','OPTIMIZE\x20TABLE\x20','Between','../../shared/service/clickhouse/clickhouse.service','start_time\x20>=\x20\x27','length','logger','fetchNewUserCount','../../shared/constants/date.constant','EntityManager','../../shared/service/base.service','type','responseSuccess','appId\x20=\x20:appId','map','total','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20uniqExact(device_no)\x20AS\x20uv,\x20\x0a\x20\x20\x20\x20\x20\x20uniqExact(CASE\x20WHEN\x20is_new_user\x20=\x201\x20THEN\x20device_no\x20ELSE\x20NULL\x20END)\x20AS\x20newUv\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x20','clickhouse','SUM(user.newUv)','startTime','newUv','3529496wCTuJO','UserListRspDto','find','87040DqJKta','defineProperty','UserService','type\x20=\x20:type','__decorate','onAppInit','DAY','where','getOwnPropertyDescriptor','BaseService','object','../../shared/constants/table.constant','appTimeZone','function','sum','command','user','6AvwJer','SESSION_TABLE','\x20DEDUPLICATE','33136542GgCzyH','dateFormat','select','187588wTguTP','1123003tEsois','typeorm','fetchStsUserEntityLimit','createQueryBuilder','\x27)\x20COMMENT\x20\x27首次访问时间\x27,\x0a\x20\x20\x20\x20\x20\x20last_visit_time\x20DateTime(\x27'];_0x39f1=function(){return _0x1c9367;};return _0x39f1();}const table_constant_1=require(_0xfbd756(0x1c3)),base_service_1=require(_0xfbd756(0x1aa)),clickhouse_service_1=require(_0xfbd756(0x1a3)),time_utils_1=require('../../shared/utils/time.utils'),common_1=require(_0xfbd756(0x193)),typeorm_1=require(_0xfbd756(0x1d1)),sts_user_entity_1=require(_0xfbd756(0x18a)),obj_utils_1=require('../../shared/utils/obj.utils'),date_constant_1=require(_0xfbd756(0x1a8)),user_list_rsp_dto_1=require(_0xfbd756(0x18b));let UserService=UserService_1=class UserService extends base_service_1[_0xfbd756(0x1c1)]{constructor(_0x5a5dc2,_0x1a4b1a){const _0x304aea=_0xfbd756;super(),this['clickhouse']=_0x5a5dc2,this[_0x304aea(0x191)]=_0x1a4b1a,this[_0x304aea(0x1a6)]=new common_1[(_0x304aea(0x18f))](UserService_1[_0x304aea(0x18e)]);}async['list'](_0x499609){const _0x568fea=_0xfbd756,{startTime:_0x370935,endTime:_0x2468fa,stsStartTime:_0xc5f11a,stsEndTime:_0x2842e1}=(0x0,time_utils_1['getStartAndEndTime'])(_0x499609[_0x568fea(0x19d)]),_0xbadfce=await this[_0x568fea(0x191)][_0x568fea(0x1b7)](sts_user_entity_1[_0x568fea(0x184)],{'where':{'appId':_0x499609[_0x568fea(0x19c)],'type':date_constant_1[_0x568fea(0x180)][_0x568fea(0x1be)],'startTime':(0x0,typeorm_1[_0x568fea(0x1a2)])(new Date(_0xc5f11a),new Date(_0x2842e1)),'del':0x0}});if((0x0,obj_utils_1[_0x568fea(0x183)])(_0xbadfce))return this[_0x568fea(0x1ac)]({});const _0x2dcaa2=_0xbadfce[_0x568fea(0x182)]((_0x4412ef,_0x16eac1)=>{const _0x52aafb=_0x568fea,_0x341993=(0x0,time_utils_1[_0x52aafb(0x1cd)])(_0x16eac1[_0x52aafb(0x1b3)],date_constant_1['DATE_FORMAT']);return _0x4412ef[_0x341993]=_0x16eac1,_0x4412ef;},{}),_0x3d2944=(0x0,time_utils_1['getTicksBetween'])(_0x499609[_0x568fea(0x19d)]),_0x54d136=_0x3d2944[_0x568fea(0x1ae)](_0x1fcda7=>{const _0x50daf2=_0x568fea,_0x411cf1=_0x2dcaa2[_0x1fcda7],_0x1463f6=!_0x411cf1?0x0:_0x411cf1['uv'],_0x4f91e0=!_0x411cf1?0x0:_0x411cf1[_0x50daf2(0x1b4)],_0x5ab22b=_0x1463f6-_0x4f91e0;return{'id':_0x1fcda7,'uv':_0x1463f6,'newUv':_0x4f91e0,'backUv':_0x5ab22b};}),_0x5a104f=_0xbadfce[_0x568fea(0x182)]((_0x4eaabf,_0x46d130)=>_0x4eaabf+_0x46d130[_0x568fea(0x1b4)],0x0),_0x43c682=await this[_0x568fea(0x185)](_0x499609[_0x568fea(0x19c)],_0x370935,_0x2468fa),_0x5bd8eb=new user_list_rsp_dto_1[(_0x568fea(0x1b6))]();return _0x5bd8eb[_0x568fea(0x199)]=_0x54d136,_0x5bd8eb['uv']=_0x43c682,_0x5bd8eb[_0x568fea(0x1b4)]=_0x5a104f,_0x5bd8eb[_0x568fea(0x194)]=_0x43c682-_0x5a104f,this[_0x568fea(0x1ac)](_0x5bd8eb);}async[_0xfbd756(0x185)](_0x4d0cb8,_0x439abf,_0x3a9650){const _0x195adb=_0xfbd756,_0x42a5ef='start_time\x20>=\x20\x27'+_0x439abf+_0x195adb(0x1d9)+_0x3a9650+'\x27',_0x313017=table_constant_1[_0x195adb(0x1ca)]+'_'+_0x4d0cb8,_0x54bde5=await this[_0x195adb(0x1b1)][_0x195adb(0x1d8)](_0x195adb(0x186)+_0x313017+'\x20WHERE\x20'+_0x42a5ef),_0x5e885c=(0x0,obj_utils_1[_0x195adb(0x183)])(_0x54bde5)?0x0:Number(_0x54bde5['c']);return _0x5e885c;}async[_0xfbd756(0x1a7)](_0x427c49,_0x197444,_0x37c55f){const _0xed3fc4=_0xfbd756,_0x2c68fc=await this[_0xed3fc4(0x191)]['createQueryBuilder'](sts_user_entity_1[_0xed3fc4(0x184)],_0xed3fc4(0x1c8))[_0xed3fc4(0x1ce)](_0xed3fc4(0x1b2),_0xed3fc4(0x1c6))['where'](_0xed3fc4(0x196),{'appId':_0x427c49})[_0xed3fc4(0x192)](_0xed3fc4(0x19f),{'startTime':_0x197444,'endTime':_0x37c55f})['getOne']();if((0x0,obj_utils_1[_0xed3fc4(0x183)])(_0x2c68fc))return 0x0;return Number(_0x2c68fc[_0xed3fc4(0x1c6)]);}async['fetchStsUserEntityList'](_0x2a9114,_0x731bea,_0x245600){const _0x190316=_0xfbd756,_0x59acbf=await this[_0x190316(0x191)][_0x190316(0x1b7)](sts_user_entity_1[_0x190316(0x184)],{'where':{'appId':_0x2a9114,'type':date_constant_1[_0x190316(0x180)][_0x190316(0x1be)],'startTime':(0x0,typeorm_1[_0x190316(0x1a2)])(new Date(_0x731bea),new Date(_0x245600)),'del':0x0},'order':{'startTime':_0x190316(0x189)}});return _0x59acbf;}async[_0xfbd756(0x1d2)](_0xb43948,_0x30ed50){const _0x4416fa=_0xfbd756,_0x179124=await this['entityManager']['find'](sts_user_entity_1[_0x4416fa(0x184)],{'where':{'appId':_0xb43948,'type':date_constant_1[_0x4416fa(0x180)][_0x4416fa(0x1be)],'del':0x0},'order':{'startTime':_0x4416fa(0x189)},'skip':0x0,'take':_0x30ed50});return _0x179124;}async['startDailyStatistics'](_0x8aac2,_0x437640,_0x6dc84b){const _0x18fee3=_0xfbd756,_0x350217=table_constant_1[_0x18fee3(0x18d)]+'_'+_0x8aac2,_0x2dc6ed=table_constant_1[_0x18fee3(0x1ca)]+'_'+_0x8aac2;await this[_0x18fee3(0x1b1)][_0x18fee3(0x1c7)](_0x18fee3(0x1a1)+_0x350217+_0x18fee3(0x1cb));for(const _0x4e7830 of _0x6dc84b){const _0x4d00f7=_0x18fee3(0x1a4)+_0x4e7830[_0x18fee3(0x19a)]+_0x18fee3(0x1d9)+_0x4e7830[_0x18fee3(0x1d7)]+'\x27',_0x27da7a=await this[_0x18fee3(0x1b1)]['singleQuery'](_0x18fee3(0x1b0)+_0x2dc6ed+_0x18fee3(0x195)+_0x4d00f7),_0x4046fa=_0x27da7a['uv']||0x0,_0x52f683=_0x27da7a[_0x18fee3(0x1b4)]||0x0,_0x475cf7=await this[_0x18fee3(0x1b1)][_0x18fee3(0x1d8)](_0x18fee3(0x186)+_0x2dc6ed+_0x18fee3(0x197)+_0x4e7830[_0x18fee3(0x1d7)]+'\x27'),_0x222b8d=_0x475cf7['c']||0x0,_0x5a3428=new sts_user_entity_1[(_0x18fee3(0x184))](_0x4e7830);_0x5a3428[_0x18fee3(0x19c)]=_0x8aac2,_0x5a3428['uv']=Number(_0x4046fa),_0x5a3428[_0x18fee3(0x1b4)]=Number(_0x52f683),_0x5a3428[_0x18fee3(0x1af)]=Number(_0x222b8d),await _0x5a3428[_0x18fee3(0x181)]();}}async[_0xfbd756(0x190)](_0x6fb743,_0x21d1e2,_0x54691a){const _0x363bdd=_0xfbd756;for(const _0x4ba3ec of _0x54691a){await this[_0x363bdd(0x191)]['getRepository'](sts_user_entity_1[_0x363bdd(0x184)])[_0x363bdd(0x1d3)](_0x363bdd(0x1c8))['delete']()[_0x363bdd(0x1bf)](_0x363bdd(0x1ad),{'appId':_0x6fb743})[_0x363bdd(0x192)](_0x363bdd(0x1bb),{'type':_0x4ba3ec[_0x363bdd(0x1ab)]})[_0x363bdd(0x192)](_0x363bdd(0x198),{'startTime':_0x4ba3ec[_0x363bdd(0x19a)]})['execute']();}}async[_0xfbd756(0x1bd)](_0x269595){const _0x5a9513=_0xfbd756;return await this[_0x5a9513(0x1b1)][_0x5a9513(0x1c7)]('\x0a\x20\x20\x20\x20CREATE\x20TABLE\x20'+table_constant_1[_0x5a9513(0x18d)]+'_'+_0x269595+_0x5a9513(0x188)+(0x0,time_utils_1[_0x5a9513(0x1c4)])()+_0x5a9513(0x1d4)+(0x0,time_utils_1[_0x5a9513(0x1c4)])()+_0x5a9513(0x1a0)),!![];}};UserService=UserService_1=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0xfbd756(0x1d5),[clickhouse_service_1['ClickhouseService'],typeorm_1[_0xfbd756(0x1a9)]])],UserService),exports[_0xfbd756(0x1ba)]=UserService;