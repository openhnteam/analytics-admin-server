'use strict';function _0x3eef(){const _0x56155f=['ClickhouseService','delete','andWhere','pages','853684YogPVe','35348tByjxb','\x20WHERE\x20','../../shared/utils/time.utils','105VhhGqp','buildStsPageEntity','entityManager','totalDuration','getRepository','491947ppWzGU','SELECT\x20count()\x20AS\x20c\x20FROM\x20','length','metadata','1189762aTnuAm','filter','\x27\x20AND\x20create_time\x20<=\x20\x27','pageSize','12DrtUVP','startDailyStatistics','\x27)\x20COMMENT\x20\x27上报时间\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20page\x20String\x20COMMENT\x20\x27页面名称\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20page_url\x20String\x20COMMENT\x20\x27页面路径\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20duration\x20UInt32\x20COMMENT\x20\x27页面访问时长（毫秒）\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20INDEX\x20user_id_index\x20user_id\x20TYPE\x20minmax\x20GRANULARITY\x208192,\x0a\x20\x20\x20\x20\x20\x20\x20\x20INDEX\x20device_id_index\x20device_id\x20TYPE\x20minmax\x20GRANULARITY\x208192\x0a\x20\x20\x20\x20\x20\x20)\x20ENGINE\x20=\x20MergeTree()\x0a\x20\x20\x20\x20\x20\x20partition\x20by\x20toYYYYMM(create_time)\x0a\x20\x20\x20\x20\x20\x20primary\x20key\x20(sid)\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x20(sid,\x20create_time)\x0a\x20\x20\x20\x20','45414FWxmrm','__esModule','../../shared/service/clickhouse/clickhouse.service','createQueryBuilder','isEmpty','279944ZItPAl','object','deviceNo','command','singleQuery','decorate','endTimeString','pageUrl','sidSearch','__metadata','duration','@nestjs/common','BaseService','9roXJVI',')\x20GROUP\x20BY\x20sid','StsPageEntity','sort','valueOf','\x20GROUP\x20BY\x20page','PagePathItemRspDto','StsTaskDto','clickhouse','\x27\x20AND\x20page\x20!=\x20\x27\x27','sid','../dto/page.duration.rsp.dto','push','\x20ORDER\x20BY\x20start_time\x20DESC\x20LIMIT\x20','into','PageService','startTimeString','../../shared/service/base.service','list','map','PageDurationRspDto','Injectable','appId','../../shared/dto/sts.task.dto','PAGE_TABLE','logger','totalPv','insert','pvFormat','defineProperty','getStartAndEndTime','where','\x20WHERE\x20sid\x20IN\x20(','count','responseSuccess','__decorate','SELECT\x20id,\x20user_id\x20AS\x20userId,\x20start_time\x20AS\x20visitTime,\x20device_no\x20as\x20deviceNo\x20FROM\x20','period','../entity/sts.page.entity','visitTime','onAppInit','avgDuration','../dto/page.sid.search.rsp.dto','\x0a\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20','PageSidSearchItemRspDto','\x20and\x20user_id\x20=\x20\x27','\x27\x20AND\x20start_time\x20<=\x20\x27','../../shared/utils/obj.utils','2211770MtcgRx','appTimeZone','totalAvgDuration','SELECT\x20sid,\x20groupArray((timestamp,\x20page,\x20page_url,\x20duration))\x20AS\x20pages\x20FROM\x20','reduce','userId','\x20and\x20device_no\x20=\x20','join','page','name','create_time\x20>=\x20\x27','getOwnPropertyDescriptor','type\x20=\x20:type','EntityManager','appId\x20=\x20:appId','\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20sid\x20String\x20COMMENT\x20\x27会话id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20String\x20COMMENT\x20\x27用户id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20device_id\x20String\x20COMMENT\x20\x27设备id\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20device_no\x20UInt32\x20COMMENT\x20\x27设备编号\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20is_new_user\x20tinyint(1)\x20COMMENT\x20\x27新用户标识\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20timestamp\x20DateTime(\x27','newUv','forEach','\x27)\x20COMMENT\x20\x27事件记录时间\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20create_time\x20DateTime(\x27','calPercentFormat','execute','start_time\x20>=\x20\x27','startTime\x20>=\x20:startTime','query','typeorm'];_0x3eef=function(){return _0x56155f;};return _0x3eef();}const _0x52ad9e=_0x4133;(function(_0x260a0f,_0x1e148d){const _0x5bd122=_0x4133,_0x5b2c5d=_0x260a0f();while(!![]){try{const _0x4a3284=parseInt(_0x5bd122(0x217))/0x1+-parseInt(_0x5bd122(0x20e))/0x2+-parseInt(_0x5bd122(0x222))/0x3+-parseInt(_0x5bd122(0x20f))/0x4*(-parseInt(_0x5bd122(0x212))/0x5)+-parseInt(_0x5bd122(0x21f))/0x6*(-parseInt(_0x5bd122(0x21b))/0x7)+parseInt(_0x5bd122(0x227))/0x8*(-parseInt(_0x5bd122(0x234))/0x9)+-parseInt(_0x5bd122(0x1f1))/0xa;if(_0x4a3284===_0x1e148d)break;else _0x5b2c5d['push'](_0x5b2c5d['shift']());}catch(_0x2cc4d2){_0x5b2c5d['push'](_0x5b2c5d['shift']());}}}(_0x3eef,0x4df4a));var __decorate=this&&this[_0x52ad9e(0x257)]||function(_0x33d2b9,_0xb51c52,_0x130170,_0xc0627f){const _0x47614a=_0x52ad9e;var _0x5f2c48=arguments[_0x47614a(0x219)],_0x482272=_0x5f2c48<0x3?_0xb51c52:_0xc0627f===null?_0xc0627f=Object[_0x47614a(0x1fc)](_0xb51c52,_0x130170):_0xc0627f,_0x35c81a;if(typeof Reflect===_0x47614a(0x228)&&typeof Reflect[_0x47614a(0x22c)]==='function')_0x482272=Reflect[_0x47614a(0x22c)](_0x33d2b9,_0xb51c52,_0x130170,_0xc0627f);else{for(var _0x3d5354=_0x33d2b9['length']-0x1;_0x3d5354>=0x0;_0x3d5354--)if(_0x35c81a=_0x33d2b9[_0x3d5354])_0x482272=(_0x5f2c48<0x3?_0x35c81a(_0x482272):_0x5f2c48>0x3?_0x35c81a(_0xb51c52,_0x130170,_0x482272):_0x35c81a(_0xb51c52,_0x130170))||_0x482272;}return _0x5f2c48>0x3&&_0x482272&&Object[_0x47614a(0x251)](_0xb51c52,_0x130170,_0x482272),_0x482272;},__metadata=this&&this[_0x52ad9e(0x230)]||function(_0x3f5264,_0x59120b){const _0x2c2094=_0x52ad9e;if(typeof Reflect===_0x2c2094(0x228)&&typeof Reflect['metadata']==='function')return Reflect[_0x2c2094(0x21a)](_0x3f5264,_0x59120b);},PageService_1;Object[_0x52ad9e(0x251)](exports,_0x52ad9e(0x223),{'value':!![]}),exports[_0x52ad9e(0x243)]=void 0x0;function _0x4133(_0x11c6fb,_0x21b923){const _0x3eef05=_0x3eef();return _0x4133=function(_0x4133b8,_0x1e001f){_0x4133b8=_0x4133b8-0x1e7;let _0x13e2d6=_0x3eef05[_0x4133b8];return _0x13e2d6;},_0x4133(_0x11c6fb,_0x21b923);}const table_constant_1=require('../../shared/constants/table.constant'),sts_task_dto_1=require(_0x52ad9e(0x24b)),base_service_1=require(_0x52ad9e(0x245)),clickhouse_service_1=require(_0x52ad9e(0x224)),time_utils_1=require(_0x52ad9e(0x211)),common_1=require(_0x52ad9e(0x232)),typeorm_1=require(_0x52ad9e(0x209)),sts_page_entity_1=require(_0x52ad9e(0x1e7)),obj_utils_1=require(_0x52ad9e(0x1f0)),page_sid_search_rsp_dto_1=require(_0x52ad9e(0x1eb)),page_duration_rsp_dto_1=require(_0x52ad9e(0x23f)),cal_utils_1=require('../../shared/utils/cal.utils');let PageService=PageService_1=class PageService extends base_service_1[_0x52ad9e(0x233)]{constructor(_0x2c3af1,_0x461b28){const _0x37aed1=_0x52ad9e;super(),this['clickhouse']=_0x2c3af1,this[_0x37aed1(0x214)]=_0x461b28,this[_0x37aed1(0x24d)]=new common_1['Logger'](PageService_1[_0x37aed1(0x1fa)]);}async[_0x52ad9e(0x22f)](_0x34ceeb){const _0x4b6484=_0x52ad9e,_0x3640e7=table_constant_1['SEARCH_TABLE']+'_'+_0x34ceeb[_0x4b6484(0x24a)],{startTime:_0x4c73ba,endTime:_0x21e02a}=(0x0,time_utils_1['getStartAndEndTime'])(_0x34ceeb['period']);let _0x49a80a=_0x4b6484(0x206)+_0x4c73ba+_0x4b6484(0x1ef)+_0x21e02a+'\x27';!(0x0,obj_utils_1[_0x4b6484(0x226)])(_0x34ceeb[_0x4b6484(0x1f6)])&&(_0x49a80a+=_0x4b6484(0x1ee)+_0x34ceeb[_0x4b6484(0x1f6)]+'\x27');!(0x0,obj_utils_1[_0x4b6484(0x226)])(_0x34ceeb[_0x4b6484(0x229)])&&(_0x49a80a+=_0x4b6484(0x1f7)+_0x34ceeb[_0x4b6484(0x229)]);const _0x23e0b0=_0x34ceeb[_0x4b6484(0x21e)],_0x1d84f8=(_0x34ceeb[_0x4b6484(0x1f9)]-0x1)*_0x23e0b0;let _0x5dfcff=_0x4b6484(0x258)+_0x3640e7+'\x20WHERE\x20'+_0x49a80a+_0x4b6484(0x241)+_0x1d84f8+','+_0x23e0b0;const _0x544d23=await this[_0x4b6484(0x23c)][_0x4b6484(0x208)](_0x5dfcff);if((0x0,obj_utils_1[_0x4b6484(0x226)])(_0x544d23))return this[_0x4b6484(0x256)]({});_0x5dfcff=_0x4b6484(0x218)+_0x3640e7+_0x4b6484(0x210)+_0x49a80a;const _0x4d7f64=await this[_0x4b6484(0x23c)][_0x4b6484(0x22b)](_0x5dfcff),_0x441c80=_0x4d7f64['c']||0x0,_0x2a5131=_0x544d23[_0x4b6484(0x247)](_0x22f42e=>'\x27'+_0x22f42e['id']+'\x27'),_0x595603=table_constant_1[_0x4b6484(0x24c)]+'_'+_0x34ceeb[_0x4b6484(0x24a)];_0x5dfcff=_0x4b6484(0x1f4)+_0x595603+_0x4b6484(0x254)+_0x2a5131[_0x4b6484(0x1f8)](',')+_0x4b6484(0x235);const _0x470e42=await this['clickhouse'][_0x4b6484(0x208)](_0x5dfcff),_0x1aee43=new page_sid_search_rsp_dto_1['pageSidSearchRspDto'](),_0x58a52b=[],_0x525a28=_0x470e42[_0x4b6484(0x1f5)]((_0x4b7139,_0x1571f9)=>{const _0x48d8c3=_0x4b6484;return _0x4b7139[_0x1571f9[_0x48d8c3(0x23e)]]=_0x1571f9[_0x48d8c3(0x20d)],_0x4b7139;},{});return _0x544d23[_0x4b6484(0x202)](_0x15dfe1=>{const _0x19a9f7=_0x4b6484,_0xcb32a1=new page_sid_search_rsp_dto_1[(_0x19a9f7(0x1ed))]();_0xcb32a1['sid']=_0x15dfe1['id'],_0xcb32a1['userId']=_0x15dfe1[_0x19a9f7(0x1f6)],_0xcb32a1[_0x19a9f7(0x229)]=_0x15dfe1[_0x19a9f7(0x229)],_0xcb32a1['visitTime']=_0x15dfe1['visitTime'],_0xcb32a1['pages']=[],_0xcb32a1[_0x19a9f7(0x215)]=0x0;const _0x4469b9=_0x525a28[''+_0x15dfe1['id']];if(!(0x0,obj_utils_1[_0x19a9f7(0x226)])(_0x4469b9)){_0x4469b9[_0x19a9f7(0x237)]((_0x5bd0bc,_0x13aba5)=>{const _0x3bd6bc=_0x19a9f7;return new Date(_0x5bd0bc[0x0])['valueOf']()-new Date(_0x13aba5[0x0])[_0x3bd6bc(0x238)]();}),_0xcb32a1[_0x19a9f7(0x215)]=_0x4469b9[_0x19a9f7(0x1f5)]((_0x274a34,_0x157012)=>_0x274a34+Number(_0x157012[0x3]),0x0);const _0x23eb42=[];_0x4469b9[_0x19a9f7(0x202)](_0x427148=>{const _0x2edd4c=_0x19a9f7,_0x415dd1=new page_sid_search_rsp_dto_1[(_0x2edd4c(0x23a))]();_0x415dd1[_0x2edd4c(0x1e8)]=_0x427148[0x0],_0x415dd1[_0x2edd4c(0x1f9)]=_0x427148[0x1],_0x415dd1[_0x2edd4c(0x22e)]=_0x427148[0x2],_0x415dd1[_0x2edd4c(0x231)]=Number(_0x427148[0x3]),_0x23eb42[_0x2edd4c(0x240)](_0x415dd1);}),_0xcb32a1['pages']=_0x23eb42;}_0x58a52b[_0x19a9f7(0x240)](_0xcb32a1);}),_0x1aee43['list']=_0x58a52b,_0x1aee43[_0x4b6484(0x255)]=Number(_0x441c80),this[_0x4b6484(0x256)](_0x1aee43);}async[_0x52ad9e(0x231)](_0x43df1f){const _0x1ce3e1=_0x52ad9e,{startTime:_0x2eceef,endTime:_0x10c62f}=(0x0,time_utils_1[_0x1ce3e1(0x252)])(_0x43df1f[_0x1ce3e1(0x259)]),_0x4c600e=new sts_task_dto_1[(_0x1ce3e1(0x23b))]();_0x4c600e[_0x1ce3e1(0x244)]=_0x2eceef,_0x4c600e['endTimeString']=_0x10c62f;const _0x27d8d7=await this[_0x1ce3e1(0x213)](_0x43df1f[_0x1ce3e1(0x24a)],_0x4c600e);if((0x0,obj_utils_1[_0x1ce3e1(0x226)])(_0x27d8d7))return this[_0x1ce3e1(0x256)]({});const _0x24d353={'totalUv':_0x27d8d7['reduce']((_0x105f88,_0x46d540)=>_0x105f88+_0x46d540['uv'],0x0),'totalPv':_0x27d8d7[_0x1ce3e1(0x1f5)]((_0x45c13c,_0x2c3f4e)=>_0x45c13c+_0x2c3f4e['pv'],0x0),'totalAvgDuration':_0x27d8d7[_0x1ce3e1(0x1f5)]((_0x1f7951,_0x94d284)=>_0x1f7951+_0x94d284[_0x1ce3e1(0x1ea)],0x0)},_0xe82a2f=_0x27d8d7[_0x1ce3e1(0x247)](_0x48627b=>{const _0x2ea20c=_0x1ce3e1,_0x1ac064=new page_duration_rsp_dto_1['PageDurationItemRspDto']();return _0x1ac064[_0x2ea20c(0x1f9)]=_0x48627b[_0x2ea20c(0x1fa)],_0x1ac064['pv']=_0x48627b['pv'],_0x1ac064['uv']=_0x48627b['uv'],_0x1ac064[_0x2ea20c(0x250)]=_0x48627b['pv']+'('+(0x0,cal_utils_1['calPercentFormat'])(_0x48627b['pv'],_0x24d353[_0x2ea20c(0x24e)])+')',_0x1ac064['uvFormat']=_0x48627b['uv']+'('+(0x0,cal_utils_1[_0x2ea20c(0x204)])(_0x48627b['pv'],_0x24d353['totalUv'])+')',_0x1ac064[_0x2ea20c(0x231)]=_0x48627b[_0x2ea20c(0x1ea)]+'('+(0x0,cal_utils_1[_0x2ea20c(0x204)])(_0x48627b['avgDuration'],_0x24d353[_0x2ea20c(0x1f3)])+')',_0x1ac064;}),_0x3fe216=_0xe82a2f[_0x1ce3e1(0x237)]((_0x1c9284,_0x36e856)=>_0x36e856['pv']-_0x1c9284['pv']),_0x40507c=new page_duration_rsp_dto_1[(_0x1ce3e1(0x248))]();return _0x40507c[_0x1ce3e1(0x246)]=_0x3fe216,_0x40507c[_0x1ce3e1(0x255)]=_0x3fe216['length'],this[_0x1ce3e1(0x256)](_0x40507c);}async[_0x52ad9e(0x220)](_0x1de3cc,_0x464dec,_0x3bb7f9){const _0x1facad=_0x52ad9e;for(const _0x45adea of _0x3bb7f9){const _0x54a9cf=await this[_0x1facad(0x213)](_0x1de3cc,_0x45adea);_0x54a9cf[_0x1facad(0x219)]>0x0&&await this[_0x1facad(0x214)][_0x1facad(0x225)]()[_0x1facad(0x24f)]()[_0x1facad(0x242)](sts_page_entity_1['StsPageEntity'])['values'](_0x54a9cf)[_0x1facad(0x205)]();}}async[_0x52ad9e(0x213)](_0x34fe47,_0x5612ac){const _0x2f2051=_0x52ad9e,_0x499f8c=table_constant_1[_0x2f2051(0x24c)]+'_'+_0x34fe47,_0x15d335=_0x2f2051(0x1fb)+_0x5612ac[_0x2f2051(0x244)]+_0x2f2051(0x21d)+_0x5612ac[_0x2f2051(0x22d)]+_0x2f2051(0x23d),_0x5ce00d='\x0a\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20page,\x20\x0a\x20\x20\x20\x20\x20\x20uniqExact(device_no)\x20AS\x20uv,\x0a\x20\x20\x20\x20\x20\x20uniqExact(CASE\x20WHEN\x20is_new_user\x20=\x201\x20THEN\x20device_no\x20ELSE\x20NULL\x20END)\x20AS\x20newUv,\x0a\x20\x20\x20\x20\x20\x20count(1)\x20AS\x20pv,\x20\x0a\x20\x20\x20\x20\x20\x20SUM(duration)\x20AS\x20totalDuration,\x20\x0a\x20\x20\x20\x20\x20\x20AVG(duration)\x20AS\x20avgDuration\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+_0x499f8c+'\x20WHERE\x20'+_0x15d335+_0x2f2051(0x239),_0x399cb1=await this[_0x2f2051(0x23c)][_0x2f2051(0x208)](_0x5ce00d);if((0x0,obj_utils_1[_0x2f2051(0x226)])(_0x399cb1))return[];const _0x158f89=_0x399cb1[_0x2f2051(0x21c)](_0x2d2e44=>!(0x0,obj_utils_1[_0x2f2051(0x226)])(_0x2d2e44[_0x2f2051(0x1f9)])&&_0x2d2e44['page']['length']<0x80),_0x1ec56c=_0x158f89[_0x2f2051(0x247)](_0x251675=>{const _0x555cba=_0x2f2051,_0x38d327=new sts_page_entity_1['StsPageEntity'](_0x5612ac);return _0x38d327[_0x555cba(0x24a)]=_0x34fe47,_0x38d327['name']=decodeURIComponent(_0x251675[_0x555cba(0x1f9)]),_0x38d327['uv']=Number(_0x251675['uv']),_0x38d327['pv']=Number(_0x251675['pv']),_0x38d327[_0x555cba(0x201)]=Number(_0x251675[_0x555cba(0x201)]),_0x38d327[_0x555cba(0x215)]=Number(_0x251675[_0x555cba(0x215)]),_0x38d327[_0x555cba(0x1ea)]=Number(Math['ceil'](_0x251675['avgDuration'])),_0x38d327;});return _0x1ec56c;}async['clearDailyData'](_0xc7672,_0x424f91,_0x3e31dc){const _0x1add88=_0x52ad9e;for(const _0x3708ca of _0x3e31dc){await this[_0x1add88(0x214)][_0x1add88(0x216)](sts_page_entity_1[_0x1add88(0x236)])['createQueryBuilder']('page')[_0x1add88(0x20b)]()[_0x1add88(0x253)](_0x1add88(0x1ff),{'appId':_0xc7672})[_0x1add88(0x20c)](_0x1add88(0x1fd),{'type':_0x3708ca['type']})[_0x1add88(0x20c)](_0x1add88(0x207),{'startTime':_0x3708ca[_0x1add88(0x244)]})[_0x1add88(0x205)]();}}async[_0x52ad9e(0x1e9)](_0x28ee8d){const _0x532836=_0x52ad9e;return await this[_0x532836(0x23c)][_0x532836(0x22a)](_0x532836(0x1ec)+table_constant_1['PAGE_TABLE']+'_'+_0x28ee8d+_0x532836(0x200)+(0x0,time_utils_1[_0x532836(0x1f2)])()+_0x532836(0x203)+(0x0,time_utils_1[_0x532836(0x1f2)])()+_0x532836(0x221));}};PageService=PageService_1=__decorate([(0x0,common_1[_0x52ad9e(0x249)])(),__metadata('design:paramtypes',[clickhouse_service_1[_0x52ad9e(0x20a)],typeorm_1[_0x52ad9e(0x1fe)]])],PageService),exports[_0x52ad9e(0x243)]=PageService;