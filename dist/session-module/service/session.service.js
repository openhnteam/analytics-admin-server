'use strict';const _0x548641=_0x5216;(function(_0x3e2d3b,_0x2ab506){const _0x3f1e14=_0x5216,_0x5661aa=_0x3e2d3b();while(!![]){try{const _0x403c77=-parseInt(_0x3f1e14(0x10c))/0x1+parseInt(_0x3f1e14(0xf7))/0x2+parseInt(_0x3f1e14(0xf4))/0x3+-parseInt(_0x3f1e14(0x133))/0x4*(-parseInt(_0x3f1e14(0x12a))/0x5)+parseInt(_0x3f1e14(0x102))/0x6+parseInt(_0x3f1e14(0x141))/0x7*(parseInt(_0x3f1e14(0xf1))/0x8)+-parseInt(_0x3f1e14(0x125))/0x9*(parseInt(_0x3f1e14(0xeb))/0xa);if(_0x403c77===_0x2ab506)break;else _0x5661aa['push'](_0x5661aa['shift']());}catch(_0x1f93f1){_0x5661aa['push'](_0x5661aa['shift']());}}}(_0x5b4e,0x7e540));function _0x5b4e(){const _0x24688d=['logger','SELECT\x20SUM(duration)\x20AS\x20s\x20FROM\x20','where','level,\x20SUM(pv)\x20as\x20count','SELECT\x20COUNT(1)\x20AS\x20pv,\x20SUM(is_new_user\x20=\x201)\x20AS\x20newPv\x20FROM\x20','count','\x20AND\x20duration\x20<\x207200','../../shared/constants/date.constant','entity','getRepository','../../shared/constants/table.constant','279UjiWAV','insert','clearDailyData','end','session','45LRdmGy','../../shared/utils/obj.utils','startTimeString','DESC','\x27\x20AND\x20type\x20=\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20start_time\x20>=\x20\x27','__decorate','appId\x20=\x20\x27','../../user-module/service/user.service','335132buxIBN','DAY','frequency','../../shared/utils/time.utils','appId','all','durationAvg','length','isEmpty','QUARTER','execute','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20END\x20AS\x20level\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20device_no,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20AS\x20pv\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','userService','../constant/session.constant','574cbGFIC','delete','onAppInit','SESSION_RANHE_LIST','level','../entity/sts.session.frequency.entity','Between','DateUnit','format','SessionService','createSearchTable','map','clickhouse','decorate','DATE_FORMAT','push','findOne','start_time\x20>=\x20\x27','total','\x20AND\x20startTime\x20>=\x20\x27','split','\x27\x20AND\x20duration\x20>=\x20','Logger','ClickhouseService','groupBy','entity.del\x20=\x200','sessionDailyTask','save','getRawOne','SUM(pv)\x20as\x20t','singleQuery','../../shared/service/base.service','list','duration','OPTIMIZE\x20TABLE\x20','\x20PARTITION\x20','object','getTicksBetween','command','createSessionTable','endTimeString','\x20WHERE\x20','defineProperty','MONTH','../entity/sts.session.entity','entity.appId\x20=\x20:appId','../entity/sts.session.duration.entity','SELECT\x20COUNT(1)\x20AS\x20c\x20FROM\x20','\x27\x20and\x20start_time\x20<=\x20\x27','startTime','getOwnPropertyDescriptor','../dto/session.frequency.rsp.dto','SESSION_FREQUENCY_MONTH','BaseService','dateFormat','SESSION_FREQUENCY_DAY','\x27),\x0a\x20\x20\x20\x20\x20\x20INDEX\x20id_index\x20id\x20TYPE\x20minmax\x20GRANULARITY\x208192,\x0a\x20\x20\x20\x20\x20\x20INDEX\x20ip_index\x20ip\x20TYPE\x20minmax\x20GRANULARITY\x208192,\x0a\x20\x20\x20\x20\x20\x20INDEX\x20device_id_index\x20device_id\x20TYPE\x20minmax\x20GRANULARITY\x208192,\x0a\x20\x20\x20\x20\x20\x20INDEX\x20user_id_index\x20user_id\x20TYPE\x20minmax\x20GRANULARITY\x208192\x0a\x20\x20\x20\x20)\x20ENGINE\x20=\x20MergeTree()\x0a\x20\x20\x20\x20partition\x20by\x20toYYYYMMDD(start_time)\x0a\x20\x20\x20\x20ORDER\x20BY\x20(start_time)\x0a\x20\x20\x20\x20SETTINGS\x20index_granularity\x20=\x208192\x20\x20\x20\x20\x20\x20\x0a\x20\x20','SUM(entity.pv)','reduce','UserService','../../user-module/entity/sts.user.entity','sessionFrequencyDailyTask','StsUserEntity','getActiveUserCountInTimeRange','../dto/session.list.rsp.dto','491420zsRakr','entity.level','period','entityManager','\x20AND\x20duration\x20<=\x20','responseSuccess','29152ZMTnpc','DATE_NO_SEPARATOR_FORMAT','forEach','1703316BgozxU','function','\x0a\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20id\x20String\x20COMMENT\x20\x27会话id\x27,\x0a\x20\x20\x20\x20\x20\x20carrier\x20String\x20COMMENT\x20\x27运营商\x27,\x0a\x20\x20\x20\x20\x20\x20mccmnc\x20String\x20COMMENT\x20\x27运营商编码\x27,\x0a\x20\x20\x20\x20\x20\x20is_new_user\x20tinyint(1)\x20COMMENT\x20\x27新用户标识\x27,\x0a\x20\x20\x20\x20\x20\x20app_version\x20String\x20COMMENT\x20\x27应用版本\x27,\x0a\x20\x20\x20\x20\x20\x20os_version\x20String\x20COMMENT\x20\x27系统版本\x27,\x0a\x20\x20\x20\x20\x20\x20ip\x20String\x20COMMENT\x20\x27ip地址\x27,\x0a\x20\x20\x20\x20\x20\x20device_id\x20String\x20COMMENT\x20\x27设备id\x27,\x0a\x20\x20\x20\x20\x20\x20device_no\x20UInt32\x20COMMENT\x20\x27设备编号\x27,\x0a\x20\x20\x20\x20\x20\x20device\x20String\x20COMMENT\x20\x27设备型号\x27,\x0a\x20\x20\x20\x20\x20\x20device_type\x20String\x20COMMENT\x20\x27设备类型\x27,\x0a\x20\x20\x20\x20\x20\x20density\x20String\x20COMMENT\x20\x27设备密度\x27,\x0a\x20\x20\x20\x20\x20\x20locale\x20String\x20COMMENT\x20\x27语言\x27,\x0a\x20\x20\x20\x20\x20\x20resolution\x20String\x20COMMENT\x20\x27分辨率\x27,\x0a\x20\x20\x20\x20\x20\x20os\x20String\x20COMMENT\x20\x27系统\x27,\x0a\x20\x20\x20\x20\x20\x20scene\x20String\x20COMMENT\x20\x27启动场景\x27,\x0a\x20\x20\x20\x20\x20\x20platform_version\x20String\x20COMMENT\x20\x27平台版本\x27,\x0a\x20\x20\x20\x20\x20\x20install_channel\x20String\x20COMMENT\x20\x27安装渠道\x27,\x0a\x20\x20\x20\x20\x20\x20user_id\x20String\x20COMMENT\x20\x27用户id\x27,\x0a\x20\x20\x20\x20\x20\x20start_time\x20DateTime(\x27','958204DxDHEX','startDailyStatistics','StsSessionDurationEntity','start','appTimeZone','typeorm','SessionListRspDto','../../shared/service/clickhouse/clickhouse.service','select','fetchStsSessionEntityList','into','3323058qqvadn','StsSessionFrequencyEntity','getRawMany','\x27\x20AND\x20start_time\x20<=\x20\x27','newPv','../../shared/utils/cal.utils','sessionDurationDailyTask','getStartAndEndTime','name','fetchStsSessionEntityLimit','612730OUBSDE','SEARCH_TABLE','EntityManager','type','__metadata','StsSessionEntity','SESSION_TABLE','andWhere','createQueryBuilder','sort','find','SELECT\x20level,\x20COUNT(*)\x20AS\x20pv\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20device_no,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20CASE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','metadata','delStsSession'];_0x5b4e=function(){return _0x24688d;};return _0x5b4e();}var __decorate=this&&this[_0x548641(0x130)]||function(_0x464e00,_0x3f4ec8,_0x16fb26,_0x5983f1){const _0x18181b=_0x548641;var _0x5d0cba=arguments['length'],_0x463ee0=_0x5d0cba<0x3?_0x3f4ec8:_0x5983f1===null?_0x5983f1=Object[_0x18181b(0xdc)](_0x3f4ec8,_0x16fb26):_0x5983f1,_0x4a4d4d;if(typeof Reflect===_0x18181b(0x165)&&typeof Reflect[_0x18181b(0x14e)]==='function')_0x463ee0=Reflect[_0x18181b(0x14e)](_0x464e00,_0x3f4ec8,_0x16fb26,_0x5983f1);else{for(var _0x169c9c=_0x464e00['length']-0x1;_0x169c9c>=0x0;_0x169c9c--)if(_0x4a4d4d=_0x464e00[_0x169c9c])_0x463ee0=(_0x5d0cba<0x3?_0x4a4d4d(_0x463ee0):_0x5d0cba>0x3?_0x4a4d4d(_0x3f4ec8,_0x16fb26,_0x463ee0):_0x4a4d4d(_0x3f4ec8,_0x16fb26))||_0x463ee0;}return _0x5d0cba>0x3&&_0x463ee0&&Object[_0x18181b(0x16b)](_0x3f4ec8,_0x16fb26,_0x463ee0),_0x463ee0;},__metadata=this&&this[_0x548641(0x110)]||function(_0x43ced9,_0x4a62a7){const _0x465479=_0x548641;if(typeof Reflect===_0x465479(0x165)&&typeof Reflect[_0x465479(0x118)]===_0x465479(0xf5))return Reflect[_0x465479(0x118)](_0x43ced9,_0x4a62a7);},SessionService_1;Object[_0x548641(0x16b)](exports,'__esModule',{'value':!![]}),exports[_0x548641(0x14a)]=void 0x0;const table_constant_1=require(_0x548641(0x124)),base_service_1=require(_0x548641(0x160)),clickhouse_service_1=require(_0x548641(0xfe)),time_utils_1=require(_0x548641(0x136)),common_1=require('@nestjs/common'),typeorm_1=require(_0x548641(0xfc)),sts_session_entity_1=require(_0x548641(0x16d)),sts_session_duration_entity_1=require(_0x548641(0xd8)),sts_session_frequency_entity_1=require(_0x548641(0x146)),date_constant_1=require(_0x548641(0x121)),obj_utils_1=require(_0x548641(0x12b)),session_constant_1=require(_0x548641(0x140)),cal_utils_1=require(_0x548641(0x107)),session_frequency_rsp_dto_1=require(_0x548641(0xdd)),sts_user_entity_1=require(_0x548641(0xe6)),session_list_rsp_dto_1=require(_0x548641(0xea)),user_service_1=require(_0x548641(0x132));let SessionService=SessionService_1=class SessionService extends base_service_1[_0x548641(0xdf)]{constructor(_0x388209,_0x358e79,_0x3065ba){const _0x215828=_0x548641;super(),this[_0x215828(0x14d)]=_0x388209,this[_0x215828(0xee)]=_0x358e79,this[_0x215828(0x13f)]=_0x3065ba,this[_0x215828(0x11a)]=new common_1[(_0x215828(0x157))](SessionService_1[_0x215828(0x10a)]);}async[_0x548641(0x162)](_0x4197d9){const _0x1cf097=_0x548641,{stsStartTime:_0x192722,stsEndTime:_0x2d3603}=(0x0,time_utils_1[_0x1cf097(0x109)])(_0x4197d9[_0x1cf097(0xed)]),_0x469956={'appId':_0x4197d9['appId'],'type':date_constant_1[_0x1cf097(0x148)][_0x1cf097(0x134)],'startTime':(0x0,typeorm_1[_0x1cf097(0x147)])(new Date(_0x192722),new Date(_0x2d3603)),'del':0x0},_0x5dd1ce=await this[_0x1cf097(0xee)][_0x1cf097(0x114)](sts_session_duration_entity_1['StsSessionDurationEntity'],_0x1cf097(0x129))[_0x1cf097(0xff)](_0x1cf097(0x15e))[_0x1cf097(0x11c)](_0x469956)[_0x1cf097(0x15d)](),_0x4116ad=Number(_0x5dd1ce['t']),_0x53c139=await this[_0x1cf097(0xee)][_0x1cf097(0x114)](sts_session_duration_entity_1[_0x1cf097(0xf9)],_0x1cf097(0x129))[_0x1cf097(0xff)](_0x1cf097(0x11d))[_0x1cf097(0x11c)](_0x469956)['groupBy'](_0x1cf097(0x145))[_0x1cf097(0x104)](),_0x17f264=[];return _0x53c139[_0x1cf097(0x13a)]>=0x0&&_0x53c139[_0x1cf097(0xf3)](_0x1ae8ab=>{const _0x3e6980=_0x1cf097,_0x21b9d1=session_constant_1[_0x3e6980(0x144)][_0x1ae8ab[_0x3e6980(0x145)]],_0x14ff62=Number(_0x1ae8ab[_0x3e6980(0x11f)]),_0x1b3170=(0x0,cal_utils_1['calPercentFormat'])(_0x14ff62,_0x4116ad);_0x17f264[_0x3e6980(0x150)]({'id':_0x21b9d1['id'],'count':_0x14ff62,'percent':_0x1b3170});}),this['responseSuccess'](_0x17f264);}async[_0x548641(0x161)](_0x13896e){const _0x61fda2=_0x548641,{startTime:_0x27dc1d,endTime:_0x1a81dd,stsStartTime:_0xec682,stsEndTime:_0x249236}=(0x0,time_utils_1[_0x61fda2(0x109)])(_0x13896e[_0x61fda2(0xed)]),_0x3093de={'where':{'appId':_0x13896e[_0x61fda2(0x137)],'type':date_constant_1[_0x61fda2(0x148)][_0x61fda2(0x134)],'startTime':(0x0,typeorm_1[_0x61fda2(0x147)])(new Date(_0xec682),new Date(_0x249236)),'del':0x0}},_0x3199e0=await this[_0x61fda2(0xee)][_0x61fda2(0x116)](sts_session_entity_1[_0x61fda2(0x111)],_0x3093de),_0x496d35=await this[_0x61fda2(0xee)]['find'](sts_user_entity_1[_0x61fda2(0xe8)],_0x3093de);if((0x0,obj_utils_1[_0x61fda2(0x13b)])(_0x3199e0)||(0x0,obj_utils_1['isEmpty'])(_0x496d35))return this[_0x61fda2(0xf0)]({});const _0x425e5b=_0x3199e0[_0x61fda2(0xe4)]((_0x14162c,_0x131c68)=>{const _0x11f0c5=_0x61fda2,_0x1014cd=(0x0,time_utils_1['dateFormat'])(_0x131c68[_0x11f0c5(0xdb)],date_constant_1[_0x11f0c5(0x14f)]);return _0x14162c[_0x1014cd]=_0x131c68,_0x14162c;},{}),_0x2b3350=_0x496d35['reduce']((_0x1d985a,_0x2ce421)=>{const _0x5e5f77=_0x61fda2,_0x2892a5=(0x0,time_utils_1[_0x5e5f77(0xe0)])(_0x2ce421[_0x5e5f77(0xdb)],date_constant_1[_0x5e5f77(0x14f)]);return _0x1d985a[_0x2892a5]=_0x2ce421,_0x1d985a;},{}),_0x2c11f4=(0x0,time_utils_1[_0x61fda2(0x166)])(_0x13896e[_0x61fda2(0xed)]),_0x2dd2b8=_0x2c11f4[_0x61fda2(0x14c)](_0x369651=>{const _0x1c3373=_0x61fda2,_0x31dda0=_0x425e5b[_0x369651],_0x109a04=_0x2b3350[_0x369651];return{'id':_0x369651,'pv':!_0x31dda0?0x0:_0x31dda0['pv'],'newPv':!_0x31dda0?0x0:_0x31dda0[_0x1c3373(0x106)],'uv':!_0x109a04?0x0:_0x109a04['uv'],'duration':!_0x31dda0?0x0:_0x31dda0[_0x1c3373(0x162)]};}),_0x259375=_0x3199e0[_0x61fda2(0xe4)]((_0x66533d,_0x2d8e3d)=>_0x66533d+_0x2d8e3d['pv'],0x0),_0x2699c8=_0x3199e0['reduce']((_0x4202f7,_0xe77ebd)=>_0x4202f7+_0xe77ebd[_0x61fda2(0x106)],0x0),_0x57aba7=_0x3199e0[_0x61fda2(0xe4)]((_0x47b8d0,_0x5036ce)=>_0x47b8d0+_0x5036ce[_0x61fda2(0x162)],0x0),_0x32590f=await this[_0x61fda2(0x13f)][_0x61fda2(0xe9)](_0x13896e[_0x61fda2(0x137)],_0x27dc1d,_0x1a81dd),_0x8a5a9a=new session_list_rsp_dto_1[(_0x61fda2(0xfd))]();return _0x8a5a9a[_0x61fda2(0x161)]=_0x2dd2b8,_0x8a5a9a['pv']=_0x259375,_0x8a5a9a[_0x61fda2(0x106)]=_0x2699c8,_0x8a5a9a['uv']=_0x32590f,_0x8a5a9a[_0x61fda2(0x162)]=_0x57aba7,this[_0x61fda2(0xf0)](_0x8a5a9a);}async[_0x548641(0x135)](_0x4859d5){const _0x4e04c1=_0x548641,{startTime:_0x13af0e,endTime:_0xe8e63e,stsStartTime:_0x1d5697,stsEndTime:_0x473dc3}=(0x0,time_utils_1[_0x4e04c1(0x109)])(_0x4859d5[_0x4e04c1(0xed)],_0x4859d5[_0x4e04c1(0x10f)]),_0x352340=await this[_0x4e04c1(0xee)]['createQueryBuilder'](sts_session_frequency_entity_1['StsSessionFrequencyEntity'],_0x4e04c1(0x122))[_0x4e04c1(0xff)](_0x4e04c1(0xec),'id')['addSelect'](_0x4e04c1(0xe3),_0x4e04c1(0x11f))[_0x4e04c1(0x11c)](_0x4e04c1(0x16e),{'appId':_0x4859d5[_0x4e04c1(0x137)]})[_0x4e04c1(0x113)]('entity.type\x20=\x20:type',{'type':_0x4859d5[_0x4e04c1(0x10f)]})[_0x4e04c1(0x113)]('entity.startTime\x20BETWEEN\x20:stsStartTime\x20AND\x20:stsEndTime',{'stsStartTime':_0x1d5697,'stsEndTime':_0x473dc3})[_0x4e04c1(0x113)](_0x4e04c1(0x15a))[_0x4e04c1(0x159)](_0x4e04c1(0xec))['getRawMany']();if((0x0,obj_utils_1['isEmpty'])(_0x352340))return this[_0x4e04c1(0xf0)]({});const _0x304277=_0x352340[_0x4e04c1(0x14c)](_0x47ac43=>({'id':_0x47ac43['id']['toString'](),'count':Number(_0x47ac43[_0x4e04c1(0x11f)])}));_0x304277[_0x4e04c1(0x115)]((_0x1a7c27,_0x229d6f)=>{const _0x2ad57d=_0x4e04c1,_0x54814c=parseInt(_0x1a7c27['id']['split']('-')[0x0]),_0x3aaab8=parseInt(_0x229d6f['id'][_0x2ad57d(0x155)]('-')[0x0]);if(_0x54814c<_0x3aaab8)return-0x1;if(_0x54814c>_0x3aaab8)return 0x1;return 0x0;});const _0x2c7a2e=new session_frequency_rsp_dto_1['SessionFrequencyRspDto']();return _0x2c7a2e['list']=_0x304277,_0x2c7a2e['start']=(0x0,time_utils_1[_0x4e04c1(0xe0)])(_0x13af0e,date_constant_1['DATE_FORMAT']),_0x2c7a2e[_0x4e04c1(0x128)]=(0x0,time_utils_1[_0x4e04c1(0xe0)])(_0xe8e63e,date_constant_1[_0x4e04c1(0x14f)]),this[_0x4e04c1(0xf0)](_0x2c7a2e);}async[_0x548641(0x100)](_0x225acb,_0x44a808,_0xa5e749){const _0x4da537=_0x548641,_0x53efaa=await this['entityManager'][_0x4da537(0x116)](sts_session_entity_1[_0x4da537(0x111)],{'where':{'appId':_0x225acb,'type':date_constant_1[_0x4da537(0x148)]['DAY'],'startTime':(0x0,typeorm_1['Between'])(new Date(_0x44a808),new Date(_0xa5e749)),'del':0x0},'order':{'startTime':_0x4da537(0x12d)}});return _0x53efaa;}async[_0x548641(0x10b)](_0x565ea2,_0x12875b){const _0x4a77a4=_0x548641,_0x4e0775=await this[_0x4a77a4(0xee)]['find'](sts_session_entity_1[_0x4a77a4(0x111)],{'where':{'appId':_0x565ea2,'type':date_constant_1[_0x4a77a4(0x148)][_0x4a77a4(0x134)],'del':0x0},'order':{'startTime':_0x4a77a4(0x12d)},'skip':0x0,'take':_0x12875b});return _0x4e0775;}async[_0x548641(0xf8)](_0xfb7ebd,_0x4d692e,_0x4c8d9c){const _0x51895f=_0x548641,_0x59549a=table_constant_1[_0x51895f(0x112)]+'_'+_0xfb7ebd,_0x4801ec=_0x4d692e[_0x51895f(0x149)](date_constant_1[_0x51895f(0xf2)]);await this[_0x51895f(0x14d)][_0x51895f(0x167)](_0x51895f(0x163)+_0x59549a+_0x51895f(0x164)+_0x4801ec+'\x20FINAL'),await this[_0x51895f(0x15b)](_0xfb7ebd,_0x59549a,_0x4c8d9c),await this[_0x51895f(0x108)](_0xfb7ebd,_0x59549a,_0x4c8d9c),await this['sessionFrequencyDailyTask'](_0xfb7ebd,_0x59549a,_0x4c8d9c);}async[_0x548641(0x15b)](_0x472e03,_0x1094a8,_0x377d6a){const _0x32cb92=_0x548641;for(const _0x5afafa of _0x377d6a){const _0x161a1c='start_time\x20>=\x20\x27'+_0x5afafa[_0x32cb92(0x12c)]+'\x27\x20AND\x20start_time\x20<=\x20\x27'+_0x5afafa['endTimeString']+'\x27',_0x22edc8=await this[_0x32cb92(0x14d)]['singleQuery'](_0x32cb92(0x11e)+_0x1094a8+'\x20WHERE\x20'+_0x161a1c),_0x90da01=_0x22edc8['pv']||0x0,_0x46bcf5=_0x22edc8[_0x32cb92(0x106)]||0x0,_0x21b862=await this['clickhouse']['singleQuery'](_0x32cb92(0x11b)+_0x1094a8+'\x20WHERE\x20'+_0x161a1c+_0x32cb92(0x120)),_0x28e217=_0x21b862['s']||0x0;let _0x46cc09=0x0;Number(_0x90da01)>0x0&&(_0x46cc09=Math['ceil'](Number(_0x28e217)/Number(_0x90da01)));let _0x364125=_0x28e217;const _0x2f8ade=await this[_0x32cb92(0xee)][_0x32cb92(0x151)](sts_session_entity_1[_0x32cb92(0x111)],{'select':[_0x32cb92(0x153)],'where':{'appId':_0x472e03,'type':_0x5afafa[_0x32cb92(0x10f)],'del':0x0},'order':{'startTime':_0x32cb92(0x12d)}});!(0x0,obj_utils_1[_0x32cb92(0x13b)])(_0x2f8ade)&&(_0x364125=Number(_0x2f8ade[_0x32cb92(0x153)])+Number(_0x364125));const _0x38bb81=new sts_session_entity_1[(_0x32cb92(0x111))](_0x5afafa);_0x38bb81[_0x32cb92(0x137)]=_0x472e03,_0x38bb81['pv']=Number(_0x90da01),_0x38bb81[_0x32cb92(0x106)]=Number(_0x46bcf5),_0x38bb81[_0x32cb92(0x162)]=Number(_0x28e217),_0x38bb81[_0x32cb92(0x139)]=Number(_0x46cc09),_0x38bb81[_0x32cb92(0x153)]=Number(_0x364125),await _0x38bb81[_0x32cb92(0x15c)]();}}async[_0x548641(0x108)](_0x4ed1a3,_0x2f7846,_0x3bdaaf){const _0x263586=_0x548641;for(const _0xdcdf0d of _0x3bdaaf){for(const _0x3c6c22 in session_constant_1[_0x263586(0x144)]){const _0x6d1ea0=session_constant_1[_0x263586(0x144)][_0x3c6c22],_0x49febf=_0x263586(0x152)+_0xdcdf0d['startTimeString']+_0x263586(0x105)+_0xdcdf0d[_0x263586(0x169)]+_0x263586(0x156)+_0x6d1ea0[_0x263586(0xfa)]+_0x263586(0xef)+_0x6d1ea0[_0x263586(0x128)],_0x17a68f=await this['clickhouse'][_0x263586(0x15f)](_0x263586(0xd9)+_0x2f7846+_0x263586(0x16a)+_0x49febf),_0x5f19a8=_0x17a68f['c']||0x0,_0x2ea5f1=new sts_session_duration_entity_1['StsSessionDurationEntity'](_0xdcdf0d);_0x2ea5f1['appId']=_0x4ed1a3,_0x2ea5f1['level']=_0x3c6c22,_0x2ea5f1['pv']=Number(_0x5f19a8),await _0x2ea5f1['save']();}}}async[_0x548641(0xe7)](_0xd94c90,_0x2cf100,_0x590ad4){const _0x50cd94=_0x548641;for(const _0x6c513 of _0x590ad4){let _0x277689=session_constant_1[_0x50cd94(0xe1)];switch(_0x6c513[_0x50cd94(0x10f)]){case date_constant_1[_0x50cd94(0x148)]['WEEK']:_0x277689=session_constant_1['SESSION_FREQUENCY_WEEK'];break;case date_constant_1[_0x50cd94(0x148)][_0x50cd94(0x16c)]:_0x277689=session_constant_1[_0x50cd94(0xde)];break;case date_constant_1['DateUnit'][_0x50cd94(0x13c)]:_0x277689=session_constant_1['SESSION_FREQUENCY_QUARTER'];break;default:break;}const _0x5e4a2e=_0x50cd94(0x117)+_0x277689+_0x50cd94(0x13e)+_0x2cf100+_0x50cd94(0x12f)+_0x6c513[_0x50cd94(0x12c)]+_0x50cd94(0xda)+_0x6c513[_0x50cd94(0x169)]+'\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20device_no\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x20subquery\x0a\x20\x20\x20\x20\x20\x20)\x20final_query\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20level\x0a\x20\x20\x20\x20\x20\x20',_0x1f7f68=await this['clickhouse']['query'](_0x5e4a2e);if((0x0,obj_utils_1[_0x50cd94(0x13b)])(_0x1f7f68))continue;const _0x57c82=[];_0x1f7f68[_0x50cd94(0xf3)](_0x431f99=>{const _0x2ec751=_0x50cd94,_0x515d94=new sts_session_frequency_entity_1[(_0x2ec751(0x103))](_0x6c513);_0x515d94[_0x2ec751(0x137)]=_0xd94c90,_0x515d94[_0x2ec751(0x145)]=_0x431f99[_0x2ec751(0x145)],_0x515d94['pv']=_0x431f99['pv'],_0x57c82[_0x2ec751(0x150)](_0x515d94);}),await this[_0x50cd94(0xee)][_0x50cd94(0x114)]()[_0x50cd94(0x126)]()[_0x50cd94(0x101)](sts_session_frequency_entity_1[_0x50cd94(0x103)])['values'](_0x57c82)['execute']();}}async[_0x548641(0x127)](_0x2a750e,_0x1b050a,_0x135080){const _0x464cc7=_0x548641,_0x2fe24a=_0x135080[_0x464cc7(0x14c)](_0x2aacd0=>this[_0x464cc7(0x119)](_0x2a750e,_0x2aacd0));await Promise[_0x464cc7(0x138)](_0x2fe24a);}async[_0x548641(0x119)](_0x49ddf3,_0x5e54da){const _0x383029=_0x548641;try{const _0x7bf9ad=_0x383029(0x131)+_0x49ddf3+_0x383029(0x12e)+_0x5e54da['type']+_0x383029(0x154)+_0x5e54da[_0x383029(0x12c)]+'\x27';await this[_0x383029(0xee)][_0x383029(0x123)](sts_session_entity_1[_0x383029(0x111)])['createQueryBuilder']('session')[_0x383029(0x142)]()[_0x383029(0x11c)](_0x7bf9ad)[_0x383029(0x13d)](),await this[_0x383029(0xee)][_0x383029(0x123)](sts_session_duration_entity_1[_0x383029(0xf9)])[_0x383029(0x114)]('duration')[_0x383029(0x142)]()['where'](_0x7bf9ad)[_0x383029(0x13d)](),await this[_0x383029(0xee)][_0x383029(0x123)](sts_session_frequency_entity_1[_0x383029(0x103)])['createQueryBuilder'](_0x383029(0x135))[_0x383029(0x142)]()[_0x383029(0x11c)](_0x7bf9ad)['execute']();}catch(_0x343187){return![];}return!![];}async[_0x548641(0x143)](_0x4eecf5){const _0x2fd2d7=_0x548641,_0x241f89=await this[_0x2fd2d7(0x14b)](_0x4eecf5),_0x454597=await this[_0x2fd2d7(0x168)](_0x4eecf5);return _0x241f89||_0x454597;}async[_0x548641(0x168)](_0x1a5aef){const _0x53397f=_0x548641;return await this['clickhouse'][_0x53397f(0x167)]('\x0a\x20\x20\x20\x20CREATE\x20TABLE\x20'+table_constant_1['SESSION_TABLE']+'_'+_0x1a5aef+_0x53397f(0xf6)+(0x0,time_utils_1[_0x53397f(0xfb)])()+'\x27)\x20COMMENT\x20\x27启动时间\x27,\x0a\x20\x20\x20\x20\x20\x20duration\x20int\x20COMMENT\x20\x27使用时长\x27\x0a\x20\x20\x20\x20)\x20ENGINE\x20=\x20SummingMergeTree(duration)\x0a\x20\x20\x20\x20partition\x20by\x20toYYYYMMDD(start_time)\x0a\x20\x20\x20\x20primary\x20key\x20(id)\x0a\x20\x20\x20\x20ORDER\x20BY\x20(id)\x0a\x20\x20');}async[_0x548641(0x14b)](_0x228d7d){const _0x50c1f8=_0x548641;return await this[_0x50c1f8(0x14d)]['command']('\x0a\x20\x20\x20\x20CREATE\x20TABLE\x20'+table_constant_1[_0x50c1f8(0x10d)]+'_'+_0x228d7d+_0x50c1f8(0xf6)+(0x0,time_utils_1[_0x50c1f8(0xfb)])()+_0x50c1f8(0xe2));}};function _0x5216(_0x1c9140,_0x1693e3){const _0x5b4e23=_0x5b4e();return _0x5216=function(_0x521605,_0x636993){_0x521605=_0x521605-0xd8;let _0x1bd985=_0x5b4e23[_0x521605];return _0x1bd985;},_0x5216(_0x1c9140,_0x1693e3);}SessionService=SessionService_1=__decorate([(0x0,common_1['Injectable'])(),__metadata('design:paramtypes',[clickhouse_service_1[_0x548641(0x158)],typeorm_1[_0x548641(0x10e)],user_service_1[_0x548641(0xe5)]])],SessionService),exports[_0x548641(0x14a)]=SessionService;